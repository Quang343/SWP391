<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start -->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end -->

<!-- page-wrapper start -->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body start -->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
        <!-- Page Sidebar Ends-->

        <div class="page-body">
            <!-- New Product Add Start -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="row">
                            <div class="col-sm-8 m-auto">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="card-header-2">
                                            <h5>Thêm Thông Tin Nhà Cung Cấp</h5>
                                        </div>

                                        <div class="theme-form theme-form-2 mega-form">
                                            <!-- Tên Nhà Cung Cấp -->
                                            <div class="mb-4 row align-items-center">
                                                <label class="form-label-title col-sm-3 mb-0">Tên Nhà Cung Cấp</label>
                                                <div class="col-sm-9">
                                                    <input id="supplierName" class="form-control" type="text" placeholder="Nhập tên nhà cung cấp">
                                                </div>
                                            </div>

                                            <!-- Thông Tin Liên Hệ -->
                                            <div class="mb-4 row align-items-center">
                                                <label class="form-label-title col-sm-3 mb-0">Thông Tin Liên Hệ</label>
                                                <div class="col-sm-9">
                                                    <input id="contactInfo" class="form-control" type="text" placeholder="Nhập thông tin liên hệ">
                                                </div>
                                            </div>

                                            <!-- Logo Nhà Cung Cấp -->
                                            <div class="mb-4 row align-items-center">
                                                <label class="col-sm-3 col-form-label form-label-title">Logo Nhà Cung Cấp</label>
                                                <div class="form-group col-sm-9">
                                                    <form class="dropzone custom-dropzone" id="logoUpload">
                                                        <div class="dropzone-wrapper">
                                                            <div class="dz-message needsclick">
                                                                <div class="dz-message-content">
                                                                    <i class="icon-cloud-up"></i>
                                                                    <h6>Kéo thả file hoặc nhấn để tải lên logo</h6>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-submit-button">
                                        <button id="submitButton" class="btn btn-animation ms-auto" type="button">Thêm Mới</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- New Product Add End -->

            <!-- footer Start -->
            <div th:replace="BackEnd/fragments/WareHouse/footer::footer"></div>
            <!-- footer End -->
        </div>
        <!-- Container-fluid End -->
    </div>
    <!-- Page Body End -->
</div>
<!-- page-wrapper End -->

<!-- Modal Đăng Xuất -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Đăng Xuất</h5>
                <p>Bạn có chắc chắn muốn đăng xuất?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
                    <button type="button" th:onclick="|window.location='@{/backend/login}'|" class="btn btn--yes btn-primary">Có</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM đã tải xong, khởi tạo script...');

        const submitButton = document.getElementById('submitButton');
        const logoUpload = document.getElementById('logoUpload');
        const supplierNameInput = document.getElementById('supplierName');
        const contactInfoInput = document.getElementById('contactInfo');

        if (!submitButton || !logoUpload || !supplierNameInput || !contactInfoInput) {
            console.error('Thiếu các phần tử DOM:', {
                submitButton: !!submitButton,
                logoUpload: !!logoUpload,
                supplierName: !!supplierNameInput,
                contactInfo: !!contactInfoInput
            });
            alert('Lỗi giao diện, vui lòng kiểm tra console.');
            return;
        }

        // Khởi tạo Dropzone
        let dropzone;
        try {
            Dropzone.autoDiscover = false;
            dropzone = new Dropzone("#logoUpload", {
                url: "/api/suppliers/createSupplier",
                autoProcessQueue: false,
                maxFiles: 1,
                acceptedFiles: "image/*",
                addRemoveLinks: false, // Disable default addRemoveLinks to avoid duplicate links
                dictDefaultMessage: "Kéo thả file hoặc nhấn để tải lên logo",
                dictRemoveFile: "Xóa file",
                dictInvalidFileType: "Chỉ chấp nhận file hình ảnh (jpg, png, ...)",
                dictMaxFilesExceeded: "Chỉ được tải lên 1 file",
                previewTemplate: `
                    <div class="dz-preview dz-file-preview">
                        <div class="dz-content">
                            <div class="dz-image">
                                <img data-dz-thumbnail />
                            </div>
                            <div class="dz-details-container">
                                <div class="dz-filename"><span data-dz-name></span></div>
                                <div class="dz-size" data-dz-size></div>
                                <a class="dz-remove" href="javascript:void(0);" data-dz-remove>Xóa file</a>
                            </div>
                        </div>
                    </div>
                `,
                init: function () {
                    this.on("addedfile", function (file) {
                        console.log('File được thêm:', file.name);
                        if (this.files.length > 1) {
                            this.removeFile(this.files[0]);
                        }
                        // Hide the default message when a file is added
                        const dzMessage = document.querySelector('.dz-message');
                        if (dzMessage) dzMessage.style.display = 'none';
                    });
                    this.on("maxfilesexceeded", function (file) {
                        this.removeAllFiles();
                        this.addFile(file);
                        alert("Chỉ được tải lên 1 file.");
                    });
                    this.on("thumbnail", function (file, dataUrl) {
                        console.log('Thumbnail generated for:', file.name);
                        if (file.previewElement) {
                            let img = file.previewElement.querySelector("img[data-dz-thumbnail]");
                            if (img) {
                                img.src = dataUrl; // Set the image source
                            }
                        }
                    });
                    this.on("removedfile", function (file) {
                        console.log('File removed:', file.name);
                        const dzMessage = document.querySelector('.dz-message');
                        if (dzMessage && this.files.length === 0) dzMessage.style.display = 'block';
                    });
                    this.on("error", function (file, errorMessage) {
                        console.error('Lỗi Dropzone - File:', file.name, 'Error:', errorMessage);
                        let displayMessage = 'Lỗi khi xử lý file';
                        if (errorMessage && typeof errorMessage === 'object' && errorMessage.message) {
                            displayMessage += ': ' + errorMessage.message;
                        } else if (errorMessage && typeof errorMessage === 'string') {
                            displayMessage += ': ' + errorMessage;
                        } else {
                            displayMessage += ': Đã xảy ra lỗi không xác định.';
                        }
                        alert(displayMessage);
                    });
                    this.on("success", function (file, response) {
                        console.log('Upload thành công:', response);
                    });
                }
            });
            console.log('Dropzone khởi tạo thành công.');
        } catch (error) {
            console.error('Lỗi khi khởi tạo Dropzone:', error);
            alert('Không thể khởi tạo Dropzone. Vui lòng kiểm tra console.');
            return;
        }

        submitButton.addEventListener('click', function () {
            console.log('Nút Thêm Mới được nhấn.');

            const supplierName = supplierNameInput.value.trim().replace(/\s+/g, ' ');
            const contactInfo = contactInfoInput.value.trim();
            const logoFile = dropzone.files[0];

            // Client-side validation
            if (!supplierName) {
                alert('Vui lòng nhập Tên Nhà Cung Cấp.');
                console.warn('Thiếu Tên Nhà Cung Cấp.');
                return;
            }
            if (!supplierName.match(/^[a-zA-Z\s\u00C0-\u00FF\u1EA0-\u1EFF]+$/)) {
                alert('Tên Nhà Cung Cấp chỉ chứa chữ cái (tiếng Việt) và khoảng trắng.');
                console.warn('Định dạng Tên Nhà Cung Cấp không hợp lệ.');
                return;
            }
            if (!contactInfo) {
                alert('Vui lòng nhập Thông Tin Liên Hệ.');
                console.warn('Thiếu Thông Tin Liên Hệ.');
                return;
            }
            if (!logoFile) {
                alert('Vui lòng tải lên logo.');
                console.warn('Thiếu logo.');
                return;
            }

            const formData = new FormData();
            formData.append('supplierName', supplierName);
            formData.append('contactInfo', contactInfo);
            formData.append('logo', logoFile);

            console.log('Gửi FormData tới /api/suppliers/createSupplier', {
                supplierName,
                contactInfo,
                logoFile: logoFile.name
            });

            fetch('/api/suppliers/createSupplier', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    console.log('Phản hồi từ server:', response.status);
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw { status: response.status, error: err.error || 'Lỗi không xác định.' };
                        });
                    }
                    return response.json();
                })
                .then(createdSupplier => {
                    console.log('Nhà Cung Cấp được tạo:', createdSupplier);
                    alert('Tạo Nhà Cung Cấp thành công!');

                    supplierNameInput.value = '';
                    contactInfoInput.value = '';
                    dropzone.removeAllFiles();

                    if (createdSupplier.logo) {
                        console.log('Logo URL:', `/BackEnd/assets/imgproject/${createdSupplier.logo}?t=${Date.now()}`);
                    }

                    // Redirect sau 1.5s
                    setTimeout(() => {
                        window.location.href = '/warehouse/supplier';
                    }, 1500);
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    if (error.status === 409) {
                        alert(error.error || 'Tên Nhà Cung Cấp hoặc Thông Tin Liên Hệ đã tồn tại.');
                    } else if (error.status === 400) {
                        alert(error.error || 'Dữ liệu không hợp lệ, vui lòng kiểm tra lại.');
                    } else {
                        alert('Đã xảy ra lỗi khi tạo Nhà Cung Cấp: ' + error.error);
                    }
                    dropzone.removeAllFiles();
                });
        });
    });
</script>

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>

<!-- Bootstrap js -->
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>

<!-- feather icon js -->
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>

<!-- scrollbar simplebar js -->
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>

<!-- Sidebar js -->
<script th:src="@{/Backend/assets/js/config.js}"></script>

<!-- customizer js -->
<script th:src="@{/Backend/assets/js/customizer.js}"></script>

<!-- Plugins js -->
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>

<!-- Data table js -->
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>

<!-- Dropzone js -->
<script th:src="@{/Backend/assets/js/dropzone/dropzone.js}"></script>
<script th:src="@{/Backend/assets/js/dropzone/dropzone-script.js}"></script>

<!-- select2 js -->
<script th:src="@{/Backend/assets/js/select2.min.js}"></script>
<script th:src="@{/Backend/assets/js/select2-custom.js}"></script>

<!-- Theme js -->
<script th:src="@{/Backend/assets/js/script.js}"></script>

<style>
    .dropzone {
        border: 2px dashed #007bff;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        min-height: 150px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dropzone .dz-preview {
        margin: 0;
        text-align: center;
        width: 100%;
    }

    .dropzone .dz-content {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding: 10px;
        width: 100%;
    }

    .dropzone .dz-image {
        width: 140px;
        height: 140px;
        border: 2px solid #ccc;
        border-radius: 10px;
        overflow: hidden;
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dropzone .dz-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .dropzone .dz-details-container {
        flex: 1;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .dropzone .dz-filename,
    .dropzone .dz-size {
        font-size: 13px;
        color: #333;
    }

    .dropzone .dz-remove {
        font-size: 14px;
        font-weight: bold;
        color: #dc3545;
        cursor: pointer;
        text-decoration: none;
        margin-top: 5px;
    }

    .dropzone .dz-success-mark,
    .dropzone .dz-error-mark {
        display: none;
    }

    .dropzone .dz-error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }

    .dropzone .dz-message {
        text-align: center;
        width: 100%;
        display: block; /* Default state when no file */
    }

    .dropzone .dz-message .dz-message-content {
        margin: 0 auto;
    }

    .dropzone .dz-message h6 {
        margin-top: 10px;
        font-size: 14px;
        color: #555;
    }

    /* Ensure message is hidden when preview exists */
    .dropzone .dz-preview .dz-message {
        display: none;
    }
</style>
</body>
</html>