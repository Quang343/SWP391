<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start -->
<div class="tap-top">
  <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end -->

<!-- page-wrapper start -->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
  <!-- Page Header Start-->
  <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
  <!-- Page Header Ends-->

  <!-- Page Body start -->
  <div class="page-body-wrapper">
    <!-- Page Sidebar Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
    <!-- Page Sidebar Ends-->

    <div class="page-body">
      <!-- Pending StockOuts for Return Table -->
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-12">
            <div class="card">
              <div class="card-body">
                <div class="card-header-2">
                  <h5>Danh sách Đơn hàng Chờ Nhập lại kho</h5>
                </div>
                <div class="table-responsive">
                  <table class="table table-borderless balanced-table">
                    <thead>
                    <tr>
                      <th class="text-center">STT</th>
                      <th class="text-center">Đơn hàng</th>
                      <th class="text-center">Trạng thái</th>
                      <th class="text-center">Thông tin</th>
                      <th class="text-center">Hành động</th>
                    </tr>
                    </thead>
                    <tbody id="orderTableBody">
                    <tr>
                      <td colspan="5" class="text-center">Đang tải dữ liệu...</td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Pending StockOuts for Return End -->

      <!-- footer Start -->
      <div th:replace="BackEnd/fragments/WareHouse/footer::footer"></div>
      <!-- footer End -->
    </div>
    <!-- Container-fluid End -->
  </div>
  <!-- Page Body End -->
</div>
<!-- page-wrapper End -->

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">Thông tin Đơn hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="detailsOrderId">
        <table class="table table-borderless">
          <thead>
          <tr>
            <th class="text-center">STT</th>
            <th class="text-center">Tên Chi tiết Sản phẩm</th>
            <th class="text-center">Số lượng</th>
            <th class="text-center">Giá</th>
          </tr>
          </thead>
          <tbody id="orderDetailsTableBody">
          <tr>
            <td colspan="4" class="text-center">Đang tải dữ liệu...</td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Modal -->
<div th:replace="~{BackEnd/fragments/WareHouse/logout::logout}"></div>
<!-- Modal End -->

<!-- Latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom CSS for balancing the table -->
<style>
  .balanced-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
  }
  .balanced-table th, .balanced-table td {
    text-align: center !important;
    vertical-align: middle;
    padding: 10px;
  }
  .balanced-table th:first-child, .balanced-table td:first-child {
    width: 5%;
  }
  .balanced-table th:nth-child(2), .balanced-table td:nth-child(2) {
    width: 40%;
  }
  .balanced-table th:nth-child(3), .balanced-table td:nth-child(3) {
    width: 20%;
  }
  .balanced-table th:nth-child(4), .balanced-table td:nth-child(4) {
    width: 15%;
  }
  .balanced-table th:nth-child(5), .balanced-table td:nth-child(5) {
    width: 20%;
  }
  .balanced-table td button {
    display: block;
    margin: 0 auto;
    width: auto;
  }
  .status-returned {
    color: #ff0000; /* Red for RETURNED */
    font-weight: bold;
  }

  .status-exported {
    color: #008000; /* Green for EXPORTED */
    font-weight: bold;
  }
</style>

<!-- Custom JavaScript -->
<script>
  $(document).ready(function () {
    console.log('[DEBUG] Initializing page at ' + new Date().toISOString());

    // DOM Elements
    const orderTableBody = $('#orderTableBody');
    const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    const detailsOrderId = $('#detailsOrderId');
    const orderDetailsTableBody = $('#orderDetailsTableBody');

    // Validate DOM elements
    console.log('[DEBUG] Validating DOM elements');
    if (!orderTableBody.length || !orderDetailsTableBody.length || !detailsOrderId.length) {
      console.error('[ERROR] Missing DOM elements:', {
        orderTableBody: !!orderTableBody.length,
        orderDetailsTableBody: !!orderDetailsTableBody.length,
        detailsOrderId: !!detailsOrderId.length
      });
      $.notify({ message: 'Không tìm thấy bảng #orderTableBody. Vui lòng kiểm tra HTML.' }, { type: 'danger', delay: 3000 });
      return;
    }
    console.log('[DEBUG] All DOM elements found');

    // Function to format status with color
    function formatStatus(status) {
      if (!status) return 'N/A';
      switch (status.toUpperCase()) {
        case 'RETURNED':
          return `<span class="status-returned">Đã trả hàng</span>`;
        case 'EXPORTED':
          return `<span class="status-exported">Đã xuất kho</span>`;
        default:
          return status;
      }
    }

    // Load Pending StockOuts for Return
    function loadPendingStockOutsForReturn() {
      console.log('[DEBUG] Loading pending stockouts for return from /AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts');
      $.ajax({
        url: '/AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts',
        method: 'GET',
        dataType: 'json',
        beforeSend: function() {
          console.log('[DEBUG] Sending GET request to /AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts');
        },
        success: function(data) {
          console.log('[DEBUG] Response from /AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts:', JSON.stringify(data, null, 2));
          orderTableBody.empty();
          if (Array.isArray(data) && data.length > 0) {
            const stockOutPromises = data.map((stockOut, index) => {
              return new Promise((resolve) => {
                const stockOutId = stockOut.id || 'N/A';
                const orderId = stockOut.orderID || 'N/A';
                const status = formatStatus(stockOut.status);

                // Fetch orderCode
                let orderCode = `ORD${orderId}`;
                $.ajax({
                  url: `/AgriculturalWarehouseManagementApplication/api/orders/${orderId}`,
                  method: 'GET',
                  async: false,
                  success: function(order) {
                    orderCode = order.orderCode || `ORD${orderId}`;
                    console.log(`[DEBUG] OrderCode for orderID ${orderId}: ${orderCode}`);
                  },
                  error: function(xhr, status, error) {
                    console.error(`[ERROR] Lỗi khi lấy order ${orderId}:`, { status, error });
                  }
                });

                if (stockOutId) {
                  const stt = index + 1; // Tính STT từ index
                  const row = `
                <tr>
                  <td class="text-center">${stt}</td> <!-- Hiển thị STT thay vì stockOutId -->
                  <td class="text-center">${orderCode}</td>
                  <td class="text-center">${status}</td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-info view-details-btn"
                            data-order-id="${orderId}"
                            data-order-code="${orderCode}"
                            data-bs-toggle="modal"
                            data-bs-target="#orderDetailsModal">Xem</button>
                  </td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-warning return-stockout-btn" data-stockout-id="${stockOutId}">Nhập lại kho</button>
                  </td>
                </tr>
              `;
                  resolve(row);
                } else {
                  console.warn('[WARN] Invalid stockout data:', stockOut);
                  resolve(null);
                }
              });
            });

            Promise.all(stockOutPromises).then(rows => {
              const filteredRows = rows.filter(row => row !== null);
              orderTableBody.empty();
              filteredRows.forEach(row => orderTableBody.append(row));
              console.log(`[DEBUG] Added ${filteredRows.length} rows to table`);

              if (filteredRows.length === 0) {
                orderTableBody.append('<tr><td colspan="5" class="text-center">Không có đơn hàng chờ nhập lại kho.</td></tr>');
              }
              bindTableActions();
            });
          } else {
            console.warn('[WARN] No stockouts found or invalid data:', data);
            orderTableBody.append('<tr><td colspan="5" class="text-center">Không có đơn hàng chờ nhập lại kho.</td></tr>');
            bindTableActions();
          }
        },
        error: function(xhr, status, error) {
          console.error('[ERROR] Failed to load stockouts for return:', {
            url: '/AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts',
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
            error: error
          });
          orderTableBody.append('<tr><td colspan="5" class="text-center">Lỗi tải dữ liệu.</td></tr>');
        }
      });
    }

    // Load Order Details
    function loadOrderDetails(orderId) {
      console.log('[DEBUG] Loading order details from /AgriculturalWarehouseManagementApplication/' + orderId + '/details');
      orderDetailsTableBody.html('<tr><td colspan="4" class="text-center">Đang tải dữ liệu...</td></tr>');

      $.ajax({
        url: '/AgriculturalWarehouseManagementApplication/' + orderId + '/details',
        method: 'GET',
        dataType: 'json',
        timeout: 10000,
        success: function(data) {
          console.log('[DEBUG] Response from /' + orderId + '/details:', JSON.stringify(data, null, 2));
          orderDetailsTableBody.empty();

          if (!Array.isArray(data) || data.length === 0) {
            orderDetailsTableBody.append('<tr><td colspan="4" class="text-center">Không có chi tiết đơn hàng.</td></tr>');
            return;
          }

          const detailPromises = data.map((item, index) => {
            return new Promise((resolve) => {
              const stt = index + 1;
              const quantity = item.quantity;
              const price = item.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
              const productDetailId = item.productDetailId;

              let productDetailName = 'N/A';

              // Load product detail to get detailName and productID
              $.ajax({
                url: `/AgriculturalWarehouseManagementApplication/api/product-details/${productDetailId}`,
                method: 'GET',
                success: function(productDetail) {
                  const detailName = productDetail.detailName || 'N/A';
                  const productId = productDetail.productID || productDetail.productId || 'N/A';
                  let productName = 'N/A';

                  if (productId !== 'N/A') {
                    $.ajax({
                      url: `/AgriculturalWarehouseManagementApplication/api/products/${productId}/name`,
                      method: 'GET',
                      success: function(name) {
                        productName = name || 'N/A';
                        productDetailName = `${productName} (${detailName})`;
                        console.log(`[DEBUG] Product detail name for productDetailId ${productDetailId}: ${productDetailName}`);
                        createRow();
                      },
                      error: function(xhr, status, error) {
                        console.error(`[ERROR] Lỗi khi lấy tên sản phẩm cho productId ${productId}:`, { status, error });
                        productDetailName = `N/A (${detailName})`;
                        createRow();
                      }
                    });
                  } else {
                    productDetailName = `N/A (${detailName})`;
                    createRow();
                  }
                },
                error: function(xhr, status, error) {
                  console.error(`[ERROR] Lỗi khi lấy productDetail ${productDetailId}:`, { status, error });
                  createRow();
                }
              });

              function createRow() {
                const row = `
                  <tr>
                    <td class="text-center">${stt}</td>
                    <td class="text-center">${productDetailName}</td>
                    <td class="text-center">${quantity}</td>
                    <td class="text-center">${price}</td>
                  </tr>
                `;
                resolve(row);
              }
            });
          });

          Promise.all(detailPromises).then(rows => {
            rows.forEach(row => orderDetailsTableBody.append(row));
            console.log(`[DEBUG] Added ${rows.length} detail rows to modal table`);
          });
        },
        error: function(xhr, status, error) {
          console.error('[ERROR] Failed to load order details:', {
            url: '/AgriculturalWarehouseManagementApplication/' + orderId + '/details',
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
            error: error
          });
          orderDetailsTableBody.empty();
          orderDetailsTableBody.append('<tr><td colspan="4" class="text-center">Lỗi tải dữ liệu chi tiết. Vui lòng thử lại.</td></tr>');
          $.notify({ message: 'Lỗi tải dữ liệu chi tiết đơn hàng.' }, { type: 'danger', delay: 3000 });
        }
      });
    }

    // Bind Table Actions
    function bindTableActions() {
      console.log('[DEBUG] Binding table actions');
      $('.return-stockout-btn').on('click', function() {
        const stockOutId = parseInt($(this).data('stockout-id'));
        console.log('[DEBUG] Return StockOut button clicked for StockOut ID:', stockOutId);
        updateStockOutStatus(stockOutId);
      });

      $('.view-details-btn').off('click').on('click', function() {
        const orderID = parseInt($(this).data('order-id'));
        const orderCode = $(this).data('order-code') || `ORD${orderID}`;

        if (isNaN(orderID)) {
          console.error('[ERROR] Invalid order ID for details:', $(this).data('order-id'));
          $.notify({ message: 'Lỗi: ID đơn hàng không hợp lệ.' }, { type: 'danger', delay: 3000 });
          return;
        }

        console.log('[DEBUG] View Details button clicked for Order ID:', orderID, 'Order Code:', orderCode);
        detailsOrderId.val(orderID);
        $('#orderDetailsModalLabel').text(`Thông tin Đơn hàng ${orderCode}`);
        loadOrderDetails(orderID);
        orderDetailsModal.show();
      });
    }

    // Update StockOut Status to RETURNED and trigger processed API
    function updateStockOutStatus(stockOutId) {
      console.log('[DEBUG] Sending PUT request to update stockout status for ID:', stockOutId);
      $.ajax({
        url: `/AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ status: 'RETURNED' }),
        beforeSend: function() {
          console.log('[DEBUG] PUT request initiated to /AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status');
        },
        success: function(response) {
          console.log('[DEBUG] Success response from /AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status:', JSON.stringify(response, null, 2));
          $.notify({ message: 'Cập nhật trạng thái thành RETURNED thành công!' }, { type: 'success', delay: 3000 });

          // Gọi API để reset soldQuantity
          $.ajax({
            url: '/AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed',
            method: 'GET',
            dataType: 'json',
            beforeSend: function() {
              console.log('[DEBUG] Sending GET request to /AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed');
            },
            success: function(processedResponse) {
              console.log('[DEBUG] Success response from /AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed:', JSON.stringify(processedResponse, null, 2));
              $.notify({ message: 'Đã cập nhật soldQuantity thành công!' }, { type: 'success', delay: 3000 });
              setTimeout(() => {
                window.location.href = '/AgriculturalWarehouseManagementApplication/warehouse/stockout';
              }, 1000);
            },
            error: function(xhr, status, error) {
              console.error('[ERROR] Failed to process soldQuantity:', {
                url: '/AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed',
                status: xhr.status,
                statusText: xhr.statusText,
                response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                error: error
              });
              $.notify({ message: 'Lỗi khi cập nhật soldQuantity: ' + (xhr.responseJSON?.message || 'Vui lòng thử lại.') }, { type: 'danger', delay: 3000 });
            }
          });
        },
        error: function(xhr, status, error) {
          console.error('[ERROR] Failed to update stockout status:', {
            url: `/AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status`,
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
            error: error
          });
          $.notify({ message: 'Lỗi khi cập nhật trạng thái: ' + (xhr.responseJSON?.message || 'Vui lòng thử lại.') }, { type: 'danger', delay: 3000 });
        }
      });
    }

    // Initialize
    console.log('[DEBUG] Starting initialization');
    loadPendingStockOutsForReturn();
  });
</script>

</body>
</html>