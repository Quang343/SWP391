<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start -->
<div class="tap-top">
  <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end -->

<!-- page-wrapper start -->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
  <!-- Page Header Start-->
  <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
  <!-- Page Header Ends-->

  <!-- Page Body start -->
  <div class="page-body-wrapper">
    <!-- Page Sidebar Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
    <!-- Page Sidebar Ends-->

    <div class="page-body">
      <!-- Pending StockOuts for Return Table -->
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-12">
            <div class="card">
              <div class="card-body">
                <div class="card-header-2">
                  <h5>Danh sách Đơn hàng Chờ Nhập lại kho</h5>
                </div>
                <div class="table-responsive">
                  <table class="table table-borderless">
                    <thead>
                    <tr>
                      <th>ID Xuất kho</th>
                      <th>Đơn hàng</th>
                      <th>Trạng thái</th>
                      <th>Hành động</th>
                    </tr>
                    </thead>
                    <tbody id="orderTableBody">
                    <tr>
                      <td colspan="4">Đang tải dữ liệu...</td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Pending StockOuts for Return End -->

      <!-- footer Start -->
      <div th:replace="BackEnd/fragments/WareHouse/footer::footer"></div>
      <!-- footer End -->
    </div>
    <!-- Container-fluid End -->
  </div>
  <!-- Page Body End -->
</div>
<!-- page-wrapper End -->

<!-- Logout Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h5 class="modal-title" id="staticBackdropLabel">Đăng xuất</h5>
        <p>Bạn có chắc chắn muốn đăng xuất?</p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="button-box">
          <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
          <button type="button" th:onclick="|window.location='@{/backend/login}'|" class="btn btn--yes btn-primary">Có</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal End -->

<!-- Latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('[DEBUG] Initializing page at ' + new Date().toISOString());

    // DOM Elements
    const orderTableBody = document.getElementById('orderTableBody');

    // Validate DOM elements
    console.log('[DEBUG] Validating DOM elements');
    if (!orderTableBody) {
      console.error('[ERROR] Missing orderTableBody element');
      $.notify({ message: 'Lỗi giao diện, vui lòng kiểm tra console.' }, { type: 'danger', delay: 3000 });
      return;
    }
    console.log('[DEBUG] All DOM elements found');

    // Function to format status with color
    function formatStatus(status) {
      if (!status) return 'N/A';
      switch (status.toUpperCase()) {
        case 'RETURNED':
          return `<span class="status-returned">Đã trả hàng</span>`;
        case 'EXPORTED':
          return `<span class="status-exported">Đã xuất kho</span>`;
        default:
          return status;
      }
    }

    // Load Pending StockOuts for Return
    function loadPendingStockOutsForReturn() {
      console.log('[DEBUG] Loading pending stockouts for return from /AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts');
      $.ajax({
        url: '/AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts',
        method: 'GET',
        dataType: 'json',
        beforeSend: function() {
          console.log('[DEBUG] Sending GET request to /AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts');
        },
        success: function(data) {
          console.log('[DEBUG] Response from /AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts:', JSON.stringify(data, null, 2));
          orderTableBody.innerHTML = '';
          if (Array.isArray(data) && data.length > 0) {
            data.forEach(stockOut => {
              const stockOutId = stockOut.id;
              const orderId = stockOut.orderID ? `Đơn hàng #${stockOut.orderID}` : 'N/A';
              const status = formatStatus(stockOut.status);
              if (stockOutId) {
                orderTableBody.innerHTML += `
                                    <tr>
                                        <td>${stockOutId}</td>
                                        <td>${orderId}</td>
                                        <td>${status}</td>
                                        <td>
                                            <button class="btn btn-sm btn-warning return-stockout-btn" data-stockout-id="${stockOutId}">Nhập lại kho</button>
                                        </td>
                                    </tr>
                                `;
                console.log('[DEBUG] Added stockout for return:', { stockOutId, orderId, status });
              } else {
                console.warn('[WARN] Invalid stockout data:', stockOut);
              }
            });
          } else {
            console.warn('[WARN] No stockouts found or invalid data:', data);
            orderTableBody.innerHTML = '<tr><td colspan="4">Không có đơn hàng chờ nhập lại kho.</td></tr>';
          }
          bindTableActions();
        },
        error: function(xhr, status, error) {
          console.error('[ERROR] Failed to load stockouts for return:', {
            url: '/AgriculturalWarehouseManagementApplication/api/stockouts/exported-stockouts',
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
            error: error
          });
          orderTableBody.innerHTML = '<tr><td colspan="4">Lỗi tải dữ liệu.</td></tr>';
        }
      });
    }

    // Bind Table Actions
    function bindTableActions() {
      console.log('[DEBUG] Binding table actions');
      $('.return-stockout-btn').on('click', function() {
        const stockOutId = parseInt($(this).data('stockout-id'));
        console.log('[DEBUG] Return StockOut button clicked for StockOut ID:', stockOutId);
        updateStockOutStatus(stockOutId);
      });
    }

    // Update StockOut Status to RETURNED and trigger processed API
    function updateStockOutStatus(stockOutId) {
      console.log('[DEBUG] Sending PUT request to update stockout status for ID:', stockOutId);
      $.ajax({
        url: `/AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status`, // Sửa lại đường dẫn đúng
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ status: 'RETURNED' }),
        beforeSend: function() {
          console.log('[DEBUG] PUT request initiated to /AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status');
        },
        success: function(response) {
          console.log('[DEBUG] Success response from /AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status:', JSON.stringify(response, null, 2));
          $.notify({ message: 'Cập nhật trạng thái thành RETURNED thành công!' }, { type: 'success', delay: 3000 });

          // Gọi API để reset soldQuantity
          $.ajax({
            url: '/AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed',
            method: 'GET',
            dataType: 'json',
            beforeSend: function() {
              console.log('[DEBUG] Sending GET request to /AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed');
            },
            success: function(processedResponse) {
              console.log('[DEBUG] Success response from /AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed:', JSON.stringify(processedResponse, null, 2));
              $.notify({ message: 'Đã cập nhật soldQuantity thành công!' }, { type: 'success', delay: 3000 });
              // Chuyển hướng sau khi hoàn tất
              setTimeout(() => {
                window.location.href = '/AgriculturalWarehouseManagementApplication/warehouse/stockout';
              }, 1000);
            },
            error: function(xhr, status, error) {
              console.error('[ERROR] Failed to process soldQuantity:', {
                url: '/AgriculturalWarehouseManagementApplication/api/stockouts/returnstockout/details/processed',
                status: xhr.status,
                statusText: xhr.statusText,
                response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                error: error
              });
              $.notify({ message: 'Lỗi khi cập nhật soldQuantity: ' + (xhr.responseJSON?.message || 'Vui lòng thử lại.') }, { type: 'danger', delay: 3000 });
            }
          });
        },
        error: function(xhr, status, error) {
          console.error('[ERROR] Failed to update stockout status:', {
            url: `/AgriculturalWarehouseManagementApplication/api/stockouts/return/${stockOutId}/status`,
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
            error: error
          });
          $.notify({ message: 'Lỗi khi cập nhật trạng thái: ' + (xhr.responseJSON?.message || 'Vui lòng thử lại.') }, { type: 'danger', delay: 3000 });
        }
      });
    }

    // Initialize
    console.log('[DEBUG] Starting initialization');
    loadPendingStockOutsForReturn();
  });
</script>

<style>
  .status-returned {
    color: #ff0000; /* Red for RETURNED */
    font-weight: bold;
  }

  .status-exported {
    color: #008000; /* Green for EXPORTED */
    font-weight: bold;
  }
</style>

</body>
</html>