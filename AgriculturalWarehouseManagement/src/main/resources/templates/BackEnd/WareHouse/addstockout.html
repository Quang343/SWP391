<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start -->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end -->

<!-- page-wrapper start -->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body start -->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
        <!-- Page Sidebar Ends-->

        <div class="page-body">
            <!-- Pending Orders List Table -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-header-2">
                                    <h5>Danh sách Đơn hàng Chờ Xuất kho</h5>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <thead>
                                        <tr>
                                            <th>ID Đơn hàng</th>
                                            <th>Tên Đơn hàng</th>
                                            <th>Hành động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="orderTableBody">
                                        <tr>
                                            <td colspan="3">Đang tải dữ liệu...</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Pending Orders List End -->

            <!-- footer Start -->
            <div th:replace="BackEnd/fragments/WareHouse/footer::footer"></div>
            <!-- footer End -->
        </div>
        <!-- Container-fluid End -->
    </div>
    <!-- Page Body End -->
</div>
<!-- page-wrapper End -->

<!-- StockOut Modal -->
<div class="modal fade" id="stockOutModal" tabindex="-1" aria-labelledby="stockOutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stockOutModalLabel">Tạo Xuất kho</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalOrderId">
                <div class="mb-3">
                    <label for="modalWarehouseId" class="form-label">Kho hàng</label>
                    <select id="modalWarehouseId" class="form-control" required>
                        <option value="">Chọn Kho hàng</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modalStockOutDate" class="form-label">Ngày Xuất kho</label>
                    <input id="modalStockOutDate" class="form-control" type="text" readonly>
                </div>
                <div class="mb-3">
                    <label for="modalNote" class="form-label">Ghi chú</label>
                    <input id="modalNote" class="form-control" type="text" placeholder="Nhập Ghi chú">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="modalSubmitButton" class="btn btn-primary" disabled>Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Logout Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Đăng xuất</h5>
                <p>Bạn có chắc chắn muốn đăng xuất?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
                    <button type="button" th:onclick="|window.location='@{/backend/login}'|" class="btn btn--yes btn-primary">Có</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('[DEBUG] Initializing page at ' + new Date().toISOString());

        // DOM Elements
        const orderTableBody = document.getElementById('orderTableBody');
        const modalOrderId = document.getElementById('modalOrderId');
        const modalWarehouseId = document.getElementById('modalWarehouseId');
        const modalStockOutDate = document.getElementById('modalStockOutDate');
        const modalNote = document.getElementById('modalNote');
        const modalSubmitButton = document.getElementById('modalSubmitButton');
        const stockOutModal = new bootstrap.Modal(document.getElementById('stockOutModal'));

        // Validate DOM elements
        console.log('[DEBUG] Validating DOM elements');
        if (!orderTableBody || !modalOrderId || !modalWarehouseId || !modalStockOutDate || !modalNote || !modalSubmitButton) {
            console.error('[ERROR] Missing DOM elements:', {
                orderTableBody: !!orderTableBody,
                modalOrderId: !!modalOrderId,
                modalWarehouseId: !!modalWarehouseId,
                modalStockOutDate: !!modalStockOutDate,
                modalNote: !!modalNote,
                modalSubmitButton: !!modalSubmitButton
            });
            $.notify({ message: 'Lỗi giao diện, vui lòng kiểm tra console.' }, { type: 'danger', delay: 3000 });
            return;
        }
        console.log('[DEBUG] All DOM elements found');

        // Warehouse Data
        let warehouses = [];

        // Update Modal Submit Button State
        function updateModalSubmitButtonState() {
            const isValid = modalWarehouseId.value;
            modalSubmitButton.disabled = !isValid;
            console.log('[DEBUG] Modal submit button state:', {
                isValid: isValid,
                warehouseId: modalWarehouseId.value
            });
        }

        // Add change listener for modal validation
        console.log('[DEBUG] Adding event listener for warehouse input');
        modalWarehouseId.addEventListener('change', function() {
            console.log('[DEBUG] Warehouse ID changed:', modalWarehouseId.value);
            updateModalSubmitButtonState();
        });

        // Load Warehouses
        function loadWarehouses() {
            console.log('[DEBUG] Loading warehouses from /api/warehouses');
            $.ajax({
                url: '/api/warehouses',
                method: 'GET',
                dataType: 'json',
                beforeSend: function() {
                    console.log('[DEBUG] Sending GET request to /api/warehouses');
                },
                success: function(data) {
                    console.log('[DEBUG] Response from /api/warehouses:', JSON.stringify(data, null, 2));
                    warehouses = Array.isArray(data) ? data : [];
                    modalWarehouseId.innerHTML = '<option value="">Chọn Kho hàng</option>';
                    if (warehouses.length > 0) {
                        warehouses.forEach(warehouse => {
                            const id = warehouse.warehouseId || warehouse.id;
                            const name = warehouse.warehouseName || warehouse.name;
                            if (id && name) {
                                modalWarehouseId.innerHTML += `<option value="${id}">${name}</option>`;
                                console.log('[DEBUG] Added warehouse:', { id: id, name: name });
                            } else {
                                console.warn('[WARN] Invalid warehouse data:', warehouse);
                            }
                        });
                    } else {
                        console.warn('[WARN] No warehouses found or invalid data:', data);
                        modalWarehouseId.innerHTML = '<option value="">Không có kho hàng</option>';
                    }
                    updateModalSubmitButtonState();
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Failed to load warehouses:', {
                        url: '/api/warehouses',
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                        error: error
                    });
                    modalWarehouseId.innerHTML = '<option value="">Lỗi tải kho</option>';
                    updateModalSubmitButtonState();
                }
            });
        }

        // Load Pending Orders
        function loadPendingOrders() {
            console.log('[DEBUG] Loading pending orders from /warehouse/api/addstockout');
            $.ajax({
                url: '/warehouse/api/addstockout',
                method: 'GET',
                dataType: 'json',
                beforeSend: function() {
                    console.log('[DEBUG] Sending GET request to /warehouse/api/addstockout');
                },
                success: function(data) {
                    console.log('[DEBUG] Response from /warehouse/api/addstockout:', JSON.stringify(data, null, 2));
                    orderTableBody.innerHTML = '';
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(order => {
                            const id = order.id;
                            const name = order.orderName || `Đơn hàng #${id}`;
                            if (id) {
                                orderTableBody.innerHTML += `
                                <tr>
                                    <td>${id}</td>
                                    <td>${name}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary create-stockout-btn" data-order-id="${id}" data-bs-toggle="modal" data-bs-target="#stockOutModal">Tạo Xuất kho</button>
                                    </td>
                                </tr>
                            `;
                                console.log('[DEBUG] Added order:', { id: id, name: name });
                            } else {
                                console.warn('[WARN] Invalid order data:', order);
                            }
                        });
                    } else {
                        console.warn('[WARN] No orders found or invalid data:', data);
                        orderTableBody.innerHTML = '<tr><td colspan="3">Không có đơn hàng chờ xuất kho.</td></tr>';
                    }
                    bindTableActions();
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Failed to load orders:', {
                        url: '/warehouse/api/addstockout',
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                        error: error
                    });
                    orderTableBody.innerHTML = '<tr><td colspan="3">Lỗi tải dữ liệu.</td></tr>';
                }
            });
        }

        // Bind Table Actions
        function bindTableActions() {
            console.log('[DEBUG] Binding table actions');
            $('.create-stockout-btn').on('click', function() {
                const orderID = parseInt($(this).data('order-id'));
                console.log('[DEBUG] Create StockOut button clicked for Order ID:', orderID);
                modalOrderId.value = orderID;
                modalStockOutDate.value = new Date().toLocaleString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }); // Display current date and time in VN format
                modalNote.value = `Xuất kho nhanh cho đơn hàng #${orderID}`;
                modalWarehouseId.value = ''; // Reset warehouse selection
                console.log('[DEBUG] Modal initialized:', {
                    orderId: modalOrderId.value,
                    stockOutDate: modalStockOutDate.value,
                    note: modalNote.value,
                    warehouseId: modalWarehouseId.value
                });
                updateModalSubmitButtonState();
                stockOutModal.show();
            });
        }

        // Create StockOut
        modalSubmitButton.addEventListener('click', function() {
            const warehouseValue = modalWarehouseId.value;
            const orderValue = modalOrderId.value;
            const parsedWarehouseID = warehouseValue ? parseInt(warehouseValue) : null;
            const parsedOrderID = orderValue ? parseInt(orderValue) : null;
            const data = {
                warehouseID: parsedWarehouseID,
                orderID: parsedOrderID,
                stockOutDate: new Date().toISOString(), // Send current date and time in ISO format
                note: modalNote.value.trim() || null
            };
            console.log('[DEBUG] StockOut data prepared for submission:', JSON.stringify(data, null, 2));

            if (!data.warehouseID || isNaN(data.warehouseID)) {
                console.warn('[WARN] Invalid warehouseID:', warehouseValue);
                $.notify({ message: 'Vui lòng chọn kho hàng hợp lệ.' }, { type: 'warning', delay: 3000 });
                return;
            }
            if (!data.orderID || isNaN(data.orderID)) {
                console.warn('[WARN] Invalid orderID:', orderValue);
                $.notify({ message: 'Lỗi: Đơn hàng không hợp lệ.' }, { type: 'warning', delay: 3000 });
                return;
            }

            // Create StockOut
            console.log('[DEBUG] Sending POST request to /api/stockouts:', JSON.stringify(data, null, 2));
            $.ajax({
                url: '/api/stockouts',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function() {
                    console.log('[DEBUG] POST request initiated to /api/stockouts');
                },
                success: function(response) {
                    console.log('[DEBUG] Success response from /api/stockouts:', JSON.stringify(response, null, 2));
                    $.notify({ message: 'Tạo StockOut và StockOutDetails thành công!' }, { type: 'success', delay: 3000 });
                    setTimeout(() => {
                        stockOutModal.hide();
                        loadPendingOrders();
                    }, 500);
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Failed to create StockOut:', {
                        url: '/api/stockouts',
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                        error: error
                    });
                    $.notify({ message: 'Lỗi khi tạo StockOut: ' + (xhr.responseJSON?.message || 'Vui lòng kiểm tra dữ liệu và thử lại.') }, { type: 'danger', delay: 3000 });
                }
            });
        });

        // Initialize
        console.log('[DEBUG] Starting initialization');
        loadWarehouses();
        loadPendingOrders();
    });
</script>

</body>
</html>