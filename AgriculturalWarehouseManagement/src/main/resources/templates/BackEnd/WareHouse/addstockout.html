<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start -->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end -->

<!-- page-wrapper start -->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body start -->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
        <!-- Page Sidebar Ends-->

        <div class="page-body">
            <!-- Pending Orders List Table -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-header-2">
                                    <h5>Danh sách Đơn hàng Chờ Xuất kho</h5>
                                </div>
                                <table class="table table-borderless balanced-table">
                                    <thead>
                                    <tr>
                                        <th class="text-center">STT</th>
                                        <th class="text-center">Tên Đơn hàng</th>
                                        <th class="text-center">Thông tin</th>
                                        <th class="text-center">Hành động</th>
                                    </tr>
                                    </thead>
                                    <tbody id="orderTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center">Đang tải dữ liệu...</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pending Orders List End -->

        <!-- footer Start -->
        <div th:replace="BackEnd/fragments/WareHouse/footer::footer"></div>
        <!-- footer End -->
    </div>
    <!-- Container-fluid End -->
</div>
<!-- Page Body End -->
</div>
<!-- page-wrapper End -->

<!-- StockOut Modal -->
<div class="modal fade" id="stockOutModal" tabindex="-1" aria-labelledby="stockOutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stockOutModalLabel">Tạo Xuất kho</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalOrderId">
                <div class="mb-3">
                    <label for="modalWarehouseId" class="form-label">Kho hàng</label>
                    <select id="modalWarehouseId" class="form-control" required>
                        <option value="">Chọn Kho hàng</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modalStockOutDate" class="form-label">Ngày Xuất kho</label>
                    <input id="modalStockOutDate" class="form-control" type="text" readonly>
                </div>
                <div class="mb-3">
                    <label for="modalNote" class="form-label">Ghi chú</label>
                    <input id="modalNote" class="form-control" type="text" placeholder="Nhập Ghi chú">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="modalSubmitButton" class="btn btn-primary" disabled>Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Thông tin Đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="detailsOrderId">
                <table class="table table-borderless">
                    <thead>
                    <tr>
                        <th class="text-center">STT</th>
                        <th class="text-center">Tên Chi tiết Sản phẩm</th>
                        <th class="text-center">Số lượng</th>
                        <th class="text-center">Giá</th>
                    </tr>
                    </thead>
                    <tbody id="orderDetailsTableBody">
                    <tr>
                        <td colspan="4" class="text-center">Đang tải dữ liệu...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Logout Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Đăng xuất</h5>
                <p>Bạn có chắc chắn muốn đăng xuất?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
                    <button type="button" th:onclick="|window.location='@{/backend/login}'|" class="btn btn--yes btn-primary">Có</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom CSS for balancing the table -->
<style>
    .balanced-table {
        width: 100%;
        table-layout: fixed;
    }
    .balanced-table th, .balanced-table td {
        text-align: center !important;
        vertical-align: middle;
        padding: 10px;
    }
    .balanced-table th:first-child, .balanced-table td:first-child {
        width: 5%;
    }
    .balanced-table th:nth-child(2), .balanced-table td:nth-child(2) {
        width: 50%;
    }
    .balanced-table th:nth-child(3), .balanced-table td:nth-child(3) {
        width: 15%;
    }
    .balanced-table th:nth-child(4), .balanced-table td:nth-child(4) {
        width: 30%;
    }
</style>

<!-- Custom JavaScript -->
<script>
    $(document).ready(function () {
        console.log('[DEBUG] Initializing page at ' + new Date().toISOString());

        // DOM Elements
        const orderTableBody = $('#orderTableBody');
        const modalOrderId = $('#modalOrderId');
        const modalWarehouseId = $('#modalWarehouseId');
        const modalStockOutDate = $('#modalStockOutDate');
        const modalNote = $('#modalNote');
        const modalSubmitButton = $('#modalSubmitButton');
        const stockOutModal = new bootstrap.Modal(document.getElementById('stockOutModal'));
        const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
        const detailsOrderId = $('#detailsOrderId');
        const orderDetailsTableBody = $('#orderDetailsTableBody');

        // Validate DOM elements
        console.log('[DEBUG] Validating DOM elements');
        if (!orderTableBody.length || !modalOrderId.length || !modalWarehouseId.length ||
            !modalStockOutDate.length || !modalNote.length || !modalSubmitButton.length ||
            !orderDetailsTableBody.length || !detailsOrderId.length) {
            console.error('[ERROR] Missing DOM elements:', {
                orderTableBody: !!orderTableBody.length,
                modalOrderId: !!modalOrderId.length,
                modalWarehouseId: !!modalWarehouseId.length,
                modalStockOutDate: !!modalStockOutDate.length,
                modalNote: !!modalNote.length,
                modalSubmitButton: !!modalSubmitButton.length,
                orderDetailsTableBody: !!orderDetailsTableBody.length,
                detailsOrderId: !!detailsOrderId.length
            });
            $.notify({ message: 'Lỗi giao diện, vui lòng kiểm tra console.' }, { type: 'danger', delay: 3000 });
            return;
        }
        console.log('[DEBUG] All DOM elements found');

        // Warehouse Data
        let warehouses = [];

        // Update Modal Submit Button State
        function updateModalSubmitButtonState() {
            const isValid = modalWarehouseId.val();
            modalSubmitButton.prop('disabled', !isValid);
            console.log('[DEBUG] Modal submit button state:', {
                isValid: isValid,
                warehouseId: modalWarehouseId.val()
            });
        }

        // Add change listener for modal validation
        console.log('[DEBUG] Adding event listener for warehouse input');
        modalWarehouseId.on('change', function() {
            console.log('[DEBUG] Warehouse ID changed:', modalWarehouseId.val());
            updateModalSubmitButtonState();
        });

        // Load Warehouses
        function loadWarehouses() {
            console.log('[DEBUG] Loading warehouses from /AgriculturalWarehouseManagementApplication/api/warehouses');
            $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/api/warehouses',
                method: 'GET',
                dataType: 'json',
                beforeSend: function() {
                    console.log('[DEBUG] Sending GET request to /AgriculturalWarehouseManagementApplication/api/warehouses');
                },
                success: function(data) {
                    console.log('[DEBUG] Response from /AgriculturalWarehouseManagementApplication/api/warehouses:', JSON.stringify(data, null, 2));
                    warehouses = Array.isArray(data) ? data : [];
                    modalWarehouseId.html('<option value="">Chọn Kho hàng</option>');
                    if (warehouses.length > 0) {
                        warehouses.forEach(warehouse => {
                            const id = warehouse.warehouseId || warehouse.id;
                            const name = warehouse.warehouseName || warehouse.name;
                            if (id && name) {
                                modalWarehouseId.append(`<option value="${id}">${name}</option>`);
                                console.log('[DEBUG] Added warehouse:', { id: id, name: name });
                            } else {
                                console.warn('[WARN] Invalid warehouse data:', warehouse);
                            }
                        });
                    } else {
                        console.warn('[WARN] No warehouses found or invalid data:', data);
                        modalWarehouseId.html('<option value="">Không có kho hàng</option>');
                    }
                    updateModalSubmitButtonState();
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Failed to load warehouses:', {
                        url: '/AgriculturalWarehouseManagementApplication/api/warehouses',
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: (function () {
                            try {
                                return JSON.stringify(JSON.parse(xhr.responseText), null, 2);
                            } catch (e) {
                                return xhr.responseText || 'No response body';
                            }
                        })(),
                        error: error
                    });
                    modalWarehouseId.html('<option value="">Lỗi tải kho</option>');
                    updateModalSubmitButtonState();
                }
            });
        }

        // Load Pending Orders
        function loadPendingOrders() {
            console.log('[DEBUG] Loading pending orders from /AgriculturalWarehouseManagementApplication/api/addstockout');
            const orderTableBody = $('#orderTableBody');

            if (!orderTableBody.length) {
                console.error('[ERROR] orderTableBody element not found');
                $.notify({ message: 'Lỗi giao diện: Không tìm thấy bảng đơn hàng.' }, { type: 'danger', delay: 3000 });
                return;
            }

            orderTableBody.html('<tr><td colspan="4" class="text-center">Đang tải dữ liệu...</td></tr>');

            $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/api/addstockout',
                method: 'GET',
                dataType: 'json',
                timeout: 10000,
                success: function(data) {
                    console.log('[DEBUG] Response from /addstockout:', JSON.stringify(data, null, 2));
                    orderTableBody.empty();

                    if (!Array.isArray(data) || data.length === 0) {
                        orderTableBody.append('<tr><td colspan="4" class="text-center">Không có đơn hàng chờ xuất kho.</td></tr>');
                        return;
                    }

                    data.forEach((order, index) => {
                        const id = order.orderId;
                        const orderCode = order.orderCode || `#ORD${id}`;
                        const stt = index + 1;

                        const row = `
                    <tr>
    <td class="text-center">${stt}</td>
    <td class="text-center">${orderCode}</td>
    <td class="text-center">
        <div class="d-flex justify-content-center">
            <button class="btn btn-sm btn-info view-details-btn"
                    data-order-id="${id}"
                    data-order-code="${orderCode}"
                    data-bs-toggle="modal"
                    data-bs-target="#orderDetailsModal">Xem</button>
        </div>
    </td>
    <td class="text-center">
        <div class="d-flex justify-content-center">
            <button class="btn btn-sm btn-primary create-stockout-btn"
                    data-order-id="${id}"
                    data-order-code="${orderCode}"
                    data-bs-toggle="modal"
                    data-bs-target="#stockOutModal">Tạo Xuất kho</button>
        </div>
    </td>
</tr>

                `;
                        orderTableBody.append(row);
                    });

                    console.log(`[DEBUG] Added ${data.length} rows to table`);
                    bindTableActions();
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Failed to load orders:', {
                        url: '/AgriculturalWarehouseManagementApplication/api/addstockout',
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                        error: error
                    });
                    orderTableBody.empty();
                    orderTableBody.append('<tr><td colspan="4" class="text-center">Lỗi tải dữ liệu. Vui lòng thử lại.</td></tr>');
                    $.notify({ message: 'Lỗi tải dữ liệu đơn hàng. Vui lòng kiểm tra kết nối.' }, { type: 'danger', delay: 3000 });
                }
            });
        }

        // Load Order Details
        function loadOrderDetails(orderId) {
            console.log('[DEBUG] Loading order details from /AgriculturalWarehouseManagementApplication/' + orderId + '/details');
            orderDetailsTableBody.html('<tr><td colspan="4" class="text-center">Đang tải dữ liệu...</td></tr>');

            $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/' + orderId + '/details',
                method: 'GET',
                dataType: 'json',
                timeout: 10000,
                success: function(data) {
                    console.log('[DEBUG] Response from /' + orderId + '/details:', JSON.stringify(data, null, 2));
                    orderDetailsTableBody.empty();

                    if (!Array.isArray(data) || data.length === 0) {
                        orderDetailsTableBody.append('<tr><td colspan="4" class="text-center">Không có chi tiết đơn hàng.</td></tr>');
                        return;
                    }

                    const detailPromises = data.map((item, index) => {
                        return new Promise((resolve) => {
                            const stt = index + 1;
                            const quantity = item.quantity;
                            const price = item.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                            const productDetailId = item.productDetailId;

                            let productDetailName = 'N/A';

                            // Load product detail to get detailName and productID
                            $.ajax({
                                url: `/AgriculturalWarehouseManagementApplication/api/product-details/${productDetailId}`,
                                method: 'GET',
                                success: function(productDetail) {
                                    const detailName = productDetail.detailName || 'N/A';
                                    const productId = productDetail.productID || productDetail.productId || 'N/A';
                                    let productName = 'N/A';

                                    if (productId !== 'N/A') {
                                        $.ajax({
                                            url: `/AgriculturalWarehouseManagementApplication/api/products/${productId}/name`,
                                            method: 'GET',
                                            success: function(name) {
                                                productName = name || 'N/A';
                                                productDetailName = `${productName} (${detailName})`;
                                                console.log(`[DEBUG] Product detail name for productDetailId ${productDetailId}: ${productDetailName}`);
                                                createRow();
                                            },
                                            error: function(xhr, status, error) {
                                                console.error(`[ERROR] Lỗi khi lấy tên sản phẩm cho productId ${productId}:`, { status, error });
                                                productDetailName = `N/A (${detailName})`;
                                                createRow();
                                            }
                                        });
                                    } else {
                                        productDetailName = `N/A (${detailName})`;
                                        createRow();
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error(`[ERROR] Lỗi khi lấy productDetail ${productDetailId}:`, { status, error });
                                    createRow();
                                }
                            });

                            function createRow() {
                                const row = `
                                    <tr>
                                        <td class="text-center">${stt}</td>
                                        <td class="text-center">${productDetailName}</td>
                                        <td class="text-center">${quantity}</td>
                                        <td class="text-center">${price}</td>
                                    </tr>
                                `;
                                resolve(row);
                            }
                        });
                    });

                    Promise.all(detailPromises).then(rows => {
                        rows.forEach(row => orderDetailsTableBody.append(row));
                        console.log(`[DEBUG] Added ${rows.length} detail rows to modal table`);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Failed to load order details:', {
                        url: '/AgriculturalWarehouseManagementApplication/' + orderId + '/details',
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                        error: error
                    });
                    orderDetailsTableBody.empty();
                    orderDetailsTableBody.append('<tr><td colspan="4" class="text-center">Lỗi tải dữ liệu chi tiết. Vui lòng thử lại.</td></tr>');
                    $.notify({ message: 'Lỗi tải dữ liệu chi tiết đơn hàng.' }, { type: 'danger', delay: 3000 });
                }
            });
        }

        // Bind Table Actions
        function bindTableActions() {
            console.log('[DEBUG] Binding table actions');
            $('.create-stockout-btn').off('click').on('click', function() {
                const orderID = parseInt($(this).data('order-id'));
                const orderCode = $(this).data('order-code') || `ORD${orderID}`; // Fallback nếu orderCode không có

                if (isNaN(orderID)) {
                    console.error('[ERROR] Invalid order ID:', $(this).data('order-id'));
                    $.notify({ message: 'Lỗi: ID đơn hàng không hợp lệ.' }, { type: 'danger', delay: 3000 });
                    return;
                }

                console.log('[DEBUG] Create StockOut button clicked for Order ID:', orderID, 'Order Code:', orderCode);
                modalOrderId.val(orderID);
                modalStockOutDate.val(new Date().toLocaleString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }));
                modalNote.val(`Xuất kho nhanh cho đơn hàng ${orderCode}`); // Sử dụng orderCode
                modalWarehouseId.val('');
                console.log('[DEBUG] Modal initialized:', {
                    orderId: modalOrderId.val(),
                    stockOutDate: modalStockOutDate.val(),
                    note: modalNote.val(),
                    warehouseId: modalWarehouseId.val()
                });
                updateModalSubmitButtonState();
                stockOutModal.show();
            });

            $('.view-details-btn').off('click').on('click', function() {
                const orderID = parseInt($(this).data('order-id'));
                const orderCode = $(this).data('order-code') || `ORD${orderID}`;

                if (isNaN(orderID)) {
                    console.error('[ERROR] Invalid order ID for details:', $(this).data('order-id'));
                    $.notify({ message: 'Lỗi: ID đơn hàng không hợp lệ.' }, { type: 'danger', delay: 3000 });
                    return;
                }

                console.log('[DEBUG] View Details button clicked for Order ID:', orderID, 'Order Code:', orderCode);
                detailsOrderId.val(orderID);
                $('#orderDetailsModalLabel').text(`Thông tin Đơn hàng ${orderCode}`);
                loadOrderDetails(orderID);
                orderDetailsModal.show();
            });
        }

        // Create StockOut
        modalSubmitButton.on('click', function() {
            const warehouseValue = modalWarehouseId.val();
            const orderValue = modalOrderId.val();
            const parsedWarehouseID = warehouseValue ? parseInt(warehouseValue) : null;
            const parsedOrderID = orderValue ? parseInt(orderValue) : null;
            const data = {
                warehouseID: parsedWarehouseID,
                orderID: parsedOrderID,
                stockOutDate: new Date().toISOString(),
                note: modalNote.val().trim() || null
            };
            console.log('[DEBUG] StockOut data prepared for submission:', JSON.stringify(data, null, 2));

            if (!data.warehouseID || isNaN(data.warehouseID)) {
                console.warn('[WARN] Invalid warehouseID:', warehouseValue);
                $.notify({ message: 'Vui lòng chọn kho hàng hợp lệ.' }, { type: 'warning', delay: 3000 });
                return;
            }
            if (!data.orderID || isNaN(data.orderID)) {
                console.warn('[WARN] Invalid orderID:', orderValue);
                $.notify({ message: 'Lỗi: Đơn hàng không hợp lệ.' }, { type: 'warning', delay: 3000 });
                return;
            }

            console.log('[DEBUG] Sending POST request to /api/stockouts:', JSON.stringify(data, null, 2));
            $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/api/stockouts',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function() {
                    console.log('[DEBUG] POST request initiated to /AgriculturalWarehouseManagementApplication/api/stockouts');
                },
                success: function(response) {
                    console.log('[DEBUG] Success response from /AgriculturalWarehouseManagementApplication/api/stockouts:', JSON.stringify(response, null, 2));
                    $.notify({ message: 'Tạo StockOut và StockOutDetails thành công!' }, { type: 'success', delay: 3000 });
                    setTimeout(() => {
                        stockOutModal.hide();
                        loadPendingOrders();
                    }, 500);
                    setTimeout(() => {
                        window.location.href = 'http://localhost:8080/AgriculturalWarehouseManagementApplication/warehouse/stockout';
                    }, 1000);
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Failed to create StockOut:', {
                        url: '/AgriculturalWarehouseManagementApplication/api/stockouts',
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText ? JSON.stringify(JSON.parse(xhr.responseText), null, 2) : 'No response body',
                        error: error
                    });
                    $.notify({ message: 'Lỗi khi tạo StockOut: ' + (xhr.responseJSON?.message || 'Vui lòng kiểm tra dữ liệu và thử lại.') }, { type: 'danger', delay: 3000 });
                }
            });
        });

        // Initialize
        console.log('[DEBUG] Starting initialization');
        loadWarehouses();
        loadPendingOrders();
    });
</script>

</body>
</html>