<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="BackEnd/fragments/WareHouse/head::head"></head>
<style>
  /* Ensure table is scrollable horizontally if content overflows */
  .table-responsive {
    overflow-x: auto;
    margin-bottom: 0; /* Remove extra margin to keep pagination close */
    position: relative; /* Context for scrollbar */
  }

  /* Ensure table takes full width but triggers scrollbar if needed */
  #table_id {
    width: 100%;
    min-width: 1000px; /* Force horizontal scrollbar for wide content */
  }

  /* Override gray borders from Bootstrap for table */
  #table_id.table,
  #table_id th,
  #table_id td {
    border-color: #e6f3f2 !important; /* Light green border */
  }

  /* Center pagination and style items */
  #pagination-controls {
    display: flex;
    justify-content: center; /* Center horizontally */
    align-items: center;
    margin-top: 12px; /* Ensure below scrollbar */
    margin-bottom: 20px; /* Space below pagination */
    position: relative; /* Ensure proper stacking */
    z-index: 10; /* Below footer and sidebar */
    max-width: 100%; /* Prevent overflow */
  }

  #pagination-controls .page-item {
    margin: 0 2.5px; /* 5px gap between items */
  }

  #pagination-controls .page-link {
    border-radius: 4px;
    padding: 6px 12px;
    color: #018F84; /* Text color for number pages */
    font-size: 14px; /* Match theme typography */
    cursor: pointer; /* Ensure clickable appearance */
    border: 1px solid #018F84; /* Border matches theme */
    background-color: transparent; /* Default background */
    text-align: center;
    box-sizing: border-box;
  }

  /* Style for Previous and Next buttons */
  #pagination-controls .page-item:first-child .page-link,
  #pagination-controls .page-item:last-child .page-link {
    background-color: #018F84; /* Green background */
    color: #fff; /* White text */
    border-color: #018F84;
  }

  /* Style for active page */
  #pagination-controls .page-item.active .page-link {
    background-color: #018F84; /* Green background */
    border-color: #018F84;
    color: #fff;
    box-shadow: none; /* No glowing effect */
  }

  /* Style for disabled buttons */
  #pagination-controls .page-item.disabled .page-link {
    color: #018F84; /* Green text */
    border-color: #e6f3f2; /* Light green border */
    background-color: #e6f3f2; /* Light green background */
    pointer-events: none;
    cursor: default;
  }

  /* Hover effect for non-disabled, non-active number pages */
  #pagination-controls .page-link:hover:not(.disabled .page-link):not(.active .page-link):not(:first-child .page-link):not(:last-child .page-link) {
    background-color: #e6f3f2; /* Light green on hover */
    color: #018F84;
  }

  /* Hover effect for Previous/Next when not disabled */
  #pagination-controls .page-item:not(.disabled):first-child .page-link:hover,
  #pagination-controls .page-item:not(.disabled):last-child .page-link:hover {
    background-color: #016f6a; /* Darker green on hover */
    color: #fff;
  }

  /* Ensure footer is above pagination but below sidebar */
  .footer {

    z-index: 20 !important; /* Above pagination */
  }

  /* Ensure sidebar is above footer and pagination */
  .sidebar-wrapper {
    position: fixed;
    z-index: 30 !important; /* Above footer and pagination */
  }

  /* Ensure modals and offcanvas are above sidebar, footer, and pagination */
  .modal,
  .offcanvas {
    z-index: 1050 !important; /* Above sidebar, footer, and pagination */
  }

  .modal-backdrop {
    z-index: 1040 !important; /* Below modal/offcanvas, above sidebar and footer */
  }

  /* Style for search bar and button */
  .btn-theme {
    background-color: #018F84;
    color: #fff;
    border-color: #018F84;
  }

  .btn-theme:hover {
    background-color: #016f6a;
    color: #fff;
    border-color: #016f6a;
  }

  .search-bar input {
    border: 1px solid #e6f3f2;
  }

  .search-bar input:focus {
    border-color: #018F84;
    box-shadow: 0 0 5px rgba(1, 143, 132, 0.3);
  }
</style>
<body>
<!-- tap on top start-->
<div class="tap-top">
  <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
  <!-- Page Header Start-->
  <div th:replace="BackEnd/fragments/WareHouse/header::header"></div>
  <!-- Page Header Ends-->

  <!-- Page Body Start-->
  <div class="page-body-wrapper">
    <!-- Page Sidebar Start-->
    <div th:replace="BackEnd/fragments/WareHouse/sidebar::sidebar"></div>
    <!-- Page Sidebar Ends-->

    <!-- StockIn section Start -->
    <div class="page-body">
      <!-- Table Start -->
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-12">
            <div class="card card-table">
              <div class="card-body">
                <div class="title-header option-title">
                  <!-- Dòng 1: chỉ StockIn List -->
                  <div class="first-line">
                    <h5>StockIn List</h5>
                  </div>

                  <!-- Dòng 2: Add new StockIn và Search bên phải -->
                  <div class="second-line" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                    <a th:href="@{/warehouse/addstockin}" class="align-items-center btn btn-theme d-flex">
                      <i data-feather="plus"></i> Add new StockIn
                    </a>
                    <div class="search-bar">
                      <input type="text" class="form-control" placeholder="Search..." id="searchInputStockIn">
                    </div>
                  </div>
                </div>
                <div>
                  <div class="table-responsive">
                    <table class="table all-package order-table theme-table" id="table_id">
                      <thead>
                      <tr>
                        <th>StockIn ID</th>
                        <th>Supplier</th>
                        <th>Warehouse</th>
                        <th>Date</th>
                        <th>Note</th>
                        <th>Option</th>
                      </tr>
                      </thead>
                      <tbody id="stockInTableBody">
                      <!-- Dữ liệu sẽ được tải động bằng JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <ul id="pagination-controls" class="pagination"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Table End -->

      <!-- Container-fluid Ends-->
      <div class="container-fluid">
        <!-- footer start-->
        <footer class="footer">
          <div class="row">
            <div class="col-md-12 footer-copyright text-center">
              <p class="mb-0">Copyright 2022 © Fastkart theme by pixelstrap</p>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <!-- StockIn section End -->
  </div>
  <!-- Page Body End-->
</div>
<!-- page-wrapper End -->

<!-- Modal start -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h5 class="modal-title" id="staticBackdropLabel">Logging Out</h5>
        <p>Are you sure you want to log out?</p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="button-box">
          <button type="button" class="btn btn--no" data-bs-dismiss="modal">No</button>
          <button type="button" th:onclick="|window.location='@{backend/login}'|" class="btn btn--yes btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal end -->

<!-- Delete Modal Box Start -->
<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header d-block text-center">
        <h4 class="modal-title w-100" id="exampleModalLabel22">Are You Sure?</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="remove-box">
          <p>Are you sure you want to delete this StockIn?</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">No</button>
        <button type="button" class="btn btn-animation btn-md fw-bold" id="confirmDeleteBtn">Yes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title text-center" id="exampleModalLabel12">Done!</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="remove-box text-center">
          <div class="wrapper">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
              <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
          </div>
          <h4 class="text-content">StockIn removed successfully.</h4>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Delete Modal Box End -->

<!-- Offcanvas Box Start -->
<div class="offcanvas offcanvas-end order-offcanvas" tabindex="-1" id="order-details"
     aria-labelledby="offcanvasExampleLabel" aria-expanded="false">
  <div class="offcanvas-header">
    <h4 class="offcanvas-title" id="offcanvasExampleLabel">StockIn #<span id="offcanvasStockInId"></span></h4>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <div class="order-date">
      <h6 id="offcanvasStockInDate"></h6>
    </div>

    <form id="updateStockInForm">
      <input type="hidden" id="offcanvasStockInIdInput" />
      <div class="mb-3">
        <label for="offcanvasSupplierId">Supplier</label>
        <select class="form-control" id="offcanvasSupplierId" name="supplierId">
          <option value="">Select Supplier</option>
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>
      <div class="mb-3">
        <label for="offcanvasWarehouseId">Warehouse</label>
        <select class="form-control" id="offcanvasWarehouseId" name="warehouseId">
          <option value="">Select Warehouse</option>
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>
      <div class="mb-3">
        <label for="offcanvasStockInDateInput">Date</label>
        <input type="date" class="form-control" id="offcanvasStockInDateInput" />
      </div>
      <div class="mb-3">
        <label for="offcanvasStockInTimeInput">Time</label>
        <input type="time" class="form-control" id="offcanvasStockInTimeInput" />
      </div>
      <div class="mb-3">
        <label for="offcanvasNote">Note</label>
        <input type="text" class="form-control" id="offcanvasNote" />
      </div>
      <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>
  </div>
</div>
<!-- Offcanvas Box End -->

<!-- Latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>
<script th:src="@{/Backend/assets/js/checkbox-all-check.js}"></script>

<!-- Custom JavaScript -->
<script>
  function formatDateToVietnamese(dateString) {
    if (!dateString || dateString === 'N/A') {
      return 'N/A';
    }
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        console.warn('[WARN] Invalid date:', dateString);
        return 'N/A';
      }
      // Add 7 hours to convert UTC to Vietnam time (UTC+07:00)
      const vnTime = new Date(date.getTime());
      const day = String(vnTime.getDate()).padStart(2, '0');
      const month = String(vnTime.getMonth() + 1).padStart(2, '0');
      const year = vnTime.getFullYear();
      const hours = String(vnTime.getHours()).padStart(2, '0');
      const minutes = String(vnTime.getMinutes()).padStart(2, '0');
      const seconds = String(vnTime.getSeconds()).padStart(2, '0');
      return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
    } catch (error) {
      console.error('[ERROR] Error parsing date:', dateString, error);
      return 'N/A';
    }
  }

  $(document).ready(function() {
    // Disable DataTables to prevent interference
    if ($.fn.DataTable && $.fn.DataTable.isDataTable('#table_id')) {
      $('#table_id').DataTable().destroy();
      console.log('DataTables disabled for #table_id');
    }

    let currentPage = 0; // 0-based internally
    let totalPages = 1; // Global variable to track total pages
    const pageSize = 5;

    // Debug pagination DOM
    function debugPagination() {
      const paginationItems = $('#pagination-controls .page-link');
      console.log('Pagination items:', paginationItems.length, 'HTML:', $('#pagination-controls').html() || 'Not found');
    }

    // Ensure table body and no-data row exist
    function ensureElements() {
      let tableBody = $('#stockInTableBody');
      let noDataRow = $('#no-data-row');

      if (!tableBody.length) {
        const table = $('#table_id');
        if (table.length) {
          tableBody = $('<tbody id="stockInTableBody"></tbody>');
          table.append(tableBody);
        } else {
          console.error('Table #table_id not found');
          return null;
        }
      }

      if (!noDataRow.length) {
        noDataRow = $('<tr id="no-data-row"><td colspan="6" class="text-center">No data available in table</td></tr>');
        tableBody.append(noDataRow);
      }

      return { tableBody, noDataRow };
    }

    // Update URL with page number (1-based)
    function updateURL(page) {
      history.pushState({}, '', `?page=${page + 1}`);
    }

    // Load Suppliers into dropdown
    function loadSuppliersDropdown(selectElement, selectedId) {
      $.ajax({
        url: 'http://localhost:8080/api/suppliers',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          selectElement.empty().append('<option value="">Select Supplier</option>');
          $.each(data, function(index, supplier) {
            const supplierId = supplier.supplierID || supplier.id;
            const supplierName = supplier.supplierName || supplier.name;
            if (supplierId && supplierName) {
              const selected = supplierId == selectedId ? 'selected' : '';
              selectElement.append(`<option value="${supplierId}" ${selected}>${supplierName} (ID: ${supplierId})</option>`);
            }
          });
        },
        error: function(xhr, status, error) {
          console.error('Error loading Suppliers:', status, error);
          selectElement.empty().append('<option value="">Error loading Suppliers</option>');
        }
      });
    }

    // Load Warehouses into dropdown
    function loadWarehousesDropdown(selectElement, selectedId) {
      $.ajax({
        url: 'http://localhost:8080/api/warehouses',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          selectElement.empty().append('<option value="">Select Warehouse</option>');
          $.each(data, function(index, warehouse) {
            const warehouseId = warehouse.warehouseId || warehouse.id;
            const warehouseName = warehouse.warehouseName || warehouse.name;
            if (warehouseId && warehouseName) {
              const selected = warehouseId == selectedId ? 'selected' : '';
              selectElement.append(`<option value="${warehouseId}" ${selected}>${warehouseName} (ID: ${warehouseId})</option>`);
            }
          });
        },
        error: function(xhr, status, error) {
          console.error('Error loading Warehouses:', status, error);
          selectElement.empty().append('<option value="">Error loading Warehouses</option>');
        }
      });
    }

    // Fetch StockIn data and populate table
    function fetchStockIns(page = 0, searchQuery = '') {
      currentPage = page;
      updateURL(page);
      const { tableBody, noDataRow } = ensureElements();
      if (!tableBody || !noDataRow) return;

      console.log('Fetching StockIns for page:', page, 'search:', searchQuery);

      let url = `http://localhost:8080/api/stockins/paginatedStockIn?page=${page}&size=${pageSize}`;
      if (searchQuery) {
        url += `&search=${encodeURIComponent(searchQuery)}`;
      }

      $.ajax({
        url: url,
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          console.log('API response:', data);
          if (!data || !data.content || typeof data.totalPages === 'undefined' || typeof data.number === 'undefined') {
            console.error('Invalid response data:', data);
            tableBody.empty();
            noDataRow.show();
            renderPagination(0, 0);
            debugPagination();
            return;
          }

          totalPages = data.totalPages;
          tableBody.empty();

          if (data.content && data.content.length > 0) {
            noDataRow.hide();
            $.each(data.content, function(index, stockIn) {
              // Validate supplierID and warehouseID
              const supplierId = stockIn.supplierID && typeof stockIn.supplierID === 'object' ? (stockIn.supplierID.supplierID || stockIn.supplierID.id) : stockIn.supplierID;
              const warehouseId = stockIn.warehouseID && typeof stockIn.warehouseID === 'object' ? (stockIn.warehouseID.warehouseId || stockIn.warehouseID.id) : stockIn.warehouseID;

              console.log('Processing stockIn ID:', stockIn.id, 'supplierID:', supplierId, 'warehouseID:', warehouseId);

              // Check if IDs are valid numbers
              if (!supplierId || !warehouseId || isNaN(parseInt(supplierId)) || isNaN(parseInt(warehouseId))) {
                console.warn('Invalid supplierID or warehouseID for stockIn:', JSON.stringify(stockIn));
                var row = $('<tr></tr>')
                        .attr('data-bs-toggle', 'offcanvas')
                        .attr('data-bs-target', '#order-details')
                        .attr('data-stockin-id', stockIn.id);
                row.append(`<td>${stockIn.id || 'N/A'}</td>`);
                row.append(`<td>N/A (Invalid Supplier ID: ${JSON.stringify(stockIn.supplierID)})</td>`);
                row.append(`<td>N/A (Invalid Warehouse ID: ${JSON.stringify(stockIn.warehouseID)})</td>`);
                row.append(`<td>${formatDateToVietnamese(stockIn.stockInDate)}</td>`);
                row.append(`<td>${stockIn.note || 'N/A'}</td>`);
                row.append(`
                  <td>
                    <ul>
                      <li><a href="/warehouse/stockindetail?stockInId=${stockIn.id}" class="view-detail"><i class="ri-eye-line"></i></a></li>
                      <li><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#order-details" data-stockin-id="${stockIn.id}" class="edit-link"><i class="ri-pencil-line"></i></a></li>
                      <li><a href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" data-stockin-id="${stockIn.id}"><i class="ri-delete-bin-line"></i></a></li>
                    </ul>
                  </td>
                `);
                tableBody.append(row);
                return;
              }

              // Fetch supplier and warehouse names
              $.when(
                      $.ajax({ url: `http://localhost:8080/api/suppliers/${supplierId}`, method: 'GET', dataType: 'json' }),
                      $.ajax({ url: `http://localhost:8080/api/warehouses/${warehouseId}`, method: 'GET', dataType: 'json' })
              ).done(function(supplierResponse, warehouseResponse) {
                var supplierName = supplierResponse[0].supplierName || 'N/A';
                var warehouseName = warehouseResponse[0].warehouseName || 'N/A';
                var row = $('<tr></tr>')
                        .attr('data-bs-toggle', 'offcanvas')
                        .attr('data-bs-target', '#order-details')
                        .attr('data-stockin-id', stockIn.id);
                row.append(`<td>${stockIn.id || 'N/A'}</td>`);
                row.append(`<td>${supplierName} (ID: ${supplierId})</td>`);
                row.append(`<td>${warehouseName} (ID: ${warehouseId})</td>`);
                row.append(`<td>${formatDateToVietnamese(stockIn.stockInDate)}</td>`);
                row.append(`<td>${stockIn.note || 'N/A'}</td>`);
                row.append(`
                  <td>
                    <ul>
                      <li><a href="/warehouse/stockindetail?stockInId=${stockIn.id}" class="view-detail"><i class="ri-eye-line"></i></a></li>
                      <li><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#order-details" data-stockin-id="${stockIn.id}" class="edit-link"><i class="ri-pencil-line"></i></a></li>
                      <li><a href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" data-stockin-id="${stockIn.id}"><i class="ri-delete-bin-line"></i></a></li>
                    </ul>
                  </td>
                `);
                tableBody.append(row);
              }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Error fetching supplier or warehouse:', textStatus, errorThrown, 'SupplierID:', supplierId, 'WarehouseID:', warehouseId);
                var row = $('<tr></tr>')
                        .attr('data-bs-toggle', 'offcanvas')
                        .attr('data-bs-target', '#order-details')
                        .attr('data-stockin-id', stockIn.id);
                row.append(`<td>${stockIn.id || 'N/A'}</td>`);
                row.append(`<td>N/A (Error fetching Supplier ID: ${supplierId})</td>`);
                row.append(`<td>N/A (Error fetching Warehouse ID: ${warehouseId})</td>`);
                row.append(`<td>${formatDateToVietnamese(stockIn.stockInDate)}</td>`);
                row.append(`<td>${stockIn.note || 'N/A'}</td>`);
                row.append(`
                  <td>
                    <ul>
                      <li><a href="/warehouse/stockindetail?stockInId=${stockIn.id}" class="view-detail"><i class="ri-eye-line"></i></a></li>
                      <li><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#order-details" data-stockin-id="${stockIn.id}" class="edit-link"><i class="ri-pencil-line"></i></a></li>
                      <li><a href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" data-stockin-id="${stockIn.id}"><i class="ri-delete-bin-line"></i></a></li>
                    </ul>
                  </td>
                `);
                tableBody.append(row);
              });
            });
          } else {
            noDataRow.show();
          }

          renderPagination(data.totalPages, data.number);
          debugPagination();
        },
        error: function(xhr, status, error) {
          console.error('Error fetching StockIns:', status, error, 'Response:', xhr.responseText);
          alert('Failed to load StockIns. Check console.');
          tableBody.empty();
          noDataRow.show();
          renderPagination(0, 0);
          debugPagination();
        }
      });
    }

    // Pagination rendering
    function renderPagination(totalPagesInput, currentPageInput) {
      const paginationControls = $('#pagination-controls');
      paginationControls.empty();

      totalPages = typeof totalPagesInput === 'number' && totalPagesInput > 0 ? totalPagesInput : 1;
      currentPage = typeof currentPageInput === 'number' && currentPageInput >= 0 && currentPageInput < totalPages ? currentPageInput : 0;

      console.log('Rendering pagination - totalPages:', totalPages, 'currentPage:', currentPage);

      const addBtn = (label, page, disabled = false, active = false) => {
        const li = $('<li></li>').addClass('page-item');
        if (disabled) li.addClass('disabled');
        if (active) li.addClass('active');
        li.html(`<a class="page-link" href="javascript:void(0)" data-page="${page}">${label}</a>`);
        paginationControls.append(li);
      };

      // Previous button
      addBtn('Previous', currentPage - 1, currentPage === 0);

      // Show up to 5 pages, centered around currentPage
      const maxPagesToShow = 5;
      let startPage = Math.max(0, currentPage - Math.floor(maxPagesToShow / 2));
      let endPage = Math.min(totalPages, startPage + maxPagesToShow);

      if (endPage - startPage < maxPagesToShow) {
        startPage = Math.max(0, endPage - maxPagesToShow);
      }

      if (startPage > 0) {
        addBtn(1, 0, false, currentPage === 0);
        if (startPage > 1) {
          paginationControls.append('<li class="page-item disabled"><a class="page-link">...</a></li>');
        }
      }

      for (let i = startPage; i < endPage; i++) {
        addBtn(i + 1, i, false, currentPage === i);
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationControls.append('<li class="page-item disabled"><a class="page-link">...</a></li>');
        }
        addBtn(totalPages, totalPages - 1, false, currentPage === totalPages - 1);
      }

      // Next button
      addBtn('Next', currentPage + 1, currentPage === totalPages - 1);

      // Bind click events
      paginationControls.off('click.pagination').on('click.pagination', '.page-link', function(e) {
        e.preventDefault();
        const page = parseInt($(this).data('page'));
        console.log('Pagination click - page:', page, 'totalPages:', totalPages);
        if (!isNaN(page) && page >= 0 && page < totalPages) {
          fetchStockIns(page, $('#searchInputStockIn').val());
        }
      });
    }

    // Load StockIn details into offcanvas
    $(document).on('show.bs.offcanvas', '#order-details', function(event) {
      var stockInId = $(event.relatedTarget).data('stockin-id');
      $('#offcanvasStockInId').text(stockInId);
      $('#offcanvasStockInIdInput').val(stockInId);

      $.ajax({
        url: `http://localhost:8080/api/stockins/${stockInId}`,
        method: 'GET',
        dataType: 'json',
        success: function(stockIn) {
          // Use validated supplierID and warehouseID
          const supplierId = stockIn.supplierID && typeof stockIn.supplierID === 'object' ? (stockIn.supplierID.supplierID || stockIn.supplierID.id) : stockIn.supplierID;
          const warehouseId = stockIn.warehouseID && typeof stockIn.warehouseID === 'object' ? (stockIn.warehouseID.warehouseId || stockIn.warehouseID.id) : stockIn.warehouseID;

          console.log('Loading offcanvas for stockIn ID:', stockInId, 'supplierID:', supplierId, 'warehouseID:', warehouseId);

          // Load dropdowns
          loadSuppliersDropdown($('#offcanvasSupplierId'), supplierId);
          loadWarehousesDropdown($('#offcanvasWarehouseId'), warehouseId);

          // Format stockInDate using formatDateToVietnamese
          const formattedDate = formatDateToVietnamese(stockIn.stockInDate);
          $('#offcanvasStockInDate').text(formattedDate || 'N/A');

          // Populate input fields for editing
          if (stockIn.stockInDate) {
            const date = new Date(stockIn.stockInDate);
            // Add 7 hours to convert UTC to Vietnam time
            const vnTime = new Date(date.getTime());
            const year = vnTime.getFullYear();
            const month = String(vnTime.getMonth() + 1).padStart(2, '0');
            const day = String(vnTime.getDate()).padStart(2, '0');
            const hours = String(vnTime.getHours()).padStart(2, '0');
            const minutes = String(vnTime.getMinutes()).padStart(2, '0');

            // Set date input as YYYY-MM-DD
            $('#offcanvasStockInDateInput').val(`${year}-${month}-${day}`);
            // Set time input as HH:mm
            $('#offcanvasStockInTimeInput').val(`${hours}:${minutes}`);
          } else {
            $('#offcanvasStockInDateInput').val('');
            $('#offcanvasStockInTimeInput').val('00:00');
          }

          $('#offcanvasNote').val(stockIn.note || '');
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error('Error loading StockIn details:', textStatus, errorThrown);
          alert('Failed to load StockIn details.');
        }
      });
    });

    // Update StockIn
    $('#updateStockInForm').on('submit', function(e) {
      e.preventDefault();
      var stockInId = $('#offcanvasStockInIdInput').val();
      var date = $('#offcanvasStockInDateInput').val(); // YYYY-MM-DD
      var time = $('#offcanvasStockInTimeInput').val(); // HH:mm

      // Combine date and time, convert to UTC for backend
      let stockInDate;
      if (date && time) {
        // Parse as Vietnam time (UTC+07:00)
        const [year, month, day] = date.split('-').map(Number);
        const [hours, minutes] = time.split(':').map(Number);
        const vnDate = new Date(year, month - 1, day, hours, minutes, 0);
        // Convert to UTC by subtracting 7 hours
        const utcDate = new Date(vnDate.getTime() + 7 * 60 * 60 * 1000);
        // Format as ISO UTC
        stockInDate = utcDate.toISOString(); // e.g., 2025-07-02T13:00:00.000Z
      } else {
        stockInDate = new Date().toISOString(); // Fallback to current UTC time
      }

      var formData = {
        id: stockInId,
        supplierID: $('#offcanvasSupplierId').val(),
        warehouseID: $('#offcanvasWarehouseId').val(),
        stockInDate: stockInDate,
        note: $('#offcanvasNote').val()
      };

      console.log('Submitting update for StockIn:', formData);

      $.ajax({
        url: `http://localhost:8080/api/stockins/${stockInId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
          alert('StockIn updated successfully!');
          $('#order-details').offcanvas('hide');
          $('.modal-backdrop').remove();
          $('body').removeClass('modal-open').css('overflow', '');
          fetchStockIns(currentPage, $('#searchInputStockIn').val());
        },
        error: function(xhr, status, error) {
          console.error('Error updating StockIn:', status, error);
          alert('Error updating StockIn: ' + (xhr.responseText || 'Unknown error'));
          $('.modal-backdrop').remove();
          $('body').removeClass('modal-open').css('overflow', '');
        }
      });
    });

    // Store StockIn ID for deletion
    $(document).on('click', '[data-bs-target="#exampleModalToggle"]', function() {
      var stockInId = $(this).data('stockin-id');
      $('#exampleModalToggle').data('stockin-id', stockInId);
    });

    // Delete StockIn
    $('#confirmDeleteBtn').on('click', function() {
      var stockInId = $('#exampleModalToggle').data('stockin-id');
      if (!stockInId) {
        console.error('No StockIn ID found for deletion.');
        alert('Error: No StockIn selected for deletion.');
        return;
      }

      $.ajax({
        url: `http://localhost:8080/api/stockins/${stockInId}`,
        method: 'DELETE',
        headers: { 'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') },
        success: function() {
          $('#exampleModalToggle').modal('hide');
          $('.modal-backdrop').remove();
          $('body').removeClass('modal-open').css('overflow', '');
          $('#exampleModalToggle2').modal('show').on('hidden.bs.modal', function() {
            $(this).off('hidden.bs.modal');
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('overflow', '');
            fetchStockIns(currentPage, $('#searchInputStockIn').val());
          });
        },
        error: function(xhr, status, error) {
          console.error('Error deleting StockIn:', status, error);
          alert('Failed to delete StockIn: ' + (xhr.responseText || 'Unknown error'));
          $('#exampleModalToggle').modal('hide');
          $('.modal-backdrop').remove();
          $('body').removeClass('modal-open').css('overflow', '');
        }
      });
    });

    // Search functionality
    $('#searchInputStockIn').on('input', function() {
      const searchQuery = $(this).val().trim();
      fetchStockIns(0, searchQuery); // Reset to page 0 on search
    });

    // Initial fetch with URL page parameter
    const urlParams = new URLSearchParams(window.location.search);
    const initialPage = parseInt(urlParams.get('page')) || 1;
    if (initialPage > 0) currentPage = initialPage - 1; // Convert 1-based URL to 0-based
    fetchStockIns(currentPage);
  });
</script>
</body>
</html>