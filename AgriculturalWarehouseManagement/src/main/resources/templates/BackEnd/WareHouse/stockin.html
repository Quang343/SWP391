<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="BackEnd/fragments/WareHouse/head::head"></head>

<body>
<!-- tap on top start-->
<div class="tap-top">
  <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
  <!-- Page Header Start-->
  <div th:replace="BackEnd/fragments/WareHouse/header::header"></div>
  <!-- Page Header Ends-->

  <!-- Page Body Start-->
  <div class="page-body-wrapper">
    <!-- Page Sidebar Start-->
    <div th:replace="BackEnd/fragments/WareHouse/sidebar::sidebar"></div>
    <!-- Page Sidebar Ends-->

    <!-- StockIn section Start -->
    <div class="page-body">
      <!-- Table Start -->
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-12">
            <div class="card card-table">
              <div class="card-body">
                <div class="title-header option-title">
                  <h5>StockIn List</h5>
                  <a th:href="@{/warehouse/addstockin}" class="btn btn-solid">Add news StockIn</a>
                </div>
                <div>
                  <div class="table-responsive">
                    <table class="table all-package order-table theme-table" id="table_id">
                      <thead>
                      <tr>
                        <th>StockIn ID</th>
                        <th>Supplier ID</th>
                        <th>Warehouse ID</th>
                        <th>Date</th>
                        <th>Note</th>
                        <th>Option</th>
                      </tr>
                      </thead>
                      <tbody id="stockInTableBody">
                      <!-- Dữ liệu sẽ được tải động bằng JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Table End -->
    </div>
    <!-- StockIn section End -->
  </div>
  <!-- Page Body End-->
</div>
<!-- page-wrapper End -->

<!-- Modal start -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h5 class="modal-title" id="staticBackdropLabel">Logging Out</h5>
        <p>Are you sure you want to log out?</p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="button-box">
          <button type="button" class="btn btn--no" data-bs-dismiss="modal">No</button>
          <button type="button" th:onclick="|window.location='@{backend/login}'|" class="btn btn--yes btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal end -->

<!-- Delete Modal Box Start -->
<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header d-block text-center">
        <h5 class="modal-title w-100" id="exampleModalLabel22">Are You Sure ?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="remove-box">
          <p>Are you sure you want to delete this StockIn?</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">No</button>
        <button type="button" class="btn btn-animation btn-md fw-bold" id="confirmDeleteBtn">Yes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-center" id="exampleModalLabel12">Done!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="remove-box text-center">
          <div class="wrapper">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
              <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
          </div>
          <h4 class="text-content">StockIn removed successfully.</h4>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Delete Modal Box End -->

<!-- Offcanvas Box Start -->
<div class="offcanvas offcanvas-end order-offcanvas" tabindex="-1" id="order-details"
     aria-labelledby="offcanvasExampleLabel" aria-expanded="false">
  <div class="offcanvas-header">
    <h4 class="offcanvas-title" id="offcanvasExampleLabel">StockIn #<span id="offcanvasStockInId"></span></h4>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <div class="order-date">
      <h6 id="offcanvasStockInDate"></h6>
      <a href="javascript:void(0)" class="d-block mt-1">Cancel StockIn</a>
    </div>

    <div class="accordion accordion-flush custome-accordion" id="accordionFlushExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="flush-headingOne">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
            Details
          </button>
        </h2>
        <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne"
             data-bs-parent="#accordionFlushExample">
          <div class="accordion-body">
            <p><strong>Supplier ID:</strong> <span id="offcanvasSupplierId"></span></p>
            <p><strong>Warehouse ID:</strong> <span id="offcanvasWarehouseId"></span></p>
            <p><strong>Note:</strong> <span id="offcanvasNote"></span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Offcanvas Box End -->

<!-- Latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>
<script th:src="@{/Backend/assets/js/checkbox-all-check.js}"></script>

<!-- Custom JavaScript -->
<script>
  $(document).ready(function() {
    // Load StockIn data
    function loadStockIns() {
      $.ajax({
        url: 'http://localhost:8080/api/stockins',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          var tbody = $('#stockInTableBody');
          tbody.empty();
          $.each(data, function(index, stockIn) {
            // Fetch Supplier and Warehouse names
            $.when(
                    $.ajax({ url: 'http://localhost:8080/api/suppliers/' + stockIn.supplierID, method: 'GET', dataType: 'json' }),
                    $.ajax({ url: 'http://localhost:8080/api/warehouses/' + stockIn.warehouseID, method: 'GET', dataType: 'json' })
            ).done(function(supplierResponse, warehouseResponse) {
              var supplierName = supplierResponse[0].supplierName || 'N/A';
              var warehouseName = warehouseResponse[0].warehouseName || 'N/A';
              var row = '<tr data-bs-toggle="offcanvas" data-bs-target="#order-details" data-stockin-id="' + stockIn.id + '">' +
                      '<td>' + stockIn.id + '</td>' +
                      '<td>' + supplierName + '</td>' +
                      '<td>' + warehouseName + '</td>' +
                      '<td>' + (stockIn.stockInDate ? new Date(stockIn.stockInDate).toLocaleDateString() : 'N/A') + '</td>' +
                      '<td>' + (stockIn.note || 'N/A') + '</td>' +
                      '<td>' +
                      '<ul>' +
                      '<li><a href="/stockindetail?stockInId=' + stockIn.id + '" class="view-detail"><i class="ri-eye-line"></i></a></li>' +
                      '<li><a href="javascript:void(0)"><i class="ri-pencil-line"></i></a></li>' +
                      '<li><a href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" data-stockin-id="' + stockIn.id + '"><i class="ri-delete-bin-line"></i></a></li>' +
                      '</ul>' +
                      '</td>' +
                      '</tr>';
              tbody.append(row);
            }).fail(function(jqXHR, textStatus, errorThrown) {
              console.error('Error fetching supplier or warehouse: ', textStatus, errorThrown);
              var row = '<tr data-bs-toggle="offcanvas" data-bs-target="#order-details" data-stockin-id="' + stockIn.id + '">' +
                      '<td>' + stockIn.id + '</td>' +
                      '<td>N/A</td>' +
                      '<td>N/A</td>' +
                      '<td>' + (stockIn.stockInDate ? new Date(stockIn.stockInDate).toLocaleDateString() : 'N/A') + '</td>' +
                      '<td>' + (stockIn.note || 'N/A') + '</td>' +
                      '<td>' +
                      '<ul>' +
                      '<li><a href="/stockindetail?stockInId=' + stockIn.id + '" class="view-detail"><i class="ri-eye-line"></i></a></li>' +
                      '<li><a href="javascript:void(0)"><i class="ri-pencil-line"></i></a></li>' +
                      '<li><a href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" data-stockin-id="' + stockIn.id + '"><i class="ri-delete-bin-line"></i></a></li>' +
                      '<li><a class="btn btn-sm btn-solid text-white" href="order-tracking.html">Tracking</a></li>' +
                      '</ul>' +
                      '</td>' +
                      '</tr>';
              tbody.append(row);
            });
          });
        },
        error: function(xhr, status, error) {
          console.error('Error loading StockIns: ', status, error);
          $('#stockInTableBody').html('<tr><td colspan="6">Failed to load data. Check console.</td></tr>');
        }
      });
    }

    // Load StockIn details and StockInDetails into offcanvas
    $(document).on('show.bs.offcanvas', '#order-details', function(event) {
      var stockInId = $(event.relatedTarget).data('stockin-id');
      $('#offcanvasStockInId').text(stockInId);
      $.when(
              $.ajax({ url: 'http://localhost:8080/api/stockins/' + stockInId, method: 'GET', dataType: 'json' }),
              $.ajax({ url: 'http://localhost:8080/api/stockindetails?stockInId=' + stockInId, method: 'GET', dataType: 'json' })
      ).done(function(stockInResponse, stockInDetailsResponse) {
        var stockIn = stockInResponse[0];
        var stockInDetails = stockInDetailsResponse[0];
        $('#offcanvasStockInDate').text(stockIn.stockInDate ? new Date(stockIn.stockInDate).toLocaleString() : 'N/A');
        $('#offcanvasSupplierName').text(stockIn.supplierID ? 'Loading...' : 'N/A');
        $('#offcanvasWarehouseName').text(stockIn.warehouseID ? 'Loading...' : 'N/A');
        $('#offcanvasNote').text(stockIn.note || 'N/A');

        // Fetch Supplier and Warehouse names
        $.when(
                $.ajax({ url: 'http://localhost:8080/api/suppliers/' + stockIn.supplierID, method: 'GET', dataType: 'json' }),
                $.ajax({ url: 'http://localhost:8080/api/warehouses/' + stockIn.warehouseID, method: 'GET', dataType: 'json' })
        ).done(function(supplierResponse, warehouseResponse) {
          $('#offcanvasSupplierName').text(supplierResponse[0].name || 'N/A');
          $('#offcanvasWarehouseName').text(warehouseResponse[0].name || 'N/A');
        }).fail(function(jqXHR, textStatus, errorThrown) {
          $('#offcanvasSupplierName').text('N/A');
          $('#offcanvasWarehouseName').text('N/A');
          console.error('Error fetching supplier or warehouse: ', textStatus, errorThrown);
        });

        // Load StockInDetails
        var detailTbody = $('#stockInDetailTable');
        detailTbody.empty();
        $.each(stockInDetails, function(index, detail) {
          var row = '<tr>' +
                  '<td>' + (detail.productDetailID || 'N/A') + '</td>' +
                  '<td>' + (detail.quantity || 'N/A') + '</td>' +
                  '<td>' + (detail.unitPrice || 'N/A') + '</td>' +
                  '<td>' + (detail.batchID || 'N/A') + '</td>' +
                  '</tr>';
          detailTbody.append(row);
        });
      }).fail(function(jqXHR, textStatus, errorThrown) {
        console.error('Error loading StockIn details: ', textStatus, errorThrown);
      });
    });

    // Delete StockIn
    $('#confirmDeleteBtn').on('click', function() {
      var stockInId = $('#exampleModalToggle').data('stockin-id');
      if (stockInId) {
        $.ajax({
          url: 'http://localhost:8080/api/stockins/' + stockInId,
          method: 'DELETE',
          success: function() {
            $('#exampleModalToggle').modal('hide');
            $('#exampleModalToggle2').modal('show');
            loadStockIns(); // Reload table after deletion
          },
          error: function(xhr, status, error) {
            console.error('Error deleting StockIn: ', status, error);
            alert('Failed to delete StockIn. Check console.');
          }
        });
      }
    });

    // Initialize table
    loadStockIns();
  });
</script>

</body>
</html>