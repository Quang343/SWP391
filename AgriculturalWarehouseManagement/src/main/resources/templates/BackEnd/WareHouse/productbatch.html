<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>
<style>
    /* Ensure table is scrollable horizontally if content overflows */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 0; /* Remove extra margin to keep pagination close */
        position: relative; /* Context for scrollbar */
    }

    /* Ensure table takes full width but triggers scrollbar if needed */
    #table_id {
        width: 100%;
        min-width: 1000px; /* Force horizontal scrollbar for wide content */
    }

    /* Center pagination and style items */
    #pagination-controls {
        display: flex;
        justify-content: center; /* Center horizontally */
        margin-top: 8px; /* Small gap below table/scrollbar */
        margin-bottom: 20px; /* Space below pagination */
        position: relative; /* Ensure no overlap */
        z-index: 1000; /* High z-index to prevent overlap */
    }

    #pagination-controls .page-item {
        margin: 0 2.5px; /* 5px gap between items (2.5px each side) */
    }

    #pagination-controls .page-link {
        border-radius: 4px;
        padding: 6px 12px;
        color: #333;
        font-size: 14px; /* Match theme typography */
        cursor: pointer; /* Ensure clickable appearance */
    }

    #pagination-controls .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: #fff;
    }

    #pagination-controls .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        cursor: default;
    }

    /* Ensure no modal backdrop overlap */
    .modal-backdrop {
        z-index: 900; /* Below pagination */
    }
</style>
<body>
<!-- tap on top start-->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body Start-->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="BackEnd/fragments/WareHouse/sidebar::sidebar"></div>
        <!-- Page Sidebar Ends-->

        <!-- Container-fluid starts-->
        <div class="page-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-table">
                            <div class="card-body">
                                <div class="title-header option-title d-sm-flex d-block">
                                    <h5>ProductBatchs List</h5>
                                    <div class="right-options">
                                        <ul>
                                            <li>
                                                <a class="btn btn-solid" th:href="@{/warehouse/addproductbatch}">Add Product Batch</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div>
                                    <div class="table-responsive">
                                        <table class="table all-package theme-table table-product" id="table_id">
                                            <thead>
                                            <tr>
                                                <th>Batch Id</th>
                                                <th>ProductDetail Id</th>
                                                <th>Manufacture Date</th>
                                                <th>Imported Quantity</th>
                                                <th>Sold Quantity</th>
                                                <th>Remaining Quantity</th>
                                                <th>Adjustment Total</th>
                                                <th>Action</th>
                                            </tr>
                                            </thead>
                                            <tbody id="productBatchTableBody">
                                            <!-- Dữ liệu sẽ được thêm động bởi JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Pagination Controls -->
                                    <ul id="pagination-controls" class="pagination"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Container-fluid Ends-->

            <div class="container-fluid">
                <!-- footer start-->
                <footer class="footer">
                    <div class="row">
                        <div class="col-md-12 footer-copyright text-center">
                            <p class="mb-0">Copyright 2022 © Fastkart theme by pixelstrap</p>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>
</div>
<!-- page-wrapper End-->

<!-- Modal Start -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Log Out</h5>
                <p>Are you sure you want to log out?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">No</button>
                    <button type="button" th:onclick="|window.location='@{backend/login}'|" class="btn btn--yes btn-primary">Yes</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<div class="modal fade" id="editProductBatchModal" tabindex="-1" aria-labelledby="editProductBatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductBatchModalLabel">Edit Product Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductBatchForm">
                    <input type="hidden" id="editBatchId">
                    <div class="mb-3">
                        <label for="editProductDetailId" class="form-label">Product Detail</label>
                        <select class="form-select" id="editProductDetailId" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="editManufactureDate" class="form-label">Manufacture Date</label>
                        <input type="date" class="form-control" id="editManufactureDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editImportedQuantity" class="form-label">Imported Quantity</label>
                        <input type="number" class="form-control" id="editImportedQuantity" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEditProductBatch">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal Box Start -->
<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header d-block text-center">
                <h5 class="modal-title w-100" id="exampleModalLabel22">Are You Sure?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box">
                    <p>Bạn có chắc chắn muốn xóa Product Batch này?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-animation btn-md fw-bold confirm-delete">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center" id="exampleModalLabel12">Done!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box text-center">
                    <div class="wrapper">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h4 class="text-content">It's Removed.</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Delete Modal Box End -->

<!-- Modal for Adjustment History -->
<div class="modal fade" id="adjustmentHistoryModal" tabindex="-1" aria-labelledby="adjustmentHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adjustmentHistoryModalLabel">Lịch Sử Nhập Hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table" id="adjustmentHistoryTable">
                    <tbody id="adjustmentHistoryBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="adjustmentDetailModal" tabindex="-1" aria-labelledby="adjustmentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 90%; width: fit-content; min-width: 300px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adjustmentDetailModalLabel">Chi tiết điều chỉnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-x: auto; overflow-y: auto; max-height: 70vh;">
                <table class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        <th style="white-space: nowrap;">ID</th>
                        <th style="white-space: nowrap;">Quantity</th>
                        <th style="white-space: nowrap;">Reason</th>
                        <th style="white-space: nowrap;">Adjust Date</th>
                        <th style="white-space: nowrap;">Type</th>
                    </tr>
                    </thead>
                    <tbody id="adjustmentDetailBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal cho Product Detail -->
<div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailModalLabel">Chi tiết ProductDetail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Tên chi tiết:</strong> <span id="modalDetailName">N/A</span></p>
                <p><strong>Product ID:</strong> <span id="modalProductId">N/A</span></p>
                <p><strong>Giá:</strong> <span id="modalPrice">N/A</span></p>
                <p><strong>Khối lượng:</strong> <span id="modalWeight">N/A</span></p>
                <p><strong>Thời hạn sử dụng (tháng):</strong> <span id="modalExpiry">N/A</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Add Adjustment -->
<div class="modal fade" id="addAdjustmentModal" tabindex="-1" aria-labelledby="addAdjustmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAdjustmentModalLabel">Thêm Điều Chỉnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAdjustmentForm">
                    <input type="hidden" id="addAdjustmentBatchId">
                    <div class="mb-3">
                        <label for="addQuantity" class="form-label">Số lượng</label>
                        <input type="number" class="form-control" id="addQuantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="addReason" class="form-label">Lý do</label>
                        <input type="text" class="form-control" id="addReason">
                    </div>
                    <div class="mb-3">
                        <label for="addAdjustmentType" class="form-label">Loại điều chỉnh</label>
                        <select class="form-select" id="addAdjustmentType" required>
                            <option value="">Chọn loại</option>
                            <option value="Add">Thêm</option>
                            <option value="Remove">Trừ</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="saveAddAdjustment">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>

<!-- Bootstrap js -->
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>

<!-- feather icon js -->
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>

<!-- scrollbar simplebar js -->
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>

<!-- Sidebar js -->
<script th:src="@{/Backend/assets/js/config.js}"></script>

<!-- customizer js -->
<script th:src="@{/Backend/assets/js/customizer.js}"></script>

<!-- Plugins js -->
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>

<!-- Data table js -->
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>

<!-- sidebar effect -->
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>

<!-- Theme js -->
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom JS for API call -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Disable DataTables to prevent interference
        const table = document.querySelector('#table_id');
        if (window.jQuery && jQuery.fn.DataTable && jQuery.fn.DataTable.isDataTable('#table_id')) {
            jQuery('#table_id').DataTable().destroy();
            console.log('DataTables disabled for #table_id');
        }

        let currentPage = 0; // 0-based internally
        let totalPages = 1; // Global variable to track total pages
        const pageSize = 8;

        // Ensure table body and no-data row exist
        function ensureElements() {
            let tableBody = document.querySelector('#productBatchTableBody');
            let noDataRow = document.querySelector('#no-data-row');

            if (!tableBody) {
                const table = document.querySelector('#table_id');
                if (table) {
                    tableBody = document.createElement('tbody');
                    tableBody.id = 'productBatchTableBody';
                    table.appendChild(tableBody);
                } else {
                    console.error('Table #table_id not found');
                    return null;
                }
            }

            if (!noDataRow) {
                noDataRow = document.createElement('tr');
                noDataRow.id = 'no-data-row';
                noDataRow.innerHTML = '<td colspan="8" class="text-center">No data available in table</td>';
                tableBody.appendChild(noDataRow);
            }

            return { tableBody, noDataRow };
        }

        // Update URL with page number (1-based)
        function updateURL(page) {
            history.pushState({}, '', `?page=${page + 1}`);
        }

        // Populate ProductDetail dropdown for edit modal
        function populateProductDetailDropdown(selectElement, selectedId) {
            fetch('/api/product-details')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    selectElement.innerHTML = '<option value="" disabled selected>Chọn Product Detail</option>';
                    if (!data || data.length === 0) {
                        selectElement.innerHTML += '<option value="" disabled>Không có Product Detail</option>';
                        selectElement.disabled = true;
                        return;
                    }
                    data.forEach(detail => {
                        const id = detail.productDetailID || detail.id;
                        if (id) {
                            const selected = id == selectedId ? 'selected' : '';
                            selectElement.innerHTML += `<option value="${id}" ${selected}>${detail.detailName || 'Không có tên'} (ID: ${id})</option>`;
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching Product Details:', error);
                    alert('Không thể tải danh sách Product Detail. Kiểm tra console.');
                });
        }

        // Calculate adjustment totals and details
        async function getAdjustmentData() {
            try {
                const response = await fetch('/api/adjustments');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const adjustments = await response.json();
                const adjustmentTotals = {};
                const adjustmentDetails = {};
                const adjustmentCounts = {};

                adjustments.forEach(adj => {
                    const batchId = adj.batchId || adj.batch;
                    if (batchId) {
                        const quantity = parseInt(adj.quantity) || 0;
                        if (adj.adjustmentType === 'Add') {
                            adjustmentTotals[batchId] = (adjustmentTotals[batchId] || 0) + quantity;
                        } else if (adj.adjustmentType === 'Remove') {
                            adjustmentTotals[batchId] = (adjustmentTotals[batchId] || 0) - quantity;
                        }
                        adjustmentDetails[batchId] = adjustmentDetails[batchId] || [];
                        adjustmentDetails[batchId].push(adj);
                        adjustmentCounts[batchId] = (adjustmentCounts[batchId] || 0) + 1;
                    }
                });

                return { adjustmentTotals, adjustmentDetails, adjustmentCounts };
            } catch (error) {
                console.error('Error fetching adjustments:', error);
                return { adjustmentTotals: {}, adjustmentDetails: {}, adjustmentCounts: {} };
            }
        }

        // Fetch ProductBatch data and populate table
        async function fetchProductBatches(page = 0) {
            currentPage = page;
            updateURL(page);
            const { tableBody, noDataRow } = ensureElements();
            if (!tableBody || !noDataRow) return;

            console.log('Fetching product batches for page:', page);

            try {
                const response = await fetch(`/api/product-batches/paginatedProductBatches?page=${page}&size=${pageSize}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();

                console.log('API response:', data);

                if (!data || !data.content || typeof data.totalPages === 'undefined' || typeof data.number === 'undefined') {
                    console.error('Invalid response data:', data);
                    tableBody.innerHTML = '';
                    noDataRow.style.display = '';
                    renderPagination(0, 0);
                    return;
                }

                totalPages = data.totalPages; // Update global totalPages
                tableBody.innerHTML = '';
                const { adjustmentTotals, adjustmentDetails, adjustmentCounts } = await getAdjustmentData();

                if (data.content && data.content.length > 0) {
                    noDataRow.style.display = 'none';

                    for (const batch of data.content) {
                        const row = document.createElement('tr');
                        row.setAttribute('data-id', batch.batchID);

                        const importedQuantity = parseInt(batch.importedQuantity) || 0;
                        const soldQuantity = parseInt(batch.soldQuantity) || 0;
                        const totalAdjustment = adjustmentTotals[batch.batchID] || 0;
                        const remainingQuantity = importedQuantity - soldQuantity + totalAdjustment;
                        const adjustmentCount = adjustmentCounts[batch.batchID] || 0;

                        const addAdjustmentTotal = adjustmentDetails[batch.batchID]
                            ? adjustmentDetails[batch.batchID]
                                .filter(adj => adj.adjustmentType === 'Add')
                                .reduce((sum, adj) => sum + (parseInt(adj.quantity) || 0), 0)
                            : 0;

                        let stockInQuantity = 0;
                        let shortageAlert = '';
                        try {
                            const stockInResponse = await fetch(`/api/stockindetails/quantity/${batch.batchID}`);
                            if (stockInResponse.ok) {
                                const stockInDetails = await stockInResponse.json();
                                if (stockInDetails && Array.isArray(stockInDetails)) {
                                    stockInQuantity = stockInDetails.reduce((sum, detail) => sum + (parseInt(detail.quantity) || 0), 0);
                                }
                            }
                        } catch (error) {
                            console.error(`Error fetching StockInDetails for batchID ${batch.batchID}:`, error);
                        }

                        const temporaryImported = importedQuantity + addAdjustmentTotal;
                        if (importedQuantity < stockInQuantity) {
                            const shortage = stockInQuantity - importedQuantity;
                            if (temporaryImported >= stockInQuantity && addAdjustmentTotal > 0) {
                                shortageAlert = `<a href="javascript:void(0)" class="view-adjustment-history" data-batch-id="${batch.batchID}" data-imported="${importedQuantity}"><i class="ri-history-line" style="vertical-align: middle;"></i></a>`;
                            } else {
                                shortageAlert = `<a href="javascript:void(0)" class="shortage-alert" data-shortage="${shortage}" title="Thiếu ${shortage} đơn vị"><i class="ri-alert-line" style="color: red; vertical-align: middle;"></i></a>`;
                            }
                        } else if (temporaryImported >= stockInQuantity && addAdjustmentTotal > 0) {
                            shortageAlert = `<a href="javascript:void(0)" class="view-adjustment-history" data-batch-id="${batch.batchID}" data-imported="${importedQuantity}"><i class="ri-history-line" style="vertical-align: middle;"></i></a>`;
                        }

                        let expiry = 'N/A';
                        try {
                            const detailResponse = await fetch(`/api/product-details/${batch.productDetailID}`);
                            if (detailResponse.ok) {
                                const detail = await detailResponse.json();
                                expiry = detail.expiry || 'N/A';
                            }
                        } catch (error) {
                            console.error(`Error fetching Product Detail for ID ${batch.productDetailID}:`, error);
                        }

                        let percentageUsed = null;
                        if (batch.manufactureDate && expiry !== 'N/A' && !isNaN(parseInt(expiry))) {
                            const manufactureDate = new Date(batch.manufactureDate);
                            const expiryDate = new Date(manufactureDate);
                            expiryDate.setMonth(expiryDate.getMonth() + parseInt(expiry));
                            const today = new Date();
                            const totalTime = expiryDate - manufactureDate;
                            const usedTime = today - manufactureDate;
                            percentageUsed = (usedTime / totalTime) * 100;
                        }

                        if (percentageUsed !== null) {
                            if (percentageUsed >= 100) {
                                row.classList.add('table-danger');
                            } else if (percentageUsed >= 70) {
                                row.style.backgroundColor = '#ffca2c';
                            } else if (percentageUsed >= 50) {
                                row.classList.add('table-warning');
                            }
                        }

                        row.innerHTML = `
                            <td>${batch.batchID || 'N/A'}</td>
                            <td><a href="javascript:void(0)" class="detail-link" data-id="${batch.productDetailID}">${batch.productDetailID || 'N/A'}</a></td>
                            <td>${batch.manufactureDate || 'N/A'}</td>
                            <td>${temporaryImported || importedQuantity || 'N/A'}${shortageAlert}</td>
                            <td>${soldQuantity || 0}</td>
                            <td>${remainingQuantity}</td>
                            <td>${adjustmentCount > 0 ? `<a href="javascript:void(0)" class="view-adjustment-detail" data-batch-id="${batch.batchID}">${totalAdjustment}</a>` : `<span style="pointer-events: none; opacity: 0.5;">${totalAdjustment}</span>`}</td>
                            <td>
                                <ul class="action-list">
                                    <li><a href="javascript:void(0)" class="view-detail" data-id="${batch.productDetailID}"><i class="ri-eye-line"></i></a></li>
                                    <li><a href="javascript:void(0)" class="edit-batch" data-batch-id="${batch.batchID}" data-product-detail-id="${batch.productDetailID}" data-manufacture-date="${batch.manufactureDate || ''}" data-imported-quantity="${importedQuantity || ''}"><i class="ri-pencil-line"></i></a></li>
                                    <li><a href="javascript:void(0)" class="delete-batch" data-batch-id="${batch.batchID}"><i class="ri-delete-bin-line"></i></a></li>
                                    <li><a href="javascript:void(0)" class="add-adjustment" data-batch-id="${batch.batchID}"><i class="ri-add-line"></i></a></li>
                                </ul>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    }
                } else {
                    noDataRow.style.display = '';
                }

                renderPagination(data.totalPages, data.number);
                debugPagination();
            } catch (error) {
                console.error('Error fetching Product Batches:', error);
                alert('Lỗi khi tải dữ liệu. Kiểm tra console.');
                tableBody.innerHTML = '';
                noDataRow.style.display = '';
                renderPagination(0, 0);
                debugPagination();
            }
        }

        // Debug pagination DOM
        function debugPagination() {
            const paginationItems = document.querySelectorAll('#pagination-controls .page-link');
            console.log('Pagination items:', paginationItems.length, 'HTML:', document.querySelector('#pagination-controls').innerHTML);
        }

        // Pagination rendering
        function renderPagination(totalPagesInput, currentPageInput) {
            let paginationControls = document.querySelector('#pagination-controls');
            if (!paginationControls) {
                paginationControls = document.createElement('ul');
                paginationControls.id = 'pagination-controls';
                paginationControls.className = 'pagination';
                const tableResponsive = document.querySelector('.table-responsive');
                if (tableResponsive) {
                    tableResponsive.parentNode.insertBefore(paginationControls, tableResponsive.nextSibling);
                }
            }
            paginationControls.innerHTML = '';

            totalPages = typeof totalPagesInput === 'number' && totalPagesInput > 0 ? totalPagesInput : 1;
            currentPage = typeof currentPageInput === 'number' && currentPageInput >= 0 && currentPageInput < totalPages ? currentPageInput : 0;

            console.log('Rendering pagination - totalPages:', totalPages, 'currentPage:', currentPage);

            const addBtn = (label, page, disabled = false, active = false) => {
                const li = document.createElement('li');
                li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="javascript:void(0)" data-page="${page}">${label}</a>`;
                paginationControls.appendChild(li);
            };

            // Previous button
            addBtn('Previous', currentPage - 1, currentPage === 0);

            // Show up to 5 pages, centered around currentPage
            const maxPagesToShow = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow);

            if (endPage - startPage < maxPagesToShow) {
                startPage = Math.max(0, endPage - maxPagesToShow);
            }

            if (startPage > 0) {
                addBtn(1, 0, false, currentPage === 0);
                if (startPage > 1) {
                    const ellipsis = document.createElement('li');
                    ellipsis.className = 'page-item disabled';
                    ellipsis.innerHTML = '<a class="page-link">...</a>';
                    paginationControls.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i < endPage; i++) {
                addBtn(i + 1, i, false, currentPage === i);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('li');
                    ellipsis.className = 'page-item disabled';
                    ellipsis.innerHTML = '<a class="page-link">...</a>';
                    paginationControls.appendChild(ellipsis);
                }
                addBtn(totalPages, totalPages - 1, false, currentPage === totalPages - 1);
            }

            // Next button
            addBtn('Next', currentPage + 1, currentPage === totalPages - 1);

            // Bind click events
            paginationControls.onclick = (e) => {
                const target = e.target.closest('.page-link');
                if (!target) return;
                const page = parseInt(target.getAttribute('data-page'));
                console.log('Pagination click - page:', page, 'totalPages:', totalPages);
                if (!isNaN(page) && page >= 0 && page < totalPages) {
                    fetchProductBatches(page);
                }
            };
        }

        // Event listeners for modals and actions
        document.addEventListener('click', function (event) {
            const editBtn = event.target.closest('.edit-batch');
            const deleteBtn = event.target.closest('.delete-batch');
            const viewDetailBtn = event.target.closest('.view-detail');
            const addAdjustmentBtn = event.target.closest('.add-adjustment');
            const shortageAlertBtn = event.target.closest('.shortage-alert');
            const adjustmentDetailBtn = event.target.closest('.view-adjustment-detail');
            const adjustmentHistoryBtn = event.target.closest('.view-adjustment-history');

            if (editBtn) {
                const batchId = editBtn.getAttribute('data-batch-id');
                const productDetailId = editBtn.getAttribute('data-product-detail-id');
                const manufactureDate = editBtn.getAttribute('data-manufacture-date');
                const importedQuantity = editBtn.getAttribute('data-imported-quantity');

                if (!batchId) {
                    alert('Batch ID không hợp lệ.');
                    return;
                }

                document.getElementById('editBatchId').value = batchId;
                document.getElementById('editManufactureDate').value = manufactureDate;
                document.getElementById('editImportedQuantity').value = importedQuantity;
                const selectElement = document.getElementById('editProductDetailId');
                populateProductDetailDropdown(selectElement, productDetailId);
                new bootstrap.Modal(document.getElementById('editProductBatchModal')).show();
            }

            if (deleteBtn) {
                const batchId = deleteBtn.getAttribute('data-batch-id');
                if (!batchId) {
                    alert('Batch ID không hợp lệ.');
                    return;
                }
                const modal = document.getElementById('exampleModalToggle');
                if (modal) {
                    modal.setAttribute('data-batch-id', batchId);
                    new bootstrap.Modal(modal).show();
                } else {
                    alert('Không tìm thấy modal xác nhận xóa.');
                }
            }

            if (viewDetailBtn) {
                const productDetailId = viewDetailBtn.getAttribute('data-id');
                if (productDetailId === 'N/A') {
                    alert('Không có ProductDetail để hiển thị.');
                    return;
                }
                fetch(`/api/product-details/${productDetailId}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(detail => {
                        document.getElementById('modalDetailName').textContent = detail.detailName || 'N/A';
                        document.getElementById('modalProductId').textContent = detail.productID || 'N/A';
                        document.getElementById('modalPrice').textContent = detail.price ? detail.price.toFixed(2) : 'N/A';
                        document.getElementById('modalWeight').textContent = detail.categoryWeight || 'N/A';
                        document.getElementById('modalExpiry').textContent = detail.expiry || 'N/A';

                        if (detail.categoryWeight) {
                            fetch(`/api/categoryweights/${detail.categoryWeight}`)
                                .then(res => res.ok ? res.json() : Promise.reject())
                                .then(categoryWeight => {
                                    document.getElementById('modalWeight').textContent = categoryWeight.unit ? `${detail.categoryWeight} ${categoryWeight.unit}` : detail.categoryWeight;
                                })
                                .catch(() => {});
                        }

                        new bootstrap.Modal(document.getElementById('productDetailModal')).show();
                    })
                    .catch(error => {
                        console.error('Error fetching Product Detail:', error);
                        alert('Không thể tải chi tiết sản phẩm. Kiểm tra console.');
                    });
            }

            if (addAdjustmentBtn) {
                const batchId = addAdjustmentBtn.getAttribute('data-batch-id');
                if (!batchId || batchId === 'N/A') {
                    alert('Batch ID không hợp lệ.');
                    return;
                }
                document.getElementById('addAdjustmentBatchId').value = batchId;
                document.getElementById('addQuantity').value = '';
                document.getElementById('addReason').value = '';
                document.getElementById('addAdjustmentType').value = '';
                new bootstrap.Modal(document.getElementById('addAdjustmentModal')).show();
            }

            if (shortageAlertBtn) {
                const shortage = shortageAlertBtn.getAttribute('data-shortage');
                alert(`Thiếu ${shortage} đơn vị. Vui lòng yêu cầu nhập thêm hàng.`);
            }

            if (adjustmentDetailBtn) {
                const batchId = adjustmentDetailBtn.getAttribute('data-batch-id');
                if (!batchId || batchId === 'N/A') {
                    alert('Batch ID không hợp lệ hoặc không tồn tại.');
                    return;
                }
                fetch(`/api/product-batches/adjustments?batchId=${batchId}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(response => {
                        const tbody = document.getElementById('adjustmentDetailBody');
                        tbody.innerHTML = '';

                        if (!response || !response.adjustments || response.adjustments.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="5">Không có điều chỉnh cho batchId: ${batchId}</td></tr>`;
                        } else {
                            response.adjustments.forEach(adj => {
                                const id = adj.id ?? 'N/A';
                                const quantity = adj.quantity ?? 'N/A';
                                const adjustDate = adj.adjustDate ?? 'N/A';
                                const adjustmentType = adj.adjustmentType ?? 'N/A';
                                const reason = adj.reason ?? 'N/A';
                                const displayQuantity = adjustmentType === 'Remove' && quantity !== 'N/A' ? `-${quantity}` : quantity;

                                tbody.innerHTML += `
                                    <tr>
                                        <td>${id}</td>
                                        <td>${displayQuantity}</td>
                                        <td>${reason}</td>
                                        <td>${adjustDate}</td>
                                        <td>${adjustmentType}</td>
                                    </tr>
                                `;
                            });
                        }
                        new bootstrap.Modal(document.getElementById('adjustmentDetailModal')).show();
                    })
                    .catch(error => {
                        console.error('Error fetching adjustment details:', error);
                        alert('Không thể tải chi tiết điều chỉnh. Kiểm tra console.');
                    });
            }

            if (adjustmentHistoryBtn) {
                const batchId = adjustmentHistoryBtn.getAttribute('data-batch-id');
                const imported = adjustmentHistoryBtn.getAttribute('data-imported');
                if (!batchId || batchId === 'N/A') {
                    alert('Batch ID không hợp lệ hoặc không tồn tại.');
                    return;
                }
                fetch(`/api/product-batches/adjustments?batchId=${batchId}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(response => {
                        const tbody = document.getElementById('adjustmentHistoryBody');
                        tbody.innerHTML = '';

                        if (!response || !response.adjustments || response.adjustments.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="2">Không có điều chỉnh cho batchId: ${batchId}</td></tr>`;
                        } else {
                            const adjustments = response.adjustments
                                .filter(adj => adj.adjustmentType === 'Add')
                                .sort((a, b) => new Date(b.adjustDate) - new Date(a.adjustDate));
                            tbody.innerHTML = `<tr><td>Số lượng nhập lần 1:</td><td>${imported}</td></tr>`;
                            adjustments.forEach((adj, index) => {
                                const quantity = adj.quantity ?? 'N/A';
                                const adjustDate = adj.adjustDate ?? 'N/A';
                                tbody.innerHTML += `<tr><td>Số lượng nhập lần ${index + 2} (${adjustDate}):</td><td>${quantity}</td></tr>`;
                            });
                        }
                        new bootstrap.Modal(document.getElementById('adjustmentHistoryModal')).show();
                    })
                    .catch(error => {
                        console.error('Error fetching adjustment history:', error);
                        alert('Không thể tải lịch sử điều chỉnh. Kiểm tra console.');
                    });
            }
        });

        // Save edit product batch
        const saveEditBtn = document.getElementById('saveEditProductBatch');
        if (saveEditBtn) {
            saveEditBtn.addEventListener('click', () => {
                const batchId = document.getElementById('editBatchId').value;
                const productDetailId = document.getElementById('editProductDetailId').value;
                const manufactureDate = document.getElementById('editManufactureDate').value;
                const importedQuantity = document.getElementById('editImportedQuantity').value;

                if (!productDetailId || isNaN(parseInt(productDetailId))) {
                    alert('Vui lòng chọn một Product Detail hợp lệ.');
                    return;
                }
                if (!manufactureDate) {
                    alert('Vui lòng chọn ngày sản xuất.');
                    return;
                }
                if (!importedQuantity || isNaN(parseInt(importedQuantity)) || parseInt(importedQuantity) < 1) {
                    alert('Vui lòng nhập số lượng nhập hợp lệ (tối thiểu 1).');
                    return;
                }

                const formData = {
                    productDetailID: parseInt(productDetailId),
                    manufactureDate,
                    importedQuantity: parseInt(importedQuantity)
                };

                fetch(`/api/product-batches/${batchId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw err; });
                        alert('Cập nhật ProductBatch thành công!');
                        bootstrap.Modal.getInstance(document.getElementById('editProductBatchModal')).hide();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        fetchProductBatches(currentPage);
                    })
                    .catch(error => {
                        console.error('Error updating ProductBatch:', error);
                        alert(error.message || 'Lỗi khi sửa ProductBatch. Kiểm tra console.');
                        bootstrap.Modal.getInstance(document.getElementById('editProductBatchModal')).hide();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                    });
            });
        }

        // Confirm delete product batch
        const confirmDeleteBtn = document.querySelector('.confirm-delete');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                const modal = document.getElementById('exampleModalToggle');
                const batchId = modal.getAttribute('data-batch-id');

                if (!batchId) {
                    alert('Batch ID không hợp lệ.');
                    return;
                }

                fetch(`/api/product-batches/${batchId}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content }
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to delete ProductBatch');
                        bootstrap.Modal.getInstance(modal).hide();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        const doneModal = new bootstrap.Modal(document.getElementById('exampleModalToggle2'));
                        doneModal.show();
                        doneModal._element.addEventListener('hidden.bs.modal', () => {
                            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                            if (!document.querySelector('#productBatchTableBody tr')) {
                                document.getElementById('no-data-row').style.display = '';
                            }
                            fetchProductBatches(currentPage);
                        }, { once: true });
                    })
                    .catch(error => {
                        console.error('Error deleting ProductBatch:', error);
                        alert('Lỗi khi xóa ProductBatch. Kiểm tra console.');
                        bootstrap.Modal.getInstance(modal).hide();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                    });
            });
        }

        // Save new adjustment
        const saveAdjustmentBtn = document.getElementById('saveAddAdjustment');
        if (saveAdjustmentBtn) {
            saveAdjustmentBtn.addEventListener('click', () => {
                const batchId = document.getElementById('addAdjustmentBatchId').value;
                const quantity = document.getElementById('addQuantity').value;
                const reason = document.getElementById('addReason').value;
                const adjustmentType = document.getElementById('addAdjustmentType').value;

                if (!batchId || isNaN(parseInt(batchId))) {
                    alert('Batch ID không hợp lệ.');
                    return;
                }
                if (!quantity || isNaN(parseInt(quantity))) {
                    alert('Vui lòng nhập số lượng hợp lệ.');
                    return;
                }
                if (!adjustmentType) {
                    alert('Vui lòng chọn loại điều chỉnh.');
                    return;
                }

                const parsedQuantity = parseInt(quantity);
                if (parsedQuantity > 0 && adjustmentType !== 'Add') {
                    alert('Số lượng lớn hơn 0 phải có loại điều chỉnh là "Thêm".');
                    return;
                }
                if (parsedQuantity < 0 && adjustmentType !== 'Remove') {
                    alert('Số lượng nhỏ hơn 0 phải có loại điều chỉnh là "Trừ".');
                    return;
                }
                if (parsedQuantity === 0) {
                    alert('Số lượng không được bằng 0.');
                    return;
                }

                const formData = {
                    batchId: parseInt(batchId),
                    quantity: Math.abs(parsedQuantity),
                    adjustmentType,
                    reason: reason || null
                };

                fetch('/api/adjustments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw err; });
                        alert('Thêm điều chỉnh thành công!');
                        bootstrap.Modal.getInstance(document.getElementById('addAdjustmentModal')).hide();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        fetchProductBatches(currentPage);
                    })
                    .catch(error => {
                        console.error('Error adding adjustment:', error);
                        alert(error.message || 'Lỗi khi thêm điều chỉnh. Kiểm tra console.');
                        bootstrap.Modal.getInstance(document.getElementById('addAdjustmentModal')).hide();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                    });
            });
        }

        // Initial fetch with URL page parameter
        const urlParams = new URLSearchParams(window.location.search);
        const initialPage = parseInt(urlParams.get('page')) || 1;
        if (initialPage > 0) currentPage = initialPage - 1; // Convert 1-based URL to 0-based
        fetchProductBatches(currentPage);
    });
</script>

</body>
</html>