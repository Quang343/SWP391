<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start-->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body Start-->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="BackEnd/fragments/WareHouse/sidebar::sidebar"></div>
        <!-- Page Sidebar Ends-->

        <!-- Container-fluid starts-->
        <div class="page-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-table">
                            <div class="card-body">
                                <div class="title-header option-title d-sm-flex d-block">
                                    <h5>ProductBatchs List</h5>
                                    <div class="right-options">
                                        <ul>
                                            <li>
                                                <a class="btn btn-solid" th:href="@{/warehouse/addproductbatch}">Add Product Batch</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div>
                                    <div class="table-responsive">
                                        <table class="table all-package theme-table table-product" id="table_id">
                                            <thead>
                                            <tr>
                                                <th>Batch Id</th>
                                                <th>ProductDetail Id</th>
                                                <th>Manufacture Date</th>
                                                <th>Imported Quantity</th>
                                                <th>Sold Quantity</th>
                                                <th>Remaining Quantity</th>
                                                <th>Adjustment Total</th>
                                                <th>Action</th>
                                            </tr>
                                            </thead>
                                            <tbody id="productBatchTableBody">
                                            <!-- Dữ liệu sẽ được thêm động bởi JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Container-fluid Ends-->

            <div class="container-fluid">
                <!-- footer start-->
                <footer class="footer">
                    <div class="row">
                        <div class="col-md-12 footer-copyright text-center">
                            <p class="mb-0">Copyright 2022 © Fastkart theme by pixelstrap</p>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>
</div>
<!-- page-wrapper End-->

<!-- Modal Start -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Log Out</h5>
                <p>Are you sure you want to log out?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">No</button>
                    <button type="button" th:onclick="|window.location='@{backend/login}'|" class="btn btn--yes btn-primary">Yes</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<div class="modal fade" id="editProductBatchModal" tabindex="-1" aria-labelledby="editProductBatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductBatchModalLabel">Edit Product Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductBatchForm">
                    <input type="hidden" id="editBatchId">
                    <div class="mb-3">
                        <label for="editProductDetailId" class="form-label">Product Detail</label>
                        <select class="form-select" id="editProductDetailId" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="editManufactureDate" class="form-label">Manufacture Date</label>
                        <input type="date" class="form-control" id="editManufactureDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editImportedQuantity" class="form-label">Imported Quantity</label>
                        <input type="number" class="form-control" id="editImportedQuantity" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEditProductBatch">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal Box Start -->
<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header d-block text-center">
                <h5 class="modal-title w-100" id="exampleModalLabel22">Are You Sure?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box">
                    <p>Bạn có chắc chắn muốn xóa Product Batch này?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-animation btn-md fw-bold confirm-delete">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center" id="exampleModalLabel12">Done!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box text-center">
                    <div class="wrapper">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h4 class="text-content">It's Removed.</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Delete Modal Box End -->
<!-- Modal for Adjustment History -->
<div class="modal fade" id="adjustmentHistoryModal" tabindex="-1" aria-labelledby="adjustmentHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adjustmentHistoryModalLabel">Lịch Sử Nhập Hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table" id="adjustmentHistoryTable">
                    <tbody id="adjustmentHistoryBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="adjustmentDetailModal" tabindex="-1" aria-labelledby="adjustmentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 90%; width: fit-content; min-width: 300px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adjustmentDetailModalLabel">Chi tiết điều chỉnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-x: auto; overflow-y: auto; max-height: 70vh;">
                <table class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        <th style="white-space: nowrap;">ID</th>
                        <th style="white-space: nowrap;">Quantity</th>
                        <th style="white-space: nowrap;">Reason</th>
                        <th style="white-space: nowrap;">Adjust Date</th>
                        <th style="white-space: nowrap;">Type</th>
                    </tr>
                    </thead>
                    <tbody id="adjustmentDetailBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal cho Product Detail -->
<div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailModalLabel">Chi tiết ProductDetail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Tên chi tiết:</strong> <span id="modalDetailName">N/A</span></p>
                <p><strong>Product ID:</strong> <span id="modalProductId">N/A</span></p>
                <p><strong>Giá:</strong> <span id="modalPrice">N/A</span></p>
                <p><strong>Khối lượng:</strong> <span id="modalWeight">N/A</span></p>
                <p><strong>Thời hạn sử dụng (tháng):</strong> <span id="modalExpiry">N/A</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Add Adjustment -->
<div class="modal fade" id="addAdjustmentModal" tabindex="-1" aria-labelledby="addAdjustmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAdjustmentModalLabel">Thêm Điều Chỉnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAdjustmentForm">
                    <input type="hidden" id="addAdjustmentBatchId">
                    <div class="mb-3">
                        <label for="addQuantity" class="form-label">Số lượng</label>
                        <input type="number" class="form-control" id="addQuantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="addReason" class="form-label">Lý do</label>
                        <input type="text" class="form-control" id="addReason">
                    </div>
                    <div class="mb-3">
                        <label for="addAdjustmentType" class="form-label">Loại điều chỉnh</label>
                        <select class="form-select" id="addAdjustmentType" required>
                            <option value="">Chọn loại</option>
                            <option value="Add">Thêm</option>
                            <option value="Remove">Trừ</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="saveAddAdjustment">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>

<!-- Bootstrap js -->
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>

<!-- feather icon js -->
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>

<!-- scrollbar simplebar js -->
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>

<!-- Sidebar js -->
<script th:src="@{/Backend/assets/js/config.js}"></script>

<!-- customizer js -->
<script th:src="@{/Backend/assets/js/customizer.js}"></script>

<!-- Plugins js -->
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>

<!-- Data table js -->
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>

<!-- sidebar effect -->
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>

<!-- Theme js -->
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom JS cho API call -->
<script>
    $(document).ready(function() {
        // Hàm populate dropdown ProductDetail cho modal sửa
        function populateProductDetailDropdown(selectElement, selectedId) {
            $.ajax({
                url: '/api/product-details',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    selectElement.empty();
                    selectElement.append('<option value="" disabled selected>Chọn Product Detail</option>');
                    if (!data || data.length === 0) {
                        selectElement.append('<option value="" disabled>Không có Product Detail</option>');
                        selectElement.prop('disabled', true);
                        return;
                    }
                    $.each(data, function(index, detail) {
                        var id = detail.productDetailID || detail.id;
                        if (id) {
                            var selected = id == selectedId ? 'selected' : '';
                            selectElement.append(`<option value="${id}" ${selected}>${detail.detailName || 'Không có tên'} (ID: ${id})</option>`);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching Product Details:', status, error, xhr.responseText);
                    alert('Không thể tải danh sách Product Detail. Kiểm tra console.');
                }
            });
        }

        // Gọi API để lấy danh sách ProductBatch
        function loadProductBatches() {
            $.ajax({
                url: '/api/product-batches',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    var tbody = $('#productBatchTableBody');
                    tbody.empty();

                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan="8">Không có dữ liệu</td></tr>');
                        return;
                    }

                    // Tính tổng điều chỉnh (quantity) cho từng batch
                    var adjustmentTotals = {};
                    var adjustmentDetails = {};
                    $.ajax({
                        url: '/api/adjustments',
                        method: 'GET',
                        dataType: 'json',
                        async: false,
                        success: function(adjustments) {
                            $.each(adjustments, function(index, adj) {
                                var batchId = adj.batchId;
                                if (batchId) {
                                    var quantity = adj.quantity || 0;
                                    if (adj.adjustmentType === "Add") {
                                        adjustmentTotals[batchId] = (adjustmentTotals[batchId] || 0) + quantity;
                                    } else if (adj.adjustmentType === "Remove") {
                                        adjustmentTotals[batchId] = (adjustmentTotals[batchId] || 0) - quantity;
                                    }
                                    if (!adjustmentDetails[batchId]) adjustmentDetails[batchId] = [];
                                    adjustmentDetails[batchId].push(adj);
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching adjustments:', status, error, xhr.responseText);
                        }
                    });

                    // Đếm số bản ghi điều chỉnh cho từng batch
                    var adjustmentCounts = {};
                    $.ajax({
                        url: '/api/adjustments',
                        method: 'GET',
                        dataType: 'json',
                        async: false,
                        success: function(adjustments) {
                            $.each(adjustments, function(index, adj) {
                                var batchId = adj.batch || adj.batchId;
                                if (batchId) {
                                    adjustmentCounts[batchId] = (adjustmentCounts[batchId] || 0) + 1;
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching adjustment counts:', status, error, xhr.responseText);
                        }
                    });

                    // Create promises for fetching StockInDetail quantities
                    var stockInPromises = data.map(function(batch) {
                        return new Promise(function(resolve) {
                            var stockInQuantity = 0;
                            var shortageAlert = '';

                            if (!batch.batchID || isNaN(parseInt(batch.batchID))) {
                                console.warn(`Invalid batchID for batch: ${JSON.stringify(batch)}`);
                                resolve({ batch, stockInQuantity, shortageAlert });
                                return;
                            }

                            $.ajax({
                                url: `/api/stockindetails/quantity/${batch.batchID}`,
                                method: 'GET',
                                dataType: 'json',
                                success: function(stockInDetails) {
                                    console.log(`API Response for batchID ${batch.batchID}:`, stockInDetails);
                                    if (stockInDetails && Array.isArray(stockInDetails) && stockInDetails.length > 0) {
                                        stockInQuantity = stockInDetails.reduce((sum, detail) => {
                                            const qty = parseInt(detail.quantity) || 0;
                                            console.log(`Detail for batchID ${batch.batchID}: quantity=${qty}`);
                                            return sum + qty;
                                        }, 0);
                                    } else {
                                        console.log(`No StockInDetails found for batchID ${batch.batchID}`);
                                    }
                                    resolve({ batch, stockInQuantity, shortageAlert });
                                },
                                error: function(xhr, status, error) {
                                    console.error(`Error fetching StockInDetails for batchID ${batch.batchID}: status=${status}, error=${error}, response=${xhr.responseText}`);
                                    resolve({ batch, stockInQuantity, shortageAlert });
                                }
                            });
                        });
                    });

                    // Process all batches after fetching StockInDetail data
                    Promise.all(stockInPromises).then(function(results) {
                        results.forEach(function({ batch, stockInQuantity, shortageAlert }) {
                            var productDetailId = batch.productDetailID || batch.productDetail || 'N/A';
                            var importedQuantity = batch.importedQuantity || 0;
                            var remainingQuantity = importedQuantity - (batch.soldQuantity || 0);
                            var totalAdjustment = adjustmentTotals[batch.batchID] || 0;
                            remainingQuantity += totalAdjustment;
                            var adjustmentCount = adjustmentCounts[batch.batchID] || 0;

                            // Tính tổng điều chỉnh chỉ từ "Add"
                            var addAdjustmentTotal = 0;
                            if (adjustmentDetails[batch.batchID]) {
                                addAdjustmentTotal = adjustmentDetails[batch.batchID]
                                    .filter(adj => adj.adjustmentType === "Add")
                                    .reduce((sum, adj) => sum + (parseInt(adj.quantity) || 0), 0);
                            }

                            // Calculate temporary imported quantity with only Add adjustments
                            console.log(`Batch ID ${batch.batchID}: importedQuantity=${importedQuantity}, stockInQuantity=${stockInQuantity}, addAdjustmentTotal=${addAdjustmentTotal}`);
                            var temporaryImported = importedQuantity + addAdjustmentTotal; // Chỉ cộng "Add"
                            if (importedQuantity < stockInQuantity) {
                                var shortage = stockInQuantity - importedQuantity;
                                console.log(`Shortage detected for Batch ID ${batch.batchID}: shortage=${shortage}`);
                                if (temporaryImported >= stockInQuantity && addAdjustmentTotal > 0) {
                                    shortageAlert = `<a href="javascript:void(0)" class="view-adjustment-history" data-batch-id="${batch.batchID}" data-imported="${importedQuantity}"><i class="ri-history-line" style="vertical-align: middle;"></i></a>`;
                                } else {
                                    shortageAlert = `<a href="javascript:void(0)" class="shortage-alert" data-shortage="${shortage}" title="Thiếu ${shortage} đơn vị"><i class="ri-alert-line" style="color: red; vertical-align: middle;"></i></a>`;
                                }
                            } else if (temporaryImported >= stockInQuantity && addAdjustmentTotal > 0) {
                                shortageAlert = `<a href="javascript:void(0)" class="view-adjustment-history" data-batch-id="${batch.batchID}" data-imported="${importedQuantity}"><i class="ri-history-line" style="vertical-align: middle;"></i></a>`;
                            }

                            // Lấy expiry từ API product-details
                            var expiry = 'N/A';
                            $.ajax({
                                url: '/api/product-details/' + productDetailId,
                                method: 'GET',
                                async: false,
                                success: function(detail) {
                                    expiry = detail.expiry || 'N/A';
                                },
                                error: function(xhr, status, error) {
                                    console.error(`Error fetching Product Detail for ID ${productDetailId}: status=${status}, error=${error}`);
                                }
                            });

                            // Tính phần trăm thời gian đã sử dụng
                            var percentageUsed = null;
                            if (batch.manufactureDate && expiry && !isNaN(expiry)) {
                                var manufactureDate = new Date(batch.manufactureDate);
                                var expiryDate = new Date(manufactureDate.getTime());
                                expiryDate.setMonth(expiryDate.getMonth() + parseInt(expiry));
                                var today = new Date();

                                var totalTime = expiryDate - manufactureDate;
                                var usedTime = today - manufactureDate;
                                percentageUsed = (usedTime / totalTime) * 100;
                            }

                            var row = '<tr' + (percentageUsed !== null ? (percentageUsed >= 100 ? ' class="table-danger"' : percentageUsed >= 70 ? ' style="background-color: #ffca2c;"' : percentageUsed >= 50 ? ' class="table-warning"' : '') : '') + '>' +
                                '<td>' + (batch.batchID || 'N/A') + '</td>' +
                                '<td><a href="javascript:void(0)" class="detail-link" data-id="' + productDetailId + '">' + productDetailId + '</a></td>' +
                                '<td>' + (batch.manufactureDate || 'N/A') + '</td>' +
                                '<td>' + (temporaryImported || importedQuantity || 'N/A') + (shortageAlert ? ' ' + shortageAlert : '') + '</td>' +
                                '<td>' + (batch.soldQuantity || 0) + '</td>' +
                                '<td>' + remainingQuantity + '</td>' +
                                '<td>' + (adjustmentCount > 0 ? '<a href="javascript:void(0)" class="view-adjustment-detail" data-batch-id="' + (batch.batchID || '') + '">' + totalAdjustment + '</a>' : '<span style="pointer-events: none; opacity: 0.5;">' + totalAdjustment + '</span>') + '</td>' +
                                '<td>' +
                                '<ul class="action-list">' +
                                '<li><a href="javascript:void(0)" class="view-detail" data-id="' + productDetailId + '"><i class="ri-eye-line"></i></a></li>' +
                                '<li><a href="javascript:void(0)" class="edit-batch" data-batch-id="' + (batch.batchID || '') + '" data-product-detail-id="' + productDetailId + '" data-manufacture-date="' + (batch.manufactureDate || '') + '" data-imported-quantity="' + (importedQuantity || '') + '"><i class="ri-pencil-line"></i></a></li>' +
                                '<li><a href="javascript:void(0)" class="delete-batch" data-batch-id="' + (batch.batchID || '') + '"><i class="ri-delete-bin-line"></i></a></li>' +
                                '<li><a href="javascript:void(0)" class="add-adjustment" data-batch-id="' + (batch.batchID || '') + '"><i class="ri-add-line"></i></a></li>' +
                                '</ul>' +
                                '</td>' +
                                '</tr>';

                            $('#productBatchTableBody').append(row);
                        });

                        // Re-attach event handlers after table update
                        $('.shortage-alert').on('click', function() {
                            var shortage = $(this).data('shortage');
                            alert(`Thiếu ${shortage} đơn vị. Vui lòng yêu cầu nhập thêm hàng.`);
                        });

                        $('.view-adjustment-detail').on('click', function() {
                            var batchId = $(this).data('batch-id');
                            if (!batchId || batchId === 'N/A') {
                                alert('Batch ID không hợp lệ hoặc không tồn tại.');
                                return;
                            }

                            $.ajax({
                                url: '/api/product-batches/adjustments?batchId=' + batchId,
                                method: 'GET',
                                dataType: 'json',
                                success: function(response) {
                                    var tbody = $('#adjustmentDetailBody');
                                    tbody.empty();

                                    if (!response) {
                                        tbody.append('<tr><td colspan="5">Không nhận được dữ liệu từ server.</td></tr>');
                                    } else if (!response.adjustments || response.adjustments.length === 0) {
                                        tbody.append('<tr><td colspan="5">Không có điều chỉnh cho batchId: ' + batchId + '</td></tr>');
                                    } else {
                                        var adjustments = response.adjustments;
                                        $.each(adjustments, function(index, adj) {
                                            var id = adj.id !== undefined && adj.id !== null ? adj.id : 'N/A';
                                            var quantity = adj.quantity !== undefined && adj.quantity !== null ? adj.quantity : 'N/A';
                                            var adjustDate = adj.adjustDate !== undefined && adj.adjustDate !== null ? adj.adjustDate : 'N/A';
                                            var adjustmentType = adj.adjustmentType !== undefined && adj.adjustmentType !== null ? adj.adjustmentType : 'N/A';
                                            var reason = adj.reason !== undefined && adj.reason !== null ? adj.reason : 'N/A';
                                            var displayQuantity = adjustmentType === 'Remove' && quantity !== 'N/A' ? '-' + quantity : quantity;

                                            tbody.append('<tr>' +
                                                '<td>' + id + '</td>' +
                                                '<td>' + displayQuantity + '</td>' +
                                                '<td>' + reason + '</td>' +
                                                '<td>' + adjustDate + '</td>' +
                                                '<td>' + adjustmentType + '</td>' +
                                                '</tr>');
                                        });
                                    }
                                    $('#adjustmentDetailModal').modal('show');
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error fetching adjustment details:', status, error, xhr.responseText);
                                    var tbody = $('#adjustmentDetailBody');
                                    tbody.empty();
                                    var errorMessage = 'Lỗi khi lấy chi tiết điều chỉnh: ' + (xhr.status + ' - ' + (xhr.responseText || status || error));
                                    tbody.append('<tr><td colspan="5">' + errorMessage + '</td></tr>');
                                    alert('Không thể tải chi tiết điều chỉnh. Kiểm tra console.');
                                }
                            });
                        });

                        // Handler for adjustment history
                        $(document).on('click', '.view-adjustment-history', function() {
                            var batchId = $(this).data('batch-id');
                            var imported = $(this).data('imported');
                            if (!batchId || batchId === 'N/A') {
                                alert('Batch ID không hợp lệ hoặc không tồn tại.');
                                return;
                            }

                            $.ajax({
                                url: '/api/product-batches/adjustments?batchId=' + batchId,
                                method: 'GET',
                                dataType: 'json',
                                success: function(response) {
                                    var tbody = $('#adjustmentHistoryBody');
                                    tbody.empty();

                                    if (!response) {
                                        tbody.append('<tr><td colspan="2">Không nhận được dữ liệu từ server.</td></tr>');
                                    } else if (!response.adjustments || response.adjustments.length === 0) {
                                        tbody.append('<tr><td colspan="2">Không có điều chỉnh cho batchId: ' + batchId + '</td></tr>');
                                    } else {
                                        var adjustments = response.adjustments.filter(adj => adj.adjustmentType === "Add").sort((a, b) => new Date(b.adjustDate) - new Date(a.adjustDate)); // Sort by date descending
                                        tbody.append('<tr><td>Số lượng nhập lần 1:</td><td>' + imported + '</td></tr>');
                                        adjustments.forEach((adj, index) => {
                                            var quantity = adj.quantity !== undefined && adj.quantity !== null ? adj.quantity : 'N/A';
                                            var adjustDate = adj.adjustDate !== undefined && adj.adjustDate !== null ? adj.adjustDate : 'N/A';
                                            tbody.append('<tr><td>Số lượng nhập lần ' + (index + 2) + ' (' + adjustDate + '):</td><td>' + quantity + '</td></tr>');
                                        });
                                    }
                                    $('#adjustmentHistoryModal').modal('show');
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error fetching adjustment history:', status, error, xhr.responseText);
                                    var tbody = $('#adjustmentHistoryBody');
                                    tbody.empty();
                                    var errorMessage = 'Lỗi khi lấy lịch sử điều chỉnh: ' + (xhr.status + ' - ' + (xhr.responseText || status || error));
                                    tbody.append('<tr><td colspan="2">' + errorMessage + '</td></tr>');
                                    alert('Không thể tải lịch sử điều chỉnh. Kiểm tra console.');
                                }
                            });
                        });

                        $('.view-detail').on('click', function() {
                            var productDetailId = $(this).data('id');
                            if (productDetailId === 'N/A') {
                                alert('Không có ProductDetail để hiển thị.');
                                return;
                            }
                            $.ajax({
                                url: '/api/product-details/' + productDetailId,
                                method: 'GET',
                                dataType: 'json',
                                success: function(detail) {
                                    $('#modalProductDetailId').text(detail.productDetailId || 'N/A');
                                    $('#modalDetailName').text(detail.detailName || 'N/A');
                                    $('#modalProductId').text(detail.productID || 'N/A');
                                    $('#modalPrice').text(detail.price ? detail.price.toFixed(2) : 'N/A');
                                    $('#modalExpiry').text(detail.expiry || 'N/A');
                                    $('#modalWeight').text(detail.categoryWeight || 'N/A');
                                    $('#productDetailModal').modal('show');

                                    if (detail.categoryWeight) {
                                        $.ajax({
                                            url: '/api/categoryweights/' + detail.categoryWeight,
                                            method: 'GET',
                                            dataType: 'json',
                                            success: function(categoryWeight) {
                                                $('#modalWeight').text(categoryWeight.unit ? detail.categoryWeight + ' ' + categoryWeight.unit : detail.categoryWeight);
                                            },
                                            error: function(xhr, status, error) {
                                                $('#modalWeight').text(detail.categoryWeight || 'N/A');
                                            }
                                        });
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error fetching Product Detail:', status, error, xhr.responseText);
                                    alert('Không thể tải chi tiết sản phẩm. Kiểm tra console.');
                                }
                            });
                        });

                        $('.edit-batch').on('click', function() {
                            var batchId = $(this).data('batch-id');
                            var productDetailId = $(this).data('product-detail-id');
                            var manufactureDate = $(this).data('manufacture-date');
                            var importedQuantity = $(this).data('imported-quantity');
                            if (!batchId) {
                                alert('Batch ID không hợp lệ.');
                                return;
                            }
                            $('#editBatchId').val(batchId);
                            $('#editManufactureDate').val(manufactureDate);
                            $('#editImportedQuantity').val(importedQuantity);
                            populateProductDetailDropdown($('#editProductDetailId'), productDetailId);
                            $('#editProductBatchModal').modal('show');
                        });

                        $('.delete-batch').on('click', function(e) {
                            e.preventDefault();
                            var batchId = $(this).data('batch-id');
                            if (!batchId) {
                                alert('Batch ID không hợp lệ.');
                                return;
                            }
                            if ($('#exampleModalToggle').length === 0) {
                                alert('Không tìm thấy modal xác nhận xóa.');
                                return;
                            }
                            $('.confirm-delete').data('batch-id', batchId);
                            $('#exampleModalToggle').modal('show');
                        });

                        $('.add-adjustment').on('click', function() {
                            var batchId = $(this).data('batch-id');
                            if (!batchId || batchId === 'N/A') {
                                alert('Batch ID không hợp lệ.');
                                return;
                            }
                            $('#addAdjustmentBatchId').val(batchId);
                            $('#addQuantity').val('');
                            $('#addReason').val('');
                            $('#addAdjustmentType').val('');
                            $('#addAdjustmentModal').modal('show');
                        });
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching Product Batches:', status, error, xhr.responseText);
                    alert('Lỗi khi tải dữ liệu: ' + error + '. Kiểm tra console.');
                }
            });
        }

        // Load danh sách ban đầu
        loadProductBatches();

        $(document).on('click', '#saveEditProductBatch', function() {
            var batchId = $('#editBatchId').val();
            var productDetailId = $('#editProductDetailId').val();
            var manufactureDate = $('#editManufactureDate').val();
            var importedQuantity = $('#editImportedQuantity').val();

            if (!productDetailId || isNaN(parseInt(productDetailId))) {
                alert('Vui lòng chọn một Product Detail hợp lệ.');
                return;
            }
            if (!manufactureDate) {
                alert('Vui lòng chọn ngày sản xuất.');
                return;
            }
            if (!importedQuantity || isNaN(parseInt(importedQuantity)) || parseInt(importedQuantity) < 1) {
                alert('Vui lòng nhập số lượng nhập hợp lệ (tối thiểu 1).');
                return;
            }

            var formData = {
                productDetailID: parseInt(productDetailId),
                manufactureDate: manufactureDate,
                importedQuantity: parseInt(importedQuantity)
            };

            $.ajax({
                url: '/api/product-batches/' + batchId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                dataType: 'json',
                success: function(response) {
                    alert('Cập nhật ProductBatch thành công!');
                    $('#editProductBatchModal').modal('hide');
                    loadProductBatches();
                },
                error: function(xhr, status, error) {
                    console.error('Error updating ProductBatch:', status, error, xhr.responseText);
                    alert('Lỗi khi sửa ProductBatch: ' + (xhr.responseText || 'Kiểm tra console.'));
                }
            });
        });

        $(document).on('click', '.confirm-delete', function(e) {
            e.preventDefault();
            var batchId = $(this).data('batch-id');
            if (!batchId) {
                alert('Batch ID không hợp lệ.');
                return;
            }

            $.ajax({
                url: '/api/product-batches/' + batchId,
                method: 'DELETE',
                headers: { 'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') },
                success: function() {
                    $('#exampleModalToggle').modal('hide');
                    if ($('#exampleModalToggle2').length > 0) {
                        $('#exampleModalToggle2').modal('show');
                    } else {
                        alert('Xóa ProductBatch thành công!');
                    }
                    loadProductBatches();
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting ProductBatch:', status, error, xhr.responseText);
                    alert('Lỗi khi xóa ProductBatch: ' + (xhr.responseText || 'Kiểm tra console.'));
                    $('#exampleModalToggle').modal('hide');
                }
            });
        });

        $('#saveAddAdjustment').on('click', function() {
            var batchId = $('#addAdjustmentBatchId').val();
            var quantity = $('#addQuantity').val();
            var reason = $('#addReason').val();
            var adjustmentType = $('#addAdjustmentType').val();

            if (!batchId || isNaN(parseInt(batchId))) {
                alert('Batch ID không hợp lệ.');
                return;
            }
            if (!quantity || isNaN(parseInt(quantity))) {
                alert('Vui lòng nhập số lượng hợp lệ.');
                return;
            }
            if (!adjustmentType) {
                alert('Vui lòng chọn loại điều chỉnh.');
                return;
            }

            var parsedQuantity = parseInt(quantity);
            if (parsedQuantity > 0 && adjustmentType !== "Add") {
                alert('Số lượng lớn hơn 0 phải có loại điều chỉnh là "Thêm".');
                return;
            }
            if (parsedQuantity < 0 && adjustmentType !== "Remove") {
                alert('Số lượng nhỏ hơn 0 phải có loại điều chỉnh là "Trừ".');
                return;
            }
            if (parsedQuantity === 0) {
                alert('Số lượng không được bằng 0.');
                return;
            }

            var formData = {
                batchId: parseInt(batchId),
                quantity: Math.abs(parsedQuantity),
                adjustmentType: adjustmentType,
                reason: reason || null
            };

            $.ajax({
                url: '/api/adjustments',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                dataType: 'json',
                success: function(response) {
                    alert('Thêm điều chỉnh thành công!');
                    $('#addAdjustmentModal').modal('hide');
                    loadProductBatches();
                },
                error: function(xhr, status, error) {
                    console.error('Error adding adjustment:', status, error, xhr.responseText);
                    alert('Lỗi khi thêm điều chỉnh: ' + (xhr.responseText || 'Kiểm tra console.'));
                }
            });
        });
    });
</script>

</body>
</html>