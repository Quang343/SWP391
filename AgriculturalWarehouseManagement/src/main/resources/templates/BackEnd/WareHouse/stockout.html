<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<style>
    /* Ensure table is scrollable horizontally if content overflows */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 0; /* Remove extra margin to keep pagination close */
        position: relative; /* Context for scrollbar */
    }

    /* Ensure table takes full width but triggers scrollbar if needed */
    #table_id {
        width: 100%;
        min-width: 1100px; /* Increased to accommodate status column */
        table-layout: fixed; /* Ensure consistent column widths */
    }

    /* Override gray borders from Bootstrap for table */
    #table_id.table,
    #table_id th,
    #table_id td {
        border-color: #e6f3f2 !important; /* Light green border */
    }

    /* Consistent text alignment and padding for table cells */
    #table_id th,
    #table_id td {
        text-align: left; /* Default left alignment */
        vertical-align: middle; /* Center vertically */
        padding: 8px 12px; /* Consistent padding */
        overflow: hidden;
        text-overflow: ellipsis; /* Truncate long text with ellipsis */
    }

    /* Specific styles for columns */
    #table_id th:nth-child(1), #table_id td:nth-child(1) { width: 15%; text-align: center; } /* Mã Xuất kho */
    #table_id th:nth-child(2), #table_id td:nth-child(2) { width: 20%; } /* Kho hàng */
    #table_id th:nth-child(3), #table_id td:nth-child(3) { width: 15%; } /* Đơn hàng */
    #table_id th:nth-child(4), #table_id td:nth-child(4) { width: 15%; } /* Ngày Xuất kho */
    #table_id th:nth-child(5), #table_id td:nth-child(5) { width: 25%; } /* Ghi chú */
    #table_id th:nth-child(6), #table_id td:nth-child(6) { width: 10%; text-align: center; } /* Trạng thái */
    #table_id th:nth-child(7), #table_id td:nth-child(7) { width: 10%; text-align: center; } /* Hành động */

    /* Style for sortable column headers */
    th.sortable {
        cursor: pointer;
        position: relative;
        padding-right: 20px; /* Space for sort icon */
    }

    th.sortable::after {
        content: '';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        border: 4px solid transparent;
        border-top-color: #018F84; /* Default arrow color */
        opacity: 0.5;
    }

    th.sortable.asc::after {
        border-top-color: transparent;
        border-bottom-color: #018F84; /* Up arrow for ascending */
        opacity: 1;
    }

    th.sortable.desc::after {
        border-bottom-color: transparent;
        border-top-color: #018F84; /* Down arrow for descending */
        opacity: 1;
    }

    th.sortable:hover::after {
        opacity: 1; /* Highlight arrow on hover */
    }

    /* Center pagination and style items */
    #pagination-controls {
        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center;
        margin-top: 12px; /* Ensure below scrollbar */
        margin-bottom: 20px; /* Space below pagination */
        position: relative; /* Ensure proper stacking */
        z-index: 10; /* Below footer and sidebar */
        max-width: 100%; /* Prevent overflow */
    }

    #pagination-controls .page-item {
        margin: 0 2.5px; /* 5px gap between items */
    }

    #pagination-controls .page-link {
        border-radius: 4px;
        padding: 6px 12px;
        color: #018F84; /* Text color for number pages */
        font-size: 14px; /* Match theme typography */
        cursor: pointer; /* Ensure clickable appearance */
        border: 1px solid #018F84; /* Border matches theme */
        background-color: transparent; /* Default background */
        text-align: center;
        box-sizing: border-box;
    }

    /* Style for Previous and Next buttons */
    #pagination-controls .page-item:first-child .page-link,
    #pagination-controls .page-item:last-child .page-link {
        background-color: #018F84; /* Green background */
        color: #fff; /* White text */
        border-color: #018F84;
    }

    /* Style for active page */
    #pagination-controls .page-item.active .page-link {
        background-color: #018F84; /* Green background */
        border-color: #018F84;
        color: #fff; /* White text */
    }

    /* Style for disabled buttons */
    #pagination-controls .page-item.disabled .page-link {
        color: #018F84; /* Green text */
        border-color: #e6f3f2; /* Light green border */
        background-color: #e6f3f2; /* Light green background */
        pointer-events: none;
        cursor: default;
    }

    /* Hover effect for non-disabled, non-active number pages */
    #pagination-controls .page-link:hover:not(.disabled .page-link):not(.active .page-link):not(:first-child .page-link):not(:last-child .page-link) {
        background-color: #e6f3f2; /* Light green on hover */
        color: #018F84;
    }

    /* Hover effect for Previous/Next */
    #pagination-controls .page-item:not(.disabled):first-child .page-link:hover,
    #pagination-controls .page-item:not(.disabled):last-child .page-link:hover {
        background-color: #016f6a; /* Darker green on hover */
        color: #fff;
    }

    /* Style for search bar and button */
    .btn-theme {
        background-color: #018F84; /* Match theme color */
        color: #fff;
        border-color: #018F84;
    }

    .btn-theme:hover {
        background-color: #016f6a; /* Darker green on hover */
        color: #fff;
        border-color: #016f6a;
    }

    .search-bar input {
        border: 1px solid #e6f3f2; /* Light green border */
    }

    .search-bar input:focus {
        border-color: #018F84; /* Darker green on focus */
        box-shadow: 0 0 5px rgba(1, 143, 132, 0.3);
    }

    /* Style for status column */
    .status-returned {
        color: #ff0000; /* Red for RETURNED */
        font-weight: bold;
    }

    .status-exported {
        color: #008000; /* Green for EXPORTED */
        font-weight: bold;
    }

    /* Loading state */
    .loading {
        opacity: 0.5;
        pointer-events: none;
    }
</style>

<body>
<!-- tap on top start-->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body Start-->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
        <!-- Page Sidebar Ends-->

        <!-- StockOut section Start -->
        <div class="page-body">
            <!-- Table Start -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-table">
                            <div class="card-body">
                                <div class="title-header option-title">
                                    <!-- Dòng 1: chỉ StockOut List -->
                                    <div class="first-line">
                                        <h5>Danh sách Xuất kho</h5>
                                    </div>

                                    <!-- Dòng 2: Add new StockOut và Search -->
                                    <div class="second-line" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                                        <a th:href="@{/warehouse/addstockout}" class="align-items-center btn btn-theme d-flex">
                                            <i data-feather="plus"></i> Thêm Xuất kho
                                        </a>
                                        <div class="search-bar">
                                            <input type="text" class="form-control" placeholder="Tìm kiếm..." id="searchInputStockOut">
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive" id="table-container">
                                    <table class="table all-package order-table theme-table" id="table_id">
                                        <thead>
                                        <tr>
                                            <th class="sortable" data-sort="stockOutId">Mã Xuất kho</th>
                                            <th class="sortable" data-sort="warehouseName">Kho hàng</th>
                                            <th class="sortable" data-sort="orderCode">Đơn hàng</th>
                                            <th class="sortable" data-sort="stockOutDate">Ngày Xuất kho</th>
                                            <th class="sortable" data-sort="note">Ghi chú</th>
                                            <th class="sortable" data-sort="status">Trạng thái</th>
                                            <th>Hành động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="stockOutTableBody">
                                        <tr id="no-data-row" style="display: none;">
                                            <td colspan="7" class="text-center" style="background-color: #e6f3f2; color: #555;">Không tìm thấy bản ghi nào</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <ul id="pagination-controls" class="pagination"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Table End -->
            <div th:replace="~{BackEnd/fragments/WareHouse/footer::footer}"></div>
        </div>
        <!-- StockOut section End -->
    </div>
    <!-- Page Body End-->
</div>
<!-- page-wrapper End -->

<!-- Logout Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Đăng xuất</h5>
                <p>Bạn có chắc chắn muốn đăng xuất?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
                    <button type="button" th:onclick="|window.location='@{/backend/login}'|" class="btn btn--yes btn-primary">Có</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<!-- Latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>
<script th:src="@{/Backend/assets/js/checkbox-all-check.js}"></script>

<!-- Custom JavaScript -->
<script>
    $(document).ready(function () {
        console.log('[DEBUG] Initializing page at ' + new Date().toISOString());

        // DOM Elements
        const stockOutTableBody = $('#stockOutTableBody');
        const searchInputStockOut = $('#searchInputStockOut');
        const tableContainer = $('#table-container');
        let allStockOuts = [];
        let orderCache = new Map(); // Cache for orderCode by orderId
        let currentPage = 0;
        let totalPages = 1;
        const pageSize = 2;
        let searchTerm = '';
        let sortColumn = 'stockOutId';
        let sortDirection = 'asc';
        let isPaginating = false;

        // Validate DOM elements
        console.log('[DEBUG] Validating DOM elements');
        if (!stockOutTableBody.length || !tableContainer.length || !searchInputStockOut.length) {
            console.error('[ERROR] Missing critical DOM elements');
            $.notify({ message: 'Không tìm thấy các phần tử giao diện cần thiết. Vui lòng kiểm tra HTML.' }, { type: 'danger', delay: 5000 });
            return;
        }
        console.log('[DEBUG] All DOM elements found');

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Format date to Vietnamese format (HH:mm:ss DD/MM/YYYY)
        function formatDateToVietnamese(dateString) {
            if (!dateString || dateString === 'N/A') return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    console.warn('[WARN] Invalid date:', dateString);
                    return 'N/A';
                }
                const vnTime = new Date(date.getTime());
                const day = String(vnTime.getDate()).padStart(2, '0');
                const month = String(vnTime.getMonth() + 1).padStart(2, '0');
                const year = vnTime.getFullYear();
                const hours = String(vnTime.getHours()).padStart(2, '0');
                const minutes = String(vnTime.getMinutes()).padStart(2, '0');
                const seconds = String(vnTime.getSeconds()).padStart(2, '0');
                return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
            } catch (error) {
                console.error('[ERROR] Error parsing date:', dateString, error);
                return 'N/A';
            }
        }

        // Format status with color
        function formatStatus(status) {
            if (!status) return 'N/A';
            switch (status.toUpperCase()) {
                case 'RETURNED':
                    return `<span class="status-returned">Đã trả hàng</span>`;
                case 'EXPORTED':
                    return `<span class="status-exported">Đã xuất kho</span>`;
                default:
                    return status;
            }
        }

        // Ensure table body and no-data row exist
        function ensureElements() {
            let tableBody = $('#stockOutTableBody');
            let noDataRow = $('#no-data-row');

            if (!tableBody.length) {
                const table = $('#table_id');
                if (table.length) {
                    tableBody = $('<tbody id="stockOutTableBody"></tbody>');
                    table.append(tableBody);
                    console.log('[DEBUG] Created new tbody with id stockOutTableBody');
                } else {
                    console.error('[ERROR] Table #table_id not found');
                    $.notify({ message: 'Không tìm thấy bảng #table_id. Vui lòng kiểm tra HTML.' }, { type: 'danger', delay: 5000 });
                    return null;
                }
            }

            if (!noDataRow.length) {
                noDataRow = $('<tr id="no-data-row" style="display: none;"><td colspan="7" class="text-center" style="background-color: #e6f3f2; color: #555;">Không tìm thấy bản ghi nào</td></tr>');
                tableBody.append(noDataRow);
                console.log('[DEBUG] Created new no-data-row');
            }

            return { tableBody, noDataRow };
        }

        // Update URL with page number and search term
        function updateURL(page) {
            const params = new URLSearchParams();
            if (page > 0) params.set('page', page + 1);
            if (searchTerm) params.set('search', searchTerm);
            history.pushState({}, '', `/AgriculturalWarehouseManagementApplication/warehouse/stockout?${params.toString()}`);
        }

        // Update sort indicators
        function updateSortIndicators() {
            $('th.sortable').each(function () {
                $(this).removeClass('asc desc');
                if ($(this).attr('data-sort') === sortColumn) {
                    $(this).addClass(sortDirection);
                }
            });
        }

        // Fetch Order by ID
        function fetchOrderById(orderId) {
            if (!orderId) {
                console.log('[DEBUG] No orderId provided, returning N/A');
                return Promise.resolve('N/A');
            }

            // Check cache first
            if (orderCache.has(orderId)) {
                console.log('[DEBUG] Order code from cache for orderId:', orderId, 'value:', orderCache.get(orderId));
                return Promise.resolve(orderCache.get(orderId));
            }

            const url = `http://localhost:8080/AgriculturalWarehouseManagementApplication/api/orders/${orderId}`;
            console.log('[DEBUG] Fetching order from', url);
            return $.ajax({
                url: url,
                method: 'GET',
                dataType: 'json',
                timeout: 5000,
                headers: { 'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') || '' },
                beforeSend: function () {
                    console.log('[DEBUG] Sending GET request to', url);
                }
            }).then(data => {
                console.log('[DEBUG] Order API response for orderId', orderId, ':', JSON.stringify(data, null, 2));
                const orderCode = data && data.orderCode ? data.orderCode : 'N/A';
                orderCache.set(orderId, orderCode); // Cache the result
                return orderCode;
            }).catch(error => {
                console.error('[ERROR] Failed to fetch order for orderId', orderId, ':', {
                    url,
                    status: error.status || 'unknown',
                    statusText: error.statusText || 'unknown',
                    response: error.responseText ? error.responseText : 'No response body',
                    error: error.message || 'Unknown error'
                });
                orderCache.set(orderId, 'N/A'); // Cache N/A for failed fetches
                return 'N/A';
            });
        }

        // Get order code by order ID (async)
        async function getOrderCode(orderId) {
            return await fetchOrderById(orderId);
        }

        // Sort StockOuts
        async function sortStockOuts(stockOuts) {
            // Create a copy of stockOuts with resolved orderCodes
            const stockOutsWithOrderCodes = await Promise.all(stockOuts.map(async stockOut => {
                const orderCode = await getOrderCode(stockOut.orderID);
                return { ...stockOut, resolvedOrderCode: orderCode };
            }));

            return stockOutsWithOrderCodes.sort((a, b) => {
                let valueA, valueB;
                const warehouseNameA = a.warehouseID ? (a.warehouseID.warehouseName || 'N/A') : 'N/A';
                const warehouseNameB = b.warehouseID ? (b.warehouseID.warehouseName || 'N/A') : 'N/A';
                const orderCodeA = a.resolvedOrderCode || 'N/A';
                const orderCodeB = b.resolvedOrderCode || 'N/A';

                switch (sortColumn) {
                    case 'stockOutId':
                        valueA = a.id || 'N/A';
                        valueB = b.id || 'N/A';
                        break;
                    case 'warehouseName':
                        valueA = warehouseNameA.toLowerCase();
                        valueB = warehouseNameB.toLowerCase();
                        break;
                    case 'orderCode':
                        valueA = orderCodeA.toLowerCase();
                        valueB = orderCodeB.toLowerCase();
                        break;
                    case 'stockOutDate':
                        valueA = a.stockOutDate ? new Date(a.stockOutDate).getTime() : 0;
                        valueB = b.stockOutDate ? new Date(b.stockOutDate).getTime() : 0;
                        break;
                    case 'note':
                        valueA = a.note ? a.note.toLowerCase() : 'N/A';
                        valueB = b.note ? b.note.toLowerCase() : 'N/A';
                        break;
                    case 'status':
                        valueA = a.status ? a.status.toUpperCase() : 'N/A';
                        valueB = b.status ? b.status.toUpperCase() : 'N/A';
                        break;
                    default:
                        return 0;
                }
                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Render stockouts to table
        async function renderStockOuts(stockOuts, pageIndex) {
            const { tableBody, noDataRow } = ensureElements();
            if (!tableBody || !noDataRow) {
                console.error('[ERROR] Failed to ensure table elements');
                $.notify({ message: 'Không thể thiết lập bảng dữ liệu. Vui lòng kiểm tra HTML.' }, { type: 'danger', delay: 5000 });
                return;
            }

            tableBody.empty();
            if (stockOuts.length > 0) {
                noDataRow.hide();
                // Fetch order codes for all stockouts in the current page
                const stockOutsWithOrderCodes = await Promise.all(stockOuts.map(async stockOut => {
                    const orderCode = await getOrderCode(stockOut.orderID);
                    return { ...stockOut, resolvedOrderCode: orderCode };
                }));

                stockOutsWithOrderCodes.forEach(stockOut => {
                    const warehouseName = stockOut.warehouseID ? (stockOut.warehouseID.warehouseName || 'N/A') : 'N/A';
                    const orderCode = stockOut.resolvedOrderCode || 'N/A';
                    const row = `
                    <tr>
                        <td>${stockOut.id || 'N/A'}</td>
                        <td>Kho Trung Tâm</td>
                        <td>${orderCode}</td>
                        <td>${formatDateToVietnamese(stockOut.stockOutDate)}</td>
                        <td>${stockOut.note || 'N/A'}</td>
                        <td>${formatStatus(stockOut.status)}</td>
                        <td><a href="/AgriculturalWarehouseManagementApplication/warehouse/stockoutdetail?stockOutId=${stockOut.id}" class="btn btn-sm btn-primary view-details-btn">Xem Chi tiết</a></td>
                    </tr>
                `;
                    tableBody.append(row);
                });
                console.log('[DEBUG] Table rendered with', stockOutsWithOrderCodes.length, 'rows');
            } else {
                noDataRow.show();
                console.log('[DEBUG] No data to display, showing no-data-row');
            }
        }

        // Fetch StockOut data and populate table
        async function fetchStockOuts(search = '', isPaginationClick = false) {
            searchTerm = search;
            if (!isPaginationClick) {
                currentPage = 0;
            }
            updateURL(currentPage);
            const { tableBody, noDataRow } = ensureElements();
            if (!tableBody || !noDataRow) {
                console.error('[ERROR] Failed to ensure table elements');
                $.notify({ message: 'Không thể thiết lập bảng dữ liệu. Vui lòng kiểm tra HTML.' }, { type: 'danger', delay: 5000 });
                tableContainer.removeClass('loading');
                return;
            }

            console.log('[DEBUG] Fetching stockouts for page:', currentPage, 'search:', searchTerm, 'sortColumn:', sortColumn, 'sortDirection:', sortDirection, 'isPaginationClick:', isPaginationClick);

            tableContainer.addClass('loading');

            const url = `/AgriculturalWarehouseManagementApplication/api/stockouts/paginatedStockOut?page=0&size=1000`;
            try {
                const response = await $.ajax({
                    url: url,
                    method: 'GET',
                    dataType: 'json',
                    timeout: 10000,
                    headers: { 'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') || '' },
                    beforeSend: function () {
                        console.log('[DEBUG] Sending GET request to', url);
                    }
                });

                console.log('[DEBUG] Stockouts API response:', JSON.stringify(response, null, 2));
                if (!response || !Array.isArray(response.content) || typeof response.totalPages === 'undefined') {
                    console.error('[ERROR] Invalid stockout data:', response);
                    tableBody.empty();
                    noDataRow.show();
                    tableContainer.removeClass('loading');
                    renderPagination(0, 0);
                    $.notify({ message: 'Dữ liệu xuất kho không hợp lệ hoặc không có dữ liệu.' }, { type: 'danger', delay: 3000 });
                    return;
                }

                allStockOuts = response.content;

                // Filter stockouts based on search term
                const filteredStockOuts = await Promise.all(allStockOuts.map(async stockOut => {
                    const orderCode = await getOrderCode(stockOut.orderID);
                    return { ...stockOut, resolvedOrderCode: orderCode };
                }));

                const filteredResults = filteredStockOuts.filter(stockOut => {
                    if (!searchTerm) return true;
                    const orderCode = stockOut.resolvedOrderCode || 'N/A';
                    const stockOutDate = stockOut.stockOutDate ? formatDateToVietnamese(stockOut.stockOutDate) : 'N/A';
                    const note = stockOut.note || 'N/A';
                    const searchLower = searchTerm.toLowerCase();
                    return (
                        orderCode.toLowerCase().includes(searchLower) ||
                        stockOutDate.toLowerCase().includes(searchLower) ||
                        note.toLowerCase().includes(searchLower)
                    );
                });

                // Sort filtered stockouts
                const sortedStockOuts = await sortStockOuts(filteredResults);

                // Paginate sorted and filtered stockouts
                totalPages = Math.ceil(sortedStockOuts.length / pageSize);
                if (currentPage >= totalPages) {
                    currentPage = totalPages > 0 ? totalPages - 1 : 0;
                    updateURL(currentPage);
                }
                const startIndex = currentPage * pageSize;
                const paginatedStockOuts = sortedStockOuts.slice(startIndex, startIndex + pageSize);

                // Render table data
                await renderStockOuts(paginatedStockOuts, currentPage);

                // Render pagination
                if (totalPages > 1) {
                    renderPagination(totalPages, currentPage);
                } else {
                    $('#pagination-controls').empty();
                }

                tableContainer.removeClass('loading');
            } catch (error) {
                console.error('[ERROR] Failed to fetch stockouts:', {
                    url,
                    status: error.status || 'unknown',
                    statusText: error.statusText || 'unknown',
                    response: error.responseText ? error.responseText : 'No response body',
                    error: error.message || 'Unknown error'
                });
                tableBody.empty();
                noDataRow.show();
                tableContainer.removeClass('loading');
                renderPagination(0, 0);
                $.notify({ message: 'Không thể tải danh sách xuất kho. Vui lòng kiểm tra console.' }, { type: 'danger', delay: 5000 });
            }
        }

        // Pagination rendering (unchanged)
        function renderPagination(totalPagesInput, currentPageInput) {
            const paginationControls = $('#pagination-controls');
            paginationControls.empty();

            totalPages = typeof totalPagesInput === 'number' && totalPagesInput > 0 ? totalPagesInput : 1;
            currentPage = typeof currentPageInput === 'number' && currentPageInput >= 0 && currentPageInput < totalPages ? currentPageInput : 0;

            console.log('[DEBUG] Rendering pagination - total pages:', totalPages, 'current page:', currentPage);

            const addBtn = (label, page, disabled = false, active = false) => {
                const li = $('<li></li>').addClass('page-item');
                if (disabled) li.addClass('disabled');
                if (active) li.addClass('active');
                li.html(`<a class="page-link" href="javascript:void(0)" data-page="${page}">${label}</a>`);
                paginationControls.append(li);
            };

            const addEllipsis = () => {
                paginationControls.append('<li class="page-item disabled"><a class="page-link">...</a></li>');
            };

            const added = new Set();

            addBtn('Trước', currentPage - 1, currentPage === 0);
            addBtn(1, 0, false, currentPage === 0);
            added.add(0);

            if (currentPage <= 2) {
                for (let i = 1; i <= 3 && i < totalPages - 1; i++) {
                    if (!added.has(i)) {
                        addBtn(i + 1, i, false, currentPage === i);
                        added.add(i);
                    }
                }
                if (totalPages > 5) addEllipsis();
            } else if (currentPage >= 3 && currentPage <= totalPages - 3) {
                const range = [currentPage - 1, currentPage, currentPage + 1];
                for (let i of range) {
                    if (!added.has(i)) {
                        addBtn(i + 1, i, false, currentPage === i);
                        added.add(i);
                    }
                }
                addEllipsis();
            } else if (currentPage >= totalPages - 2) {
                if (!added.has(1)) {
                    addBtn(2, 1, false, currentPage === 1);
                    added.add(1);
                }
                if (totalPages > 5) addEllipsis();
                for (let i = totalPages - 3; i < totalPages - 1; i++) {
                    if (i > 1 && !added.has(i)) {
                        addBtn(i + 1, i, false, currentPage === i);
                        added.add(i);
                    }
                }
            }

            if (totalPages > 1 && !added.has(totalPages - 1)) {
                addBtn(totalPages, totalPages - 1, false, currentPage === totalPages - 1);
            }

            addBtn('Tiếp', currentPage + 1, currentPage === totalPages - 1);
        }

        // Handle pagination and sorting clicks
        $(document).on('click', '.page-link', function (e) {
            e.preventDefault();
            const page = parseInt($(this).data('page'));
            console.log('[DEBUG] Pagination clicked - page:', page, 'total pages:', totalPages);
            if (!isNaN(page) && page >= 0 && page < totalPages) {
                isPaginating = true;
                currentPage = page;
                fetchStockOuts(searchTerm, true);
                isPaginating = false;
            }
        });

        $(document).on('click', 'th.sortable', function () {
            const column = $(this).attr('data-sort');
            if (column) {
                if (column === sortColumn) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                console.log('[DEBUG] Sorting by:', sortColumn, sortDirection);
                currentPage = 0;
                fetchStockOuts(searchTerm);
            }
        });

        // Search functionality with debounce
        const debouncedSearch = debounce(function (searchValue) {
            console.log('[DEBUG] Search input:', searchValue, 'Resetting to page 0');
            searchTerm = searchValue;
            if (!isPaginating) {
                currentPage = 0;
            }
            fetchStockOuts(searchValue);
        }, 300);

        searchInputStockOut.on('input', function () {
            debouncedSearch($(this).val().trim());
        });

        // Initial fetch with URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialPage = parseInt(urlParams.get('page')) || 1;
        const initialSearch = urlParams.get('search') || '';
        currentPage = initialPage > 0 ? initialPage - 1 : 0;
        searchTerm = initialSearch;
        fetchStockOuts(searchTerm);
    });
</script>

</body>
</html>