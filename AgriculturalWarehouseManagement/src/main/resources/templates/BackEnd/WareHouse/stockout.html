<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="BackEnd/fragments/WareHouse/head::head"></head>

<body>
<!-- tap on top start-->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="BackEnd/fragments/WareHouse/header::header"></div>
    <!-- Page Header Ends-->

    <!-- Page Body Start-->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="BackEnd/fragments/WareHouse/sidebar::sidebar"></div>
        <!-- Page Sidebar Ends-->

        <!-- StockOut section Start -->
        <div class="page-body">
            <!-- Table Start -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-table">
                            <div class="card-body">
                                <div class="title-header option-title">
                                    <h5>StockOut List</h5>
                                    <a th:href="@{/warehouse/addstockout}" class="btn btn-solid">Add new StockOut</a>
                                </div>
                                <div>
                                    <div class="table-responsive">
                                        <table class="table all-package order-table theme-table" id="table_id">
                                            <thead>
                                            <tr>
                                                <th>StockOut ID</th>
                                                <th>Warehouse ID</th>
                                                <th>Order ID</th>
                                                <th>Date</th>
                                                <th>Note</th>
                                                <th>Option</th>
                                            </tr>
                                            </thead>
                                            <tbody id="stockOutTableBody">
                                            <!-- Dữ liệu sẽ được tải động bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Table End -->
        </div>
        <!-- StockOut section End -->
    </div>
    <!-- Page Body End-->
</div>
<!-- page-wrapper End -->

<!-- Modal start -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Logging Out</h5>
                <p>Are you sure you want to log out?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">No</button>
                    <button type="button" th:onclick="|window.location='@{backend/login}'|" class="btn btn--yes btn-primary">Yes</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal end -->

<!-- Delete Modal Box Start -->
<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header d-block text-center">
                <h5 class="modal-title w-100" id="exampleModalLabel22">Are You Sure ?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box">
                    <p>Are you sure you want to delete this StockOut?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-animation btn-md fw-bold" id="confirmDeleteBtn">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center" id="exampleModalLabel12">Done!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box text-center">
                    <div class="wrapper">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h4 class="text-content">StockOut removed successfully.</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Delete Modal Box End -->

<!-- Offcanvas Box Start -->
<div class="offcanvas offcanvas-end order-offcanvas" tabindex="-1" id="order-details"
     aria-labelledby="offcanvasExampleLabel" aria-expanded="false">
    <div class="offcanvas-header">
        <h4 class="offcanvas-title" id="offcanvasExampleLabel">StockOut #<span id="offcanvasStockOutId"></span></h4>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="offcanvas-body">
        <div class="order-date">
            <h6 id="offcanvasStockOutDate"></h6>
            <a href="javascript:void(0)" class="d-block mt-1">Cancel StockOut</a>
        </div>

        <div class="accordion accordion-flush custome-accordion" id="accordionFlushExample">
            <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingOne">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                        Details
                    </button>
                </h2>
                <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne"
                     data-bs-parent="#accordionFlushExample">
                    <div class="accordion-body">
                        <p><strong>Warehouse ID:</strong> <span id="offcanvasWarehouseId"></span></p>
                        <p><strong>Order ID:</strong> <span id="offcanvasOrderId"></span></p>
                        <p><strong>Note:</strong> <span id="offcanvasNote"></span></p>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                        StockOut Details
                    </button>
                </h2>
                <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo"
                     data-bs-parent="#accordionFlushExample">
                    <div class="accordion-body">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>Order Detail ID</th>
                                <th>Batch ID</th>
                                <th>Quantity</th>
                            </tr>
                            </thead>
                            <tbody id="stockOutDetailTable">
                            <!-- Dữ liệu sẽ được tải động -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Offcanvas Box End -->

<!-- Latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/Backend/assets/js/config.js}"></script>
<script th:src="@{/Backend/assets/js/customizer.js}"></script>
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>
<script th:src="@{/Backend/assets/js/script.js}"></script>
<script th:src="@{/Backend/assets/js/checkbox-all-check.js}"></script>

<!-- Custom JavaScript -->
<!-- Chỉ hiển thị phần <script> đã sửa đổi; các phần khác giữ nguyên -->
<script>
    $(document).ready(function() {
        // Tải dữ liệu StockOut
        function loadStockOuts() {
            $.ajax({
                url: 'http://localhost:8080/api/stockouts',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    var tbody = $('#stockOutTableBody');
                    tbody.empty();
                    $.each(data, function(index, stockOut) {
                        // Chỉ lấy tên Warehouse
                        $.ajax({
                            url: 'http://localhost:8080/api/warehouses/' + stockOut.warehouseID,
                            method: 'GET',
                            dataType: 'json',
                            success: function(warehouseResponse) {
                                var warehouseName = warehouseResponse.warehouseName || 'N/A';
                                var orderDisplay = stockOut.orderID ? `Đơn hàng #${stockOut.orderID}` : 'N/A';
                                var row = '<tr data-bs-toggle="offcanvas" data-bs-target="#order-details" data-stockout-id="' + stockOut.id + '">' +
                                    '<td>' + stockOut.id + '</td>' +
                                    '<td>' + warehouseName + '</td>' +
                                    '<td>' + orderDisplay + '</td>' +
                                    '<td>' + (stockOut.stockOutDate ? new Date(stockOut.stockOutDate).toLocaleDateString() : 'N/A') + '</td>' +
                                    '<td>' + (stockOut.note || 'N/A') + '</td>' +
                                    '<td>' +
                                    '<ul>' +
                                    '<li><a href="/warehouse/stockoutdetail?stockOutId=' + stockOut.id + '" class="view-detail"><i class="ri-eye-line"></i></a></li>' +
                                    '<li><a href="javascript:void(0)"><i class="ri-pencil-line"></i></a></li>' +
                                    '<li><a href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" data-stockout-id="' + stockOut.id + '"><i class="ri-delete-bin-line"></i></a></li>' +
                                    '<li><a class="btn btn-sm btn-solid text-white" href="order-tracking.html">Theo dõi</a></li>' +
                                    '</ul>' +
                                    '</td>' +
                                    '</tr>';
                                tbody.append(row);
                            },
                            error: function(jqXHR, textStatus, errorThrown) {
                                console.error('Lỗi khi lấy Warehouse: ', textStatus, errorThrown);
                                var orderDisplay = stockOut.orderID ? `Đơn hàng #${stockOut.orderID}` : 'N/A';
                                var row = '<tr data-bs-toggle="offcanvas" data-bs-target="#order-details" data-stockout-id="' + stockOut.id + '">' +
                                    '<td>' + stockOut.id + '</td>' +
                                    '<td>N/A</td>' +
                                    '<td>' + orderDisplay + '</td>' +
                                    '<td>' + (stockOut.stockOutDate ? new Date(stockOut.stockOutDate).toLocaleDateString() : 'N/A') + '</td>' +
                                    '<td>' + (stockOut.note || 'N/A') + '</td>' +
                                    '<td>' +
                                    '<ul>' +
                                    '<li><a href="/warehouse/stockoutdetail?stockOutId=' + stockOut.id + '" class="view-detail"><i class="ri-eye-line"></i></a></li>' +
                                    '<li><a href="javascript:void(0)"><i class="ri-pencil-line"></i></a></li>' +
                                    '<li><a href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" data-stockout-id="' + stockOut.id + '"><i class="ri-delete-bin-line"></i></a></li>' +
                                    '<li><a class="btn btn-sm btn-solid text-white" href="order-tracking.html">Theo dõi</a></li>' +
                                    '</ul>' +
                                    '</td>' +
                                    '</tr>';
                                tbody.append(row);
                            }
                        });
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi tải StockOuts: ', status, error);
                    $('#stockOutTableBody').html('<tr><td colspan="6">Không thể tải dữ liệu. Kiểm tra console.</td></tr>');
                }
            });
        }

        // Tải chi tiết StockOut và StockOutDetails vào offcanvas
        $(document).on('show.bs.offcanvas', '#order-details', function(event) {
            var stockOutId = $(event.relatedTarget).data('stockout-id');
            $('#offcanvasStockOutId').text(stockOutId);
            $.when(
                $.ajax({ url: 'http://localhost:8080/api/stockouts/' + stockOutId, method: 'GET', dataType: 'json' }),
                $.ajax({ url: 'http://localhost:8080/api/stockoutdetails/stockout/' + stockOutId, method: 'GET', dataType: 'json' })
            ).done(function(stockOutResponse, stockOutDetailsResponse) {
                var stockOut = stockOutResponse[0];
                var stockOutDetails = stockOutDetailsResponse[0];
                $('#offcanvasStockOutDate').text(stockOut.stockOutDate ? new Date(stockOut.stockOutDate).toLocaleString() : 'N/A');
                $('#offcanvasWarehouseId').text(stockOut.warehouseID ? stockOut.warehouseID : 'N/A');
                $('#offcanvasOrderId').text(stockOut.orderID ? stockOut.orderID : 'N/A');
                $('#offcanvasNote').text(stockOut.note || 'N/A');

                // Tải StockOutDetails
                var detailTbody = $('#stockOutDetailTable');
                detailTbody.empty();
                $.each(stockOutDetails, function(index, detail) {
                    var row = '<tr>' +
                        '<td>' + (detail.orderDetailID || 'N/A') + '</td>' +
                        '<td>' + (detail.batchID || 'N/A') + '</td>' +
                        '<td>' + (detail.quantity || 'N/A') + '</td>' +
                        '</tr>';
                    detailTbody.append(row);
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Lỗi khi tải chi tiết StockOut: ', textStatus, errorThrown);
            });
        });

        // Xóa StockOut
        $('#confirmDeleteBtn').on('click', function() {
            var stockOutId = $('#exampleModalToggle').data('stockout-id');
            if (stockOutId) {
                $.ajax({
                    url: 'http://localhost:8080/api/stockouts/' + stockOutId,
                    method: 'DELETE',
                    success: function() {
                        $('#exampleModalToggle').modal('hide');
                        $('#exampleModalToggle2').modal('show');
                        loadStockOuts(); // Tải lại bảng sau khi xóa
                    },
                    error: function(xhr, status, error) {
                        console.error('Lỗi khi xóa StockOut: ', status, error);
                        alert('Không thể xóa StockOut. Kiểm tra console.');
                    }
                });
            }
        });

        // Gán stockout-id cho modal xóa
        $(document).on('click', '[data-bs-target="#exampleModalToggle"]', function() {
            var stockOutId = $(this).data('stockout-id');
            $('#exampleModalToggle').data('stockout-id', stockOutId);
        });

        // Khởi tạo bảng
        loadStockOuts();
    });
</script>

</body>
</html>