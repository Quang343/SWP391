<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start -->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end -->

<!-- page-wrapper start -->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body start -->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
        <!-- Page Sidebar Ends-->

        <div class="page-body">
            <!-- New Product Batch Add Start -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="row">
                            <div class="col-sm-8 m-auto">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="card-header-2">
                                            <h5>Thêm Product Batch</h5>
                                        </div>

                                        <form id="productBatchForm" class="theme-form theme-form-2 mega-form">
                                            <div class="mb-4 row align-items-center">
                                                <label class="form-label-title col-sm-3 mb-0">Product Detail</label>
                                                <div class="col-sm-9">
                                                    <select id="productDetailId" name="productDetailID" class="js-example-basic-single w-100" required>
                                                        <option value="" disabled selected>Chọn Product Detail</option>
                                                        <!-- Options sẽ được populated động -->
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="mb-4 row align-items-center">
                                                <label class="col-sm-3 col-form-label form-label-title">Ngày sản xuất</label>
                                                <div class="col-sm-9">
                                                    <input id="manufactureDate" name="manufactureDate" class="form-control" type="date" required>
                                                </div>
                                            </div>

                                            <div class="mb-4 row align-items-center">
                                                <label class="col-sm-3 col-form-label form-label-title">Số lượng nhập</label>
                                                <div class="col-sm-9">
                                                    <input id="importedQuantity" name="importedQuantity" class="form-control" type="number" min="1" step="1" value="1" required>
                                                </div>
                                            </div>

                                            <div class="card-submit-button">
                                                <button id="submitProductBatch" class="btn btn-animation ms-auto" type="button">Submit</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- New Product Batch Add End -->

            <!-- footer Start -->
            <div class="container-fluid">
                <footer class="footer">
                    <div class="row">
                        <div class="col-md-12 footer-copyright text-center">
                            <p class="mb-0">Copyright 2022 © Fastkart theme by pixelstrap</p>
                        </div>
                    </div>
                </footer>
            </div>
            <!-- footer End -->
        </div>
        <!-- Container-fluid End -->
    </div>
    <!-- Page Body End -->
</div>
<!-- page-wrapper End -->

<!-- Modal Start -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Đăng xuất</h5>
                <p>Bạn có chắc chắn muốn đăng xuất?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
                    <button type="button" th:onclick="|window.location='@{/backend/login}'|" class="btn btn--yes btn-primary">Có</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>

<!-- Bootstrap js -->
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>

<!-- feather icon js -->
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>

<!-- scrollbar simplebar js -->
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>

<!-- Sidebar js -->
<script th:src="@{/Backend/assets/js/config.js}"></script>

<!-- customizer js -->
<script th:src="@{/Backend/assets/js/customizer.js}"></script>

<!-- Plugins js -->
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>

<!-- Data table js -->
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>

<!-- sidebar effect -->
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>

<!-- Theme js -->
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- JavaScript cho form ProductBatch -->
<script>
    if (typeof $ === 'undefined') {
        console.error('jQuery không được tải. Kiểm tra đường dẫn: /Backend/assets/js/jquery-3.6.0.min.js');
        alert('jQuery không hoạt động được hỗ trợ. Vui lòng kiểm tra console.');
    } else {
        $(document).ready(function() {
            // Populate ProductDetail dropdown
            $.ajax({
                url: '/api/product-details',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log('Phản hồi từ /api/product-details: ', data);
                    var select = $('#productDetailId');
                    select.empty();
                    select.append('<option value="" disabled selected>Chọn Product Detail</option>');

                    if (!data || data.length === 0) {
                        console.warn('Không có ProductDetails.');
                        select.append('<option value="" disabled>Không có Product Detail</option>');
                        select.prop('disabled', true);
                        alert('Không có ProductDetail nào để chọn.');
                        return;
                    }

                    console.log('Kiểm tra trường productDetailId trong dữ liệu:', data[0]);
                    $.each(data, function(index, detail) {
                        var id = detail.productDetailId || detail.id;
                        if (id) {
                            select.append(`<option value="${id}">${detail.detailName || 'Không có tên'} (ID: ${id})</option>`);
                            console.log(`Đã thêm option: ID=${id}, Name=${detail.detailName}`);
                        } else {
                            console.warn('Dữ liệu không có productDetailId hoặc id: ', detail);
                        }
                    });
                }, error: function(xhr, status, error) {
                    console.error('Lỗi khi lấy ProductDetails: ', status, error, xhr.responseText);
                    alert('Không thể tải danh sách Product Detail. Kiểm tra console.');
                }
            });

            // Xử lý sự kiện click nút Submit
            $('#submitProductBatch').on('click', function() {
                // Lấy giá trị từ form
                var productDetailId = $('#productDetailId').val();
                var manufactureDate = $('#manufactureDate').val();
                var importedQuantity = $('#importedQuantity').val();

                // Kiểm tra giá trị dropdown
                console.log('Giá trị productDetailId được chọn: ', productDetailId);

                // Kiểm tra nghiêm ngặt
                if (!productDetailId || productDetailId === '' || isNaN(parseInt(productDetailId))) {
                    console.error('productDetailID không hợp lệ: ', productDetailId);
                    alert('Vui lòng chọn một Product Detail hợp lệ.');
                    return;
                }
                if (!manufactureDate) {
                    console.error('manufactureDate không hợp lệ: ', manufactureDate);
                    alert('Vui lòng chọn ngày sản xuất.');
                    return;
                }
                if (!importedQuantity || parseInt(importedQuantity) < 1) {
                    console.error('importedQuantity không hợp lệ: ', importedQuantity);
                    alert('Vui lòng nhập số lượng hợp lệ (tối thiểu 1).');
                    return;
                }

                // Tạo payload khớp với backend
                var formData = {
                    productDetailID: parseInt(productDetailId),
                    manufactureDate: manufactureDate,
                    importedQuantity: parseInt(importedQuantity)
                };

                console.log('Gửi payload tới /api/product-batches: ', formData);

                // Gửi yêu cầu AJAX
                $.ajax({
                    url: '/api/product-batches',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    dataType: 'json',
                    success: function(response) {
                        console.log('ProductBatch đã được thêm: ', response);
                        alert('Thêm ProductBatch thành công');
                        $('#productBatchForm')[0].reset();
                        $('#productDetailId').val('');
                    }, error: function(xhr, status, error) {
                        console.error('Lỗi khi thêm ProductBatch: ', status, error, xhr.responseText);
                        alert('Lỗi khi thêm ProductBatch: ' + xhr.responseText);
                    }
                });
            });

            // Đảm bảo input importedQuantity có hành vi spinner
            $('#importedQuantity').on('input', function() {
                var value = parseInt($(this).val());
                if (isNaN(value) || value < 1) {
                    $(this).val(1);
                }
            });

            // Gỡ lỗi lựa chọn dropdown
            $('#productDetailId').on('change', function() {
                var selectedValue = $(this).val();
                console.log('Đã chọn productDetailID: ', selectedValue);
                if (selectedValue) {
                    console.log('Option đã chọn: ', $(this).find('option:selected').text());
                }
            });
        });
    }
</script>

</body>

</html>