<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>
<style>
    /* Ensure table is scrollable horizontally if content overflows */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 0; /* Remove extra margin to keep pagination close */
        position: relative; /* Context for scrollbar */
    }

    /* Ensure table takes full width but triggers scrollbar if needed */
    #table_id {
        width: 100%;
        min-width: 1000px; /* Force horizontal scrollbar for wide content */
    }

    /* Override gray borders from Bootstrap for table */
    #table_id.table,
    #table_id th,
    #table_id td {
        border-color: #e6f3f2 !important; /* Light green border */
    }

    /* Center pagination and style items */
    #pagination-controls {
        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center;
        margin-top: 12px; /* Ensure below scrollbar */
        margin-bottom: 20px; /* Space below pagination */
        position: relative; /* Ensure proper stacking */
        z-index: 10; /* Below footer and sidebar */
        max-width: 100%; /* Prevent overflow */
    }

    #pagination-controls .page-item {
        margin: 0 2.5px; /* 5px gap between items */
    }

    #pagination-controls .page-link {
        border-radius: 4px;
        padding: 6px 12px;
        color: #018F84; /* Text color for number pages */
        font-size: 14px; /* Match theme typography */
        cursor: pointer; /* Ensure clickable appearance */
        border: 1px solid #018F84; /* Border matches theme */
        background-color: transparent; /* Default background */
        text-align: center;
        box-sizing: border-box;
    }

    /* Style for Previous and Next buttons */
    #pagination-controls .page-item:first-child .page-link,
    #pagination-controls .page-item:last-child .page-link {
        background-color: #018F84; /* Green background */
        color: #fff; /* White text */
        border-color: #018F84;
    }

    /* Style for active page */
    #pagination-controls .page-item.active .page-link {
        background-color: #018F84; /* Green background */
        border-color: #018F84;
        color: #fff;
        box-shadow: none; /* No glowing effect */
    }

    /* Style for disabled buttons */
    #pagination-controls .page-item.disabled .page-link {
        color: #018F84; /* Green text */
        border-color: #e6f3f2; /* Light green border */
        background-color: #e6f3f2; /* Light green background */
        pointer-events: none;
        cursor: default;
    }

    /* Hover effect for non-disabled, non-active number pages */
    #pagination-controls .page-link:hover:not(.disabled .page-link):not(.active .page-link):not(:first-child .page-link):not(:last-child .page-link) {
        background-color: #e6f3f2; /* Light green on hover */
        color: #018F84;
    }

    /* Hover effect for Previous/Next when not disabled */
    #pagination-controls .page-item:not(.disabled):first-child .page-link:hover,
    #pagination-controls .page-item:not(.disabled):last-child .page-link:hover {
        background-color: #016f6a; /* Darker green on hover */
        color: #fff;
    }

    /* Ensure footer is above pagination but below sidebar */
    .footer {
        z-index: 20 !important; /* Above pagination */
    }

    /* Ensure sidebar is above footer and pagination */
    .sidebar-wrapper {
        position: fixed;
        z-index: 30 !important; /* Above footer and pagination */
    }

    /* Ensure modals and offcanvas are above sidebar, footer, and pagination */
    .modal,
    .offcanvas {
        z-index: 1050 !important; /* Above sidebar, footer, and pagination */
    }

    .modal-backdrop {
        z-index: 1040 !important; /* Below modal/offcanvas, above sidebar and footer */
    }

    /* Style for search bar and button */
    .btn-theme {
        background-color: #018F84;
        color: #fff;
        border-color: #018F84;
    }

    .btn-theme:hover {
        background-color: #016f6a;
        color: #fff;
        border-color: #016f6a;
    }

    .search-bar input {
        border: 1px solid #e6f3f2;
    }

    .search-bar input:focus {
        border-color: #018F84;
        box-shadow: 0 0 5px rgba(1, 143, 132, 0.3);
    }
</style>
<body>
<!-- tap on top start-->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body Start-->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
        <!-- Page Sidebar Ends-->

        <!-- Container-fluid starts-->
        <div class="page-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-table">
                            <div class="card-body">
                                <div class="title-header option-title">
                                    <!-- Dòng 1: chỉ Danh Sách Điều Chỉnh -->
                                    <div class="first-line">
                                        <h5>Danh Sách Điều Chỉnh</h5>
                                    </div>

                                    <!-- Dòng 2: Thêm Điều Chỉnh và Tìm Kiếm bên phải -->
                                    <div class="second-line" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                                        <a th:href="@{/warehouse/addadjustment}" class="align-items-center btn btn-theme d-flex">
                                            <i data-feather="plus"></i> Thêm Điều Chỉnh
                                        </a>
                                        <div class="search-bar">
                                            <input type="text" class="form-control" placeholder="Tìm kiếm..." id="searchInput">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="table-responsive">
                                        <table class="table all-package theme-table table-product" id="table_id">
                                            <thead>
                                            <tr>
                                                <th>Mã Điều Chỉnh</th>
                                                <th>Mã Lô Hàng</th>
                                                <th>Số Lượng</th>
                                                <th>Ngày Điều Chỉnh</th>
                                                <th>Lý Do</th>
                                                <th>Loại</th>
                                                <th>Hành Động</th>
                                            </tr>
                                            </thead>
                                            <tbody id="adjustmentTableBody">
                                            <!-- Dữ liệu sẽ được thêm động bởi JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Pagination Controls -->
                                    <ul id="pagination-controls" class="pagination"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Container-fluid Ends-->

            <div th:replace="~{BackEnd/fragments/WareHouse/footer::footer}"></div>
        </div>
    </div>
</div>
<!-- page-wrapper End-->

<!-- Modal Đăng Xuất -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Đăng Xuất</h5>
                <p>Bạn có chắc chắn muốn đăng xuất?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
                    <button type="button" th:onclick="|window.location='@{backend/login}'|" class="btn btn--yes btn-primary">Có</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<!-- Modal Sửa Điều Chỉnh -->
<div class="modal fade" id="editAdjustmentModal" tabindex="-1" aria-labelledby="editAdjustmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAdjustmentModalLabel">Sửa Điều Chỉnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAdjustmentForm">
                    <input type="hidden" id="editAdjustmentId">
                    <div class="mb-3">
                        <label for="editBatchId" class="form-label">Lô Sản Phẩm (Tùy Chọn)</label>
                        <select class="form-select" id="editBatchId">
                            <option value="">Không chọn</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editQuantity" class="form-label">Số Lượng Điều Chỉnh</label>
                        <input type="number" class="form-control" id="editQuantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="editReason" class="form-label">Lý Do</label>
                        <textarea class="form-control" id="editReason" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAdjustmentType" class="form-label">Loại Điều Chỉnh</label>
                        <select class="form-select" id="editAdjustmentType" required>
                            <option value="Add">Nhập Thêm</option>
                            <option value="Remove">Hao Hụt</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="saveEditAdjustment">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal Box Start -->
<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header d-block text-center">
                <h5 class="modal-title w-100" id="exampleModalLabel22">Bạn Có Chắc Chắn?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box">
                    <p>Bạn có chắc chắn muốn xóa Điều Chỉnh này?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">Không</button>
                <button type="button" class="btn btn-animation btn-md fw-bold confirm-delete">Có</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center" id="exampleModalLabel12">Hoàn Thành!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box text-center">
                    <div class="wrapper">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h4 class="text-content">Đã Xóa.</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<!-- Delete Modal Box End -->

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>

<!-- Bootstrap js -->
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>

<!-- feather icon js -->
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>

<!-- scrollbar simplebar js -->
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>

<!-- Sidebar js -->
<script th:src="@{/Backend/assets/js/config.js}"></script>

<!-- customizer js -->
<script th:src="@{/Backend/assets/js/customizer.js}"></script>

<!-- Plugins js -->
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>

<!-- Data table js -->
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>

<!-- sidebar effect -->
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>

<!-- Theme js -->
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom JS for API call -->
<script>
    function formatDateToVietnamese(dateString) {
        if (!dateString || dateString === 'N/A') {
            return 'N/A';
        }
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                console.warn('[CẢNH BÁO] Ngày không hợp lệ:', dateString);
                return 'N/A';
            }
            // Cộng 7 tiếng nếu dữ liệu trả về là UTC
            const vnTime = new Date(date.getTime());
            const day = String(vnTime.getDate()).padStart(2, '0');
            const month = String(vnTime.getMonth() + 1).padStart(2, '0');
            const year = vnTime.getFullYear();
            const hours = String(vnTime.getHours()).padStart(2, '0');
            const minutes = String(vnTime.getMinutes()).padStart(2, '0');
            const seconds = String(vnTime.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
        } catch (error) {
            console.error('[LỖI] Lỗi phân tích ngày:', dateString, error);
            return 'N/A';
        }
    }

    // Format batchID to custom format: BAT + [First letter of supplier] + "-" + [ID + 1000 in Base36] + "-" + [Manufacture date as MMdd]
    function formatBatchID(batchID, manufactureDate) {
        try {


            // Convert ID + 1000 to Base36
            const offsetID = parseInt(batchID) + 1000;
            const base36ID = offsetID.toString(36).toUpperCase();

            // Format manufacture date to MMdd
            let datePart = '0000';
            if (manufactureDate && manufactureDate !== 'N/A') {
                const date = new Date(manufactureDate);
                if (!isNaN(date.getTime())) {
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    datePart = `${month}${day}`;
                }
            }

            return `BAT-${base36ID}-${datePart}`;
        } catch (error) {
            console.error('[ERROR] Error formatting batchID:', batchID, error);
            return batchID || 'N/A';
        }
    }

    $(document).ready(function() {
        // Disable DataTables to prevent interference
        if ($.fn.DataTable && $.fn.DataTable.isDataTable('#table_id')) {
            $('#table_id').DataTable().destroy();
            console.log('DataTables disabled for #table_id');
        }

        let currentPage = 0; // 0-based internally
        let totalPages = 1; // Global variable to track total pages
        const pageSize = 5;
        let batchData = {}; // Store batch data for mapping

        // Bind pagination click events at the document level
        $(document).off('click.pagination', '#pagination-controls .page-link').on('click.pagination', '#pagination-controls .page-link', function(e) {
            e.preventDefault();
            const page = parseInt($(this).data('page'));
            console.log('Nhấn phân trang - trang:', page, 'tổng số trang:', totalPages);
            if (!isNaN(page) && page >= 0 && page < totalPages) {
                fetchAdjustments(page);
            }
        });

        // Debug pagination DOM
        function debugPagination() {
            const paginationItems = $('#pagination-controls .page-link');
            console.log('Số mục phân trang:', paginationItems.length, 'HTML:', $('#pagination-controls').html());
        }

        // Fetch all product batches to get supplierName and manufactureDate
        function fetchAllProductBatches() {
            return $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/api/product-batches',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    batchData = {};
                    $.each(data, function(index, batch) {
                        let supplierName = 'Unknown';
                        let manufactureDate = batch.manufactureDate || 'N/A';
                        try {
                            $.ajax({
                                url: `/AgriculturalWarehouseManagementApplication/api/product-details/${batch.productDetailID}`,
                                method: 'GET',
                                async: false,
                                dataType: 'json',
                                success: function(detail) {
                                    supplierName = detail.supplierName || 'Unknown';
                                },
                                error: function(xhr, status, error) {
                                    console.error(`[ERROR] Lỗi khi tải Chi Tiết Sản Phẩm cho ID ${batch.productDetailID}:`, status, error);
                                }
                            });
                        } catch (error) {
                            console.error(`[ERROR] Lỗi khi tải Chi Tiết Sản Phẩm cho ID ${batch.productDetailID}:`, error);
                        }
                        const id = batch.batchID || batch.id;
                        batchData[id] = {
                            batchId: id,
                            supplierName: supplierName,
                            manufactureDate: manufactureDate
                        };
                    });
                    console.log('[DEBUG] Batch data loaded:', batchData);
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi tải danh sách Lô:', status, error);
                    $.notify({ message: 'Không thể tải danh sách Lô. Vui lòng kiểm tra console.' }, { type: 'danger', delay: 3000 });
                }
            });
        }

        // Populate Batch dropdown
        function populateBatchDropdown(selectElement, selectedId) {
            $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/api/product-batches',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    selectElement.empty();
                    selectElement.append('<option value="">Không chọn</option>');
                    if (!data || data.length === 0) {
                        return;
                    }
                    $.each(data, function(index, batch) {
                        const id = batch.batchID || batch.id;
                        if (id) {
                            const formattedBatchID = formatBatchID(id, batchData[id]?.manufactureDate, batchData[id]?.supplierName);
                            const selected = id == selectedId ? 'selected' : '';
                            selectElement.append(`<option value="${id}" ${selected}>${formattedBatchID}</option>`);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi tải danh sách Lô:', status, error);
                    $.notify({ message: 'Không thể tải danh sách Lô. Vui lòng kiểm tra console.' }, { type: 'danger', delay: 3000 });
                }
            });
        }

        function ensureElements() {
            let tableBody = $('#adjustmentTableBody');
            let noDataRow = $('#no-data-row');

            if (!tableBody.length) {
                const table = $('#table_id');
                if (table.length) {
                    tableBody = $('<tbody id="adjustmentTableBody"></tbody>');
                    table.append(tableBody);
                } else {
                    console.error('Table #table_id not found');
                    return null;
                }
            }

            if (!noDataRow.length) {
                noDataRow = $('<tr id="no-data-row"><td colspan="7" class="text-center">Không có dữ liệu trong bảng</td></tr>');
                tableBody.append(noDataRow);
            }

            return { tableBody, noDataRow };
        }

        function updateURL(page) {
            history.pushState({}, '', `?page=${page + 1}`); // 1-based for URL
        }

        function fetchAdjustments(page = 0) {
            currentPage = page;
            updateURL(page);
            const { tableBody, noDataRow } = ensureElements();
            if (!tableBody || !noDataRow) return;

            console.log('Đang tải điều chỉnh cho trang:', page);

            // Fetch batches first to ensure batchData is populated
            $.when(fetchAllProductBatches()).done(function() {
                $.ajax({
                    url: `/AgriculturalWarehouseManagementApplication/api/adjustments/paginatedAdjustment?page=${page}&size=${pageSize}`,
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log('Phản hồi API:', data);
                        if (!data || !data.content || typeof data.totalPages === 'undefined' || typeof data.number === 'undefined') {
                            console.error('Dữ liệu phản hồi không hợp lệ:', data);
                            tableBody.empty();
                            noDataRow.show();
                            renderPagination(0, 0);
                            return;
                        }

                        totalPages = data.totalPages; // Update global totalPages
                        tableBody.empty();

                        if (data.content && data.content.length > 0) {
                            noDataRow.hide();
                            $.each(data.content, function(index, adjustment) {
                                var batchId = adjustment.batchId;
                                var mappedBatchId = batchData[batchId]
                                    ? formatBatchID(batchId, batchData[batchId].manufactureDate, batchData[batchId].supplierName)
                                    : batchId || 'N/A';

                                var row = $('<tr></tr>').attr('data-id', adjustment.id || '');
                                row.append(`<td>${adjustment.id || 'N/A'}</td>`);
                                row.append(`<td>${mappedBatchId}</td>`);
                                row.append(`<td>${adjustment.quantity || 'N/A'}</td>`);
                                row.append(`<td>${formatDateToVietnamese(adjustment.adjustDate)}</td>`);
                                row.append(`<td>${adjustment.reason || 'N/A'}</td>`);
                                row.append(`<td>${adjustment.adjustmentType === 'Add' ? 'Nhập Thêm' : adjustment.adjustmentType === 'Remove' ? 'Hao Hụt' : 'N/A'}</td>`);
                                row.append(`
                                    <td>
                                        <ul class="action-list">
                                            <li><a href="javascript:void(0)" class="edit-adjustment" data-adjustment-id="${adjustment.id || ''}" data-batch-id="${batchId || ''}" data-quantity="${adjustment.quantity || ''}" data-reason="${adjustment.reason || ''}" data-adjustment-type="${adjustment.adjustmentType || ''}"><i class="ri-pencil-line"></i></a></li>
                                            <li><a href="javascript:void(0)" class="delete-adjustment" data-adjustment-id="${adjustment.id || ''}"><i class="ri-delete-bin-line"></i></a></li>
                                        </ul>
                                    </td>
                                `);
                                tableBody.append(row);
                            });

                            bindActionEvents();
                        } else {
                            noDataRow.show();
                        }

                        renderPagination(data.totalPages, data.number);
                        debugPagination();
                    },
                    error: function(xhr, status, error) {
                        console.error('Lỗi khi tải Điều Chỉnh:', status, error);
                        $.notify({ message: 'Không thể tải danh sách Điều Chỉnh. Vui lòng kiểm tra console.' }, { type: 'danger', delay: 3000 });
                        tableBody.empty();
                        noDataRow.show();
                        renderPagination(0, 0);
                        debugPagination();
                    }
                });
            });
        }

        function bindActionEvents() {
            $('.edit-adjustment').off('click.edit').on('click.edit', function() {
                var adjustmentId = $(this).data('adjustment-id');
                var batchId = $(this).data('batch-id');
                var quantity = $(this).data('quantity');
                var reason = $(this).data('reason');
                var adjustmentType = $(this).data('adjustment-type');

                if (!adjustmentId) {
                    $.notify({ message: 'ID Điều Chỉnh không hợp lệ.' }, { type: 'warning', delay: 3000 });
                    return;
                }

                $('#editAdjustmentId').val(adjustmentId);
                $('#editQuantity').val(quantity);
                $('#editReason').val(reason);
                $('#editAdjustmentType').val(adjustmentType);
                populateBatchDropdown($('#editBatchId'), batchId);

                $('#editAdjustmentModal').modal('show');
            });

            $('.delete-adjustment').off('click.delete').on('click.delete', function(e) {
                e.preventDefault();
                var adjustmentId = $(this).data('adjustment-id');
                if (!adjustmentId) {
                    $.notify({ message: 'ID Điều Chỉnh không hợp lệ.' }, { type: 'warning', delay: 3000 });
                    return;
                }
                $('.confirm-delete').data('adjustment-id', adjustmentId);
                $('#exampleModalToggle').modal('show');
            });
        }

        function renderPagination(totalPagesInput, currentPageInput) {
            const paginationControls = $('#pagination-controls');
            paginationControls.empty();

            totalPages = typeof totalPagesInput === 'number' && totalPagesInput > 0 ? totalPagesInput : 1;
            currentPage = typeof currentPageInput === 'number' && currentPageInput >= 0 && currentPageInput < totalPages ? currentPageInput : 0;

            console.log('Đang hiển thị phân trang - tổng số trang:', totalPages, 'trang hiện tại:', currentPage);

            const addBtn = (label, page, disabled = false, active = false) => {
                const li = $('<li></li>').addClass('page-item');
                if (disabled) li.addClass('disabled');
                if (active) li.addClass('active');
                li.html(`<a class="page-link" href="javascript:void(0)" data-page="${page}">${label}</a>`);
                paginationControls.append(li);
            };

            // Previous button
            addBtn('Trước', currentPage - 1, currentPage === 0);

            // Always show first page
            addBtn(1, 0, false, currentPage === 0);

            // If totalPages is 1, only show page 1
            if (totalPages === 1) {
                return;
            }

            // Show up to 3 pages around currentPage, avoiding duplicates
            const startPage = Math.max(2, currentPage);
            const endPage = Math.min(totalPages - 1, currentPage + 2);

            if (totalPages > 3 && currentPage > 1) {
                paginationControls.append('<li class="page-item disabled"><a class="page-link">...</a></li>');
            }

            for (let i = startPage; i <= endPage; i++) {
                addBtn(i, i - 1, false, currentPage === i - 1);
            }

            if (totalPages > 4 && currentPage < totalPages - 2) {
                paginationControls.append('<li class="page-item disabled"><a class="page-link">...</a></li>');
            }

            // Always show last page if totalPages > 1
            if (totalPages > 1) {
                addBtn(totalPages, totalPages - 1, false, currentPage === totalPages - 1);
            }

            // Next button
            addBtn('Tiếp', currentPage + 1, currentPage === totalPages - 1);
        }

        // Save Edited Adjustment
        $(document).on('click', '#saveEditAdjustment', function() {
            var adjustmentId = $('#editAdjustmentId').val();
            var batchId = $('#editBatchId').val() || null;
            var quantity = $('#editQuantity').val();
            var reason = $('#editReason').val();
            var adjustmentType = $('#editAdjustmentType').val();

            if (!quantity || isNaN(parseInt(quantity))) {
                $.notify({ message: 'Vui lòng nhập số lượng hợp lệ.' }, { type: 'warning', delay: 3000 });
                return;
            }
            if (!adjustmentType) {
                $.notify({ message: 'Vui lòng chọn loại Điều Chỉnh.' }, { type: 'warning', delay: 3000 });
                return;
            }

            var formData = {
                batchId: batchId ? parseInt(batchId) : null,
                quantity: parseInt(quantity),
                reason: reason || null,
                adjustmentType: adjustmentType
            };

            $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/api/adjustments/' + adjustmentId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                dataType: 'json',
                success: function(response) {
                    $.notify({ message: 'Cập nhật Điều Chỉnh thành công!' }, { type: 'success', delay: 3000 });
                    $('#editAdjustmentModal').modal('hide');
                    $('.modal-backdrop').remove(); // Ensure backdrop is removed
                    $('body').removeClass('modal-open').css('overflow', '');
                    fetchAdjustments(currentPage);
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi sửa Điều Chỉnh:', status, error);
                    $.notify({ message: 'Lỗi khi sửa Điều Chỉnh: ' + (xhr.responseText || 'Vui lòng kiểm tra console.') }, { type: 'danger', delay: 3000 });
                    $('#editAdjustmentModal').modal('hide');
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css('overflow', '');
                }
            });
        });

        // Confirm Delete Adjustment
        $(document).on('click', '.confirm-delete', function(e) {
            e.preventDefault();
            var adjustmentId = $(this).data('adjustment-id');
            if (!adjustmentId) {
                $.notify({ message: 'ID Điều Chỉnh không hợp lệ.' }, { type: 'warning', delay: 3000 });
                return;
            }

            $.ajax({
                url: '/AgriculturalWarehouseManagementApplication/api/adjustments/' + adjustmentId,
                method: 'DELETE',
                headers: { 'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') },
                success: function() {
                    $('#exampleModalToggle').modal('hide');
                    $('.modal-backdrop').remove(); // Ensure backdrop is removed
                    $('body').removeClass('modal-open').css('overflow', '');
                    if ($('#exampleModalToggle2').length > 0) {
                        $('#exampleModalToggle2').modal('show').on('hidden.bs.modal', function() {
                            $(this).off('hidden.bs.modal');
                            $('.modal-backdrop').remove();
                            $('body').removeClass('modal-open').css('overflow', '');
                            $.notify({ message: 'Xóa Điều Chỉnh thành công!' }, { type: 'success', delay: 3000 });
                            fetchAdjustments(currentPage);
                        });
                    } else {
                        $.notify({ message: 'Xóa Điều Chỉnh thành công!' }, { type: 'success', delay: 3000 });
                        fetchAdjustments(currentPage);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi xóa Điều Chỉnh:', status, error);
                    $.notify({ message: 'Lỗi khi xóa Điều Chỉnh: ' + (xhr.responseText || 'Vui lòng kiểm tra console.') }, { type: 'danger', delay: 3000 });
                    $('#exampleModalToggle').modal('hide');
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css('overflow', '');
                }
            });
        });

        // Initial fetch with URL update
        const urlParams = new URLSearchParams(window.location.search);
        const initialPage = parseInt(urlParams.get('page')) || 1;
        if (initialPage > 0) currentPage = initialPage - 1; // Convert 1-based URL to 0-based
        fetchAdjustments(currentPage);
    });
</script>

</body>
</html>