<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<body>
<!-- tap on top start-->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end-->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body Start-->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="BackEnd/fragments/WareHouse/sidebar::sidebar"></div>
        <!-- Page Sidebar Ends-->

        <!-- Container-fluid starts-->
        <div class="page-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-table">
                            <div class="card-body">
                                <div class="title-header option-title d-sm-flex d-block">
                                    <h5>Adjustment List</h5>
                                    <div class="right-options">
                                        <ul>
                                            <li>
                                                <a class="btn btn-solid" th:href="@{/warehouse/addadjustment}">Add Adjustment</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div>
                                    <div class="table-responsive">
                                        <table class="table all-package theme-table table-product" id="table_id">
                                            <thead>
                                            <tr>
                                                <th>Adjustment ID</th>
                                                <th>Batch ID</th>
                                                <th>Quantity</th>
                                                <th>Adjust Date</th>
                                                <th>Reason</th>
                                                <th>Type</th>
                                                <th>Action</th>
                                            </tr>
                                            </thead>
                                            <tbody id="adjustmentTableBody">
                                            <!-- Dữ liệu sẽ được thêm động bởi JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Container-fluid Ends-->

            <div class="container-fluid">
                <!-- footer start-->
                <footer class="footer">
                    <div class="row">
                        <div class="col-md-12 footer-copyright text-center">
                            <p class="mb-0">Copyright 2022 © Fastkart theme by pixelstrap</p>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>
</div>
<!-- page-wrapper End-->

<!-- Modal Start -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="modal-title" id="staticBackdropLabel">Logging Out</h5>
                <p>Are you sure you want to log out?</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="button-box">
                    <button type="button" class="btn btn--no" data-bs-dismiss="modal">No</button>
                    <button type="button" th:onclick="|window.location='@{backend/login}'|" class="btn btn--yes btn-primary">Yes</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal End -->

<!-- Edit Adjustment Modal -->
<div class="modal fade" id="editAdjustmentModal" tabindex="-1" aria-labelledby="editAdjustmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAdjustmentModalLabel">Edit Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAdjustmentForm">
                    <input type="hidden" id="editAdjustmentId">
                    <div class="mb-3">
                        <label for="editBatchId" class="form-label">Batch (Optional)</label>
                        <select class="form-select" id="editBatchId">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editQuantity" class="form-label">Adjustment Quantity</label>
                        <input type="number" class="form-control" id="editQuantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="editReason" class="form-label">Reason</label>
                        <textarea class="form-control" id="editReason" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAdjustmentType" class="form-label">Adjustment Type</label>
                        <select class="form-select" id="editAdjustmentType" required>
                            <option value="Add">Add</option>
                            <option value="Remove">Remove</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEditAdjustment">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal Box Start -->
<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header d-block text-center">
                <h5 class="modal-title w-100" id="exampleModalLabel22">Are You Sure?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box">
                    <p>Bạn có chắc chắn muốn xóa Adjustment này?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-animation btn-md fw-bold confirm-delete">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center" id="exampleModalLabel12">Done!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="remove-box text-center">
                    <div class="wrapper">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h4 class="text-content">It's Removed.</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Delete Modal Box End -->

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>

<!-- Bootstrap js -->
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>

<!-- feather icon js -->
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>

<!-- scrollbar simplebar js -->
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>

<!-- Sidebar js -->
<script th:src="@{/Backend/assets/js/config.js}"></script>

<!-- customizer js -->
<script th:src="@{/Backend/assets/js/customizer.js}"></script>

<!-- Plugins js -->
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>

<!-- Data table js -->
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>

<!-- sidebar effect -->
<script th:src="@{/Backend/assets/js/sidebareffect.js}"></script>

<!-- Theme js -->
<script th:src="@{/Backend/assets/js/script.js}"></script>

<!-- Custom JS for API call -->
<script>
    $(document).ready(function() {
        // Populate Batch dropdown
        function populateBatchDropdown(selectElement, selectedId) {
            $.ajax({
                url: '/api/product-batches',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    selectElement.empty();
                    selectElement.append('<option value="">None</option>');
                    if (!data || data.length === 0) {
                        return;
                    }
                    $.each(data, function(index, batch) {
                        var id = batch.batchID || batch.id;
                        if (id) {
                            var selected = id == selectedId ? 'selected' : '';
                            selectElement.append(`<option value="${id}" ${selected}>Batch ID: ${id}</option>`);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching Batches: ', status, error);
                    alert('Unable to load Batch list. Check console.');
                }
            });
        }

        // Load Adjustments
        function loadAdjustments() {
            $.ajax({
                url: '/api/adjustments',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    var tbody = $('#adjustmentTableBody');
                    tbody.empty();
                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan="7">No data</td></tr>');
                        return;
                    }

                    $.ajax({
                        url: '/api/product-batches',
                        method: 'GET',
                        dataType: 'json',
                        success: function(batches) {
                            var batchMap = {};
                            $.each(batches, function(index, batch) {
                                batchMap[batch.batchId || batch.id] = batch.batchId || 'No ID';
                            });

                            $.each(data, function(index, adjustment) {
                                var batchId = adjustment.batch || adjustment.batchId;
                                var mappedBatchId = batchMap[batchId] || batchId || 'N/A';

                                var row = '<tr>' +
                                    '<td>' + (adjustment.id || 'N/A') + '</td>' +
                                    '<td>' + mappedBatchId + '</td>' +
                                    '<td>' + (adjustment.quantity || 'N/A') + '</td>' +
                                    '<td>' + (adjustment.adjustDate || 'N/A') + '</td>' +
                                    '<td>' + (adjustment.reason || 'N/A') + '</td>' +
                                    '<td>' + (adjustment.adjustmentType || 'N/A') + '</td>' +
                                    '<td>' +
                                    '<ul class="action-list">' +
                                    '<li><a href="javascript:void(0)" class="edit-adjustment" data-adjustment-id="' + (adjustment.id || '') + '" data-batch-id="' + (batchId || '') + '" data-quantity="' + (adjustment.quantity || '') + '" data-reason="' + (adjustment.reason || '') + '" data-adjustment-type="' + (adjustment.adjustmentType || '') + '"><i class="ri-pencil-line"></i></a></li>' +
                                    '<li><a href="javascript:void(0)" class="delete-adjustment" data-adjustment-id="' + (adjustment.id || '') + '"><i class="ri-delete-bin-line"></i></a></li>' +
                                    '</ul>' +
                                    '</td>' +
                                    '</tr>';
                                tbody.append(row);
                            });

                            $('.edit-adjustment').on('click', function() {
                                var adjustmentId = $(this).data('adjustment-id');
                                var batchId = $(this).data('batch-id');
                                var quantity = $(this).data('quantity');
                                var reason = $(this).data('reason');
                                var adjustmentType = $(this).data('adjustment-type');

                                if (!adjustmentId) {
                                    alert('Adjustment ID không hợp lệ.');
                                    return;
                                }

                                $('#editAdjustmentId').val(adjustmentId);
                                $('#editQuantity').val(quantity);
                                $('#editReason').val(reason);
                                $('#editAdjustmentType').val(adjustmentType);
                                populateBatchDropdown($('#editBatchId'), batchId);

                                $('#editAdjustmentModal').modal('show');
                            });

                            $('.delete-adjustment').on('click', function(e) {
                                e.preventDefault();
                                var adjustmentId = $(this).data('adjustment-id');
                                if (!adjustmentId) {
                                    alert('Adjustment ID không hợp lệ.');
                                    return;
                                }
                                $('.confirm-delete').data('adjustment-id', adjustmentId);
                                $('#exampleModalToggle').modal('show');
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching Batches: ', status, error);
                            alert('Unable to load Batch list. Check console.');
                            $.each(data, function(index, adjustment) {
                                var batchId = adjustment.batch || adjustment.batchId;
                                var row = '<tr>' +
                                    '<td>' + (adjustment.id || 'N/A') + '</td>' +
                                    '<td>' + (batchId || 'N/A') + '</td>' +
                                    '<td>' + (adjustment.quantity || 'N/A') + '</td>' +
                                    '<td>' + (adjustment.adjustDate || 'N/A') + '</td>' +
                                    '<td>' + (adjustment.reason || 'N/A') + '</td>' +
                                    '<td>' + (adjustment.adjustmentType || 'N/A') + '</td>' +
                                    '<td>' +
                                    '<ul class="action-list">' +
                                    '<li><a href="javascript:void(0)" class="edit-adjustment" data-adjustment-id="' + (adjustment.id || '') + '" data-batch-id="' + (batchId || '') + '" data-quantity="' + (adjustment.quantity || '') + '" data-reason="' + (adjustment.reason || '') + '" data-adjustment-type="' + (adjustment.adjustmentType || '') + '"><i class="ri-pencil-line"></i></a></li>' +
                                    '<li><a href="javascript:void(0)" class="delete-adjustment" data-adjustment-id="' + (adjustment.id || '') + '"><i class="ri-delete-bin-line"></i></a></li>' +
                                    '</ul>' +
                                    '</td>' +
                                    '</tr>';
                                tbody.append(row);
                            });
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi gọi API /api/adjustments: ', status, error);
                    alert('Lỗi khi tải dữ liệu: ' + error + '. Kiểm tra console.');
                }
            });
        }

        // Save Edited Adjustment
        $(document).on('click', '#saveEditAdjustment', function() {
            var adjustmentId = $('#editAdjustmentId').val();
            var batchId = $('#editBatchId').val() || null;
            var quantity = $('#editQuantity').val();
            var reason = $('#editReason').val();
            var adjustmentType = $('#editAdjustmentType').val();

            if (!quantity || isNaN(parseInt(quantity))) {
                alert('Vui lòng nhập số lượng hợp lệ.');
                return;
            }
            if (!adjustmentType) {
                alert('Vui lòng chọn loại Adjustment.');
                return;
            }

            var formData = {
                batchId: batchId ? parseInt(batchId) : null,
                quantity: parseInt(quantity),
                reason: reason || null,
                adjustmentType: adjustmentType
            };

            $.ajax({
                url: '/api/adjustments/' + adjustmentId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                dataType: 'json',
                success: function(response) {
                    alert('Cập nhật Adjustment thành công!');
                    $('#editAdjustmentModal').modal('hide');
                    loadAdjustments();
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi sửa Adjustment: ', status, error);
                    alert('Lỗi khi sửa Adjustment: ' + (xhr.responseText || 'Kiểm tra console.'));
                }
            });
        });

        // Confirm Delete Adjustment
        $(document).on('click', '.confirm-delete', function(e) {
            e.preventDefault();
            var adjustmentId = $(this).data('adjustment-id');
            if (!adjustmentId) {
                alert('Adjustment ID không hợp lệ.');
                return;
            }

            $.ajax({
                url: '/api/adjustments/' + adjustmentId,
                method: 'DELETE',
                headers: { 'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') },
                success: function() {
                    $('#exampleModalToggle').modal('hide');
                    if ($('#exampleModalToggle2').length > 0) {
                        $('#exampleModalToggle2').modal('show');
                    } else {
                        alert('Xóa Adjustment thành công!');
                    }
                    loadAdjustments();
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi xóa Adjustment: ', status, error);
                    alert('Lỗi khi xóa Adjustment: ' + (xhr.responseText || 'Kiểm tra console.'));
                    $('#exampleModalToggle').modal('hide');
                }
            });
        });

        // Load Adjustments initially
        loadAdjustments();
    });
</script>

</body>
</html>