<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{BackEnd/fragments/WareHouse/head::head}"></head>

<style>
    /* Ensure table is scrollable horizontally if content overflows */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 0; /* Remove extra margin to keep pagination close */
        position: relative; /* Context for scrollbar */
    }

    /* Ensure table takes full width but triggers scrollbar if needed */
    #table_id {
        width: 100%;
        min-width: 1000px; /* Force horizontal scrollbar for wide content */
        table-layout: fixed; /* Ensure consistent column widths */
    }

    /* Override gray borders from Bootstrap for table */
    #table_id.table,
    #table_id th,
    #table_id td {
        border-color: #e6f3f2 !important; /* Light green border */
    }

    /* Consistent text alignment and padding for table cells */
    #table_id th,
    #table_id td {
        text-align: left; /* Default left alignment for all cells */
        vertical-align: middle; /* Center vertically */
        padding: 8px 12px; /* Consistent padding */
        overflow: hidden;
        text-overflow: ellipsis; /* Truncate long text with ellipsis */
    }

    /* Specific styles for STT column */
    #table_id th:nth-child(1),
    #table_id td:nth-child(1) {
        text-align: center; /* Center STT numbers */
        width: 25%; /* Requested width */
    }

    /* Specific styles for Logo column */
    #table_id th:nth-child(2),
    #table_id td:nth-child(2) {
        width: 15%; /* Requested width */
        text-align: center; /* Center logo */
    }

    /* Specific styles for Tên Nhà Cung Cấp column */
    #table_id th:nth-child(3),
    #table_id td:nth-child(3) {
        width: 15%; /* Requested width */
    }

    /* Specific styles for Thông Tin Liên Hệ column */
    #table_id th:nth-child(4),
    #table_id td:nth-child(4) {
        width: 20%; /* Requested width */
        white-space: normal; /* Allow wrapping for contact info */
        word-break: break-word; /* Break long words/emails */
    }

    /* Specific styles for Hành Động column */
    #table_id th:nth-child(5),
    #table_id td:nth-child(5) {
        width: 25%; /* Requested width */
        text-align: center; /* Center action icons */
    }

    /* Ensure images in Logo column are constrained */
    #table_id .table-image img {
        max-width: 50px;
        max-height: 50px;
        object-fit: contain;
    }

    /* Style for sortable column headers */
    th.sortable {
        cursor: pointer;
        position: relative;
        padding-right: 20px; /* Space for sort icon */
    }

    th.sortable::after {
        content: '';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        border: 4px solid transparent;
        border-top-color: #018F84; /* Default arrow color */
        opacity: 0.5;
    }

    th.sortable.asc::after {
        border-top-color: transparent;
        border-bottom-color: #018F84; /* Up arrow for ascending */
        opacity: 1;
    }

    th.sortable.desc::after {
        border-bottom-color: transparent;
        border-top-color: #018F84; /* Down arrow for descending */
        opacity: 1;
    }

    th.sortable:hover::after {
        opacity: 1; /* Highlight arrow on hover */
    }

    /* Center pagination and style items */
    #pagination-controls {
        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center;
        margin-top: 12px; /* Ensure below scrollbar */
        margin-bottom: 20px; /* Space below pagination */
        position: relative; /* Ensure proper stacking */
        z-index: 10; /* Below footer and sidebar */
        max-width: 100%; /* Prevent overflow */
    }

    #pagination-controls .page-item {
        margin: 0 2.5px; /* 5px gap between items */
    }

    #pagination-controls .page-link {
        border-radius: 4px;
        padding: 6px 12px;
        color: #018F84; /* Text color for number pages */
        font-size: 14px; /* Match theme typography */
        cursor: pointer; /* Ensure clickable appearance */
        border: 1px solid #018F84; /* Border matches theme */
        background-color: transparent; /* Default background */
        text-align: center;
        box-sizing: border-box;
    }

    /* Style for Previous and Next buttons */
    #pagination-controls .page-item:first-child .page-link,
    #pagination-controls .page-item:last-child .page-link {
        background-color: #018F84; /* Green background */
        color: #fff; /* White text */
        border-color: #018F84;
    }

    /* Style for active page */
    #pagination-controls .page-item.active .page-link {
        background-color: #018F84; /* Green background */
        border-color: #018F84;
        color: #fff;
        box-shadow: none; /* No glowing effect */
    }

    /* Style for disabled buttons */
    #pagination-controls .page-item.disabled .page-link {
        color: #018F84; /* Green text */
        border-color: #e6f3f2; /* Light green border */
        background-color: #e6f3f2; /* Light green background */
        pointer-events: none;
        cursor: default;
    }

    /* Hover effect for non-disabled, non-active number pages */
    #pagination-controls .page-link:hover:not(.disabled .page-link):not(.active .page-link):not(:first-child .page-link):not(:last-child .page-link) {
        background-color: #e6f3f2; /* Light green on hover */
        color: #018F84;
    }

    /* Hover effect for Previous/Next when not disabled */
    #pagination-controls .page-item:not(.disabled):first-child .page-link:hover,
    #pagination-controls .page-item:not(.disabled):last-child .page-link:hover {
        background-color: #016f6a; /* Darker green on hover */
        color: #fff;
    }

    /* Ensure footer is above pagination but below sidebar */
    .footer {
        z-index: 20 !important; /* Above pagination */
    }

    /* Ensure sidebar is above footer and pagination */
    .sidebar-wrapper {
        position: fixed;
        z-index: 30 !important; /* Above footer and pagination */
    }

    /* Ensure modals and offcanvas are above sidebar, footer, and pagination */
    .modal,
    .offcanvas {
        z-index: 1050 !important; /* Above sidebar, footer, and pagination */
    }

    .modal-backdrop {
        z-index: 1040 !important; /* Below modal/offcanvas, above sidebar and footer */
    }

    /* Style for search bar and button */
    .btn-theme {
        background-color: #018F84;
        color: #fff;
        border-color: #018F84;
    }

    .btn-theme:hover {
        background-color: #016f6a;
        color: #fff;
        border-color: #016f6a;
    }

    .search-bar input {
        border: 1px solid #e6f3f2;
    }

    .search-bar input:focus {
        border-color: #018F84;
        box-shadow: 0 0 5px rgba(1, 143, 132, 0.3);
    }
</style>

<body>
<!-- tap on top start -->
<div class="tap-top">
    <span class="lnr lnr-chevron-up"></span>
</div>
<!-- tap on tap end -->

<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Page Header Start-->
    <div th:replace="~{BackEnd/fragments/WareHouse/header::header}"></div>
    <!-- Page Header Ends-->

    <!-- Page Body Start -->
    <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        <div th:replace="~{BackEnd/fragments/WareHouse/sidebar::sidebar}"></div>
        <!-- Page Sidebar Ends-->

        <!-- Container-fluid starts-->
        <div class="page-body">
            <!-- All User Table Start -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-table">
                            <div class="card-body">
                                <div class="title-header option-title">
                                    <!-- Dòng 1: chỉ Danh Sách Nhà Cung Cấp -->
                                    <div class="first-line">
                                        <h5>Danh Sách Nhà Cung Cấp</h5>
                                    </div>

                                    <!-- Dòng 2: Thêm Mới và Tìm Kiếm bên phải -->
                                    <div class="second-line" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                                        <a th:href="@{/warehouse/addsupplier}" class="align-items-center btn btn-theme d-flex">
                                            <i data-feather="plus"></i> Thêm Mới
                                        </a>
                                        <div class="search-bar">
                                            <input type="text" class="form-control" placeholder="Tìm kiếm..." id="searchInput">
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive table-product">
                                    <table class="table all-package theme-table" id="table_id">
                                        <thead>
                                        <tr>
                                            <th class="sortable" data-sort="stt">STT</th>
                                            <th>Logo</th>
                                            <th class="sortable" data-sort="name">Tên Nhà Cung Cấp</th>
                                            <th>Thông Tin Liên Hệ</th>
                                            <th>Hành Động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="supplier-table-body">
                                        <!-- Dữ liệu sẽ được thêm động bởi JavaScript -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination Controls -->
                                <ul id="pagination-controls" class="pagination"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- All User Table Ends-->

            <div th:replace="BackEnd/fragments/WareHouse/footer::footer"></div>
        </div>
        <!-- Container-fluid end -->
    </div>
    <!-- Page Body End -->

    <!-- Modal Đăng Xuất -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="modal-title" id="staticBackdropLabel">Đăng Xuất</h5>
                    <p>Bạn có chắc chắn muốn đăng xuất?</p>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    <div class="button-box">
                        <button type="button" class="btn btn--no" data-bs-dismiss="modal">Không</button>
                        <button type="button" th:onclick="|window.location='@{/backend/login}'|" class="btn btn--yes btn-primary">Có</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal End -->

    <!-- Delete Modal Box Start -->
    <div class="modal fade theme-modal remove-coupon" id="exampleModalToggle" aria-hidden="true" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header d-block text-center">
                    <h5 class="modal-title w-100" id="exampleModalLabel22">Bạn Có Chắc Chắn?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="remove-box">
                        <p>Bạn có chắc chắn muốn xóa Nhà Cung Cấp này?</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">Không</button>
                    <button type="button" class="btn btn-animation btn-md fw-bold confirm-delete" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal" data-bs-dismiss="modal">Có</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade theme-modal remove-coupon" id="exampleModalToggle2" aria-hidden="true" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-center" id="exampleModalLabel12">Hoàn Thành!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="remove-box text-center">
                        <div class="wrapper">
                            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                            </svg>
                        </div>
                        <h4 class="text-content">Đã Xóa.</h4>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Delete Modal Box End -->

    <!-- Modal Cập Nhật Nhà Cung Cấp -->
    <div class="modal fade" id="updateSupplierModal" tabindex="-1" aria-labelledby="updateSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateSupplierModalLabel">Cập Nhật Nhà Cung Cấp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateSupplierForm">
                        <input type="hidden" id="supplierID">
                        <div class="mb-3">
                            <label for="supplierName" class="form-label">Tên Nhà Cung Cấp</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactInfo" class="form-label">Thông Tin Liên Hệ</label>
                            <input type="text" class="form-control" id="contactInfo" required>
                        </div>
                        <div class="mb-3">
                            <label for="logo" class="form-label">Logo</label>
                            <input type="file" class="form-control" id="logo" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveSupplierBtn">Lưu</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- page-wrapper End-->

<!-- latest js -->
<script th:src="@{/Backend/assets/js/jquery-3.6.0.min.js}"></script>

<!-- Bootstrap js -->
<script th:src="@{/Backend/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>

<!-- feather icon js -->
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/Backend/assets/js/icons/feather-icon/feather-icon.js}"></script>

<!-- scrollbar simplebar js -->
<script th:src="@{/Backend/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/Backend/assets/js/scrollbar/custom.js}"></script>

<!-- Sidebar js -->
<script th:src="@{/Backend/assets/js/config.js}"></script>

<!-- customizer js -->
<script th:src="@{/Backend/assets/js/customizer.js}"></script>

<!-- Plugins js -->
<script th:src="@{/Backend/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/Backend/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/Backend/assets/js/notify/index.js}"></script>

<!-- Data table js -->
<script th:src="@{/Backend/assets/js/jquery.dataTables.js}"></script>
<script th:src="@{/Backend/assets/js/custom-data-table.js}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentPage = 0; // 0-based internally
        const pageSize = 5;
        let searchTerm = ''; // Store current search term
        let allSuppliers = []; // Store all suppliers for frontend filtering
        let sortColumn = 'stt'; // Default sort column
        let sortDirection = 'asc'; // Default sort direction

        function ensureElements() {
            let tableBody = document.querySelector('#supplier-table-body');
            let noDataRow = document.querySelector('#no-data-row');

            if (!tableBody) {
                const table = document.querySelector('#table_id');
                if (table) {
                    tableBody = document.createElement('tbody');
                    tableBody.id = 'supplier-table-body';
                    table.appendChild(tableBody);
                } else {
                    console.error('Bảng #table_id không tìm thấy');
                    return null;
                }
            }

            if (!noDataRow) {
                noDataRow = document.createElement('tr');
                noDataRow.id = 'no-data-row';
                noDataRow.innerHTML = '<td colspan="5" class="text-center" style="background-color: #e6f3f2; color: #555;">Không tìm thấy bản ghi nào</td>';
                tableBody.appendChild(noDataRow);
            }

            return { tableBody, noDataRow };
        }

        function updateURL(page) {
            const params = new URLSearchParams();
            if (page > 0) params.set('page', page + 1); // 1-based for URL
            history.pushState({}, '', `?${params.toString()}`);
        }

        function fetchAllSuppliers() {
            const url = `/api/suppliers/paginated?page=0&size=1000`;
            console.log('Fetching all suppliers with URL:', url);

            fetch(url, {
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.content || typeof data.totalPages === 'undefined') {
                        console.error('Phản hồi API không hợp lệ:', data);
                        allSuppliers = [];
                        filterAndRenderSuppliers(searchTerm);
                        return;
                    }
                    allSuppliers = data.content;
                    filterAndRenderSuppliers(searchTerm);
                })
                .catch(error => {
                    console.error('Lỗi khi tải danh sách Nhà Cung Cấp:', error);
                    allSuppliers = [];
                    filterAndRenderSuppliers(searchTerm);
                    alert('Không thể tải danh sách nhà cung cấp. Vui lòng kiểm tra kết nối hoặc thử lại.');
                });
        }

        function sortSuppliers(suppliers, pageIndex) {
            return [...suppliers].sort((a, b) => {
                let valueA, valueB;
                if (sortColumn === 'stt') {
                    // STT sorting is based on array index, so no actual data comparison
                    // Ascending returns original order, descending reverses it
                    return sortDirection === 'asc' ? 0 : -1;
                } else if (sortColumn === 'name') {
                    valueA = a.supplierName.toLowerCase();
                    valueB = b.supplierName.toLowerCase();
                }
                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function updateSortIndicators() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.getAttribute('data-sort') === sortColumn) {
                    th.classList.add(sortDirection);
                }
            });
        }

        function filterAndRenderSuppliers(search = '') {
            searchTerm = search;
            updateURL(currentPage);
            const { tableBody, noDataRow } = ensureElements();
            if (!tableBody || !noDataRow) return;

            // Filter suppliers based on search term
            const filteredSuppliers = allSuppliers.filter(supplier =>
                supplier.supplierName.toLowerCase().includes(search.toLowerCase())
            );
            console.log('Filtered suppliers:', filteredSuppliers);

            // Sort suppliers
            const sortedSuppliers = sortSuppliers(filteredSuppliers, currentPage);

            // Paginate sorted suppliers
            const totalElements = sortedSuppliers.length;
            const totalPages = Math.ceil(totalElements / pageSize);

            // Adjust currentPage if it exceeds totalPages after sorting
            if (currentPage >= totalPages) {
                currentPage = totalPages > 0 ? totalPages - 1 : 0;
                updateURL(currentPage);
            }

            const startIndex = currentPage * pageSize;
            const paginatedSuppliers = sortedSuppliers.slice(startIndex, startIndex + pageSize);

            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable('#table_id')) {
                console.log('Destroying existing DataTable');
                $('#table_id').DataTable().clear().destroy();
            } else {
                console.log('No existing DataTable to destroy');
            }

            // Clear table body
            tableBody.innerHTML = '';
            if (paginatedSuppliers.length > 0) {
                noDataRow.style.display = 'none';
                paginatedSuppliers.forEach((supplier, index) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', supplier.supplierID);

                    // STT Cell
                    const sttCell = document.createElement('td');
                    sttCell.innerText = sortColumn === 'stt' && sortDirection === 'desc'
                        ? (totalElements - (currentPage * pageSize + index))
                        : (currentPage * pageSize + index + 1);
                    row.appendChild(sttCell);

                    // Logo Cell
                    const imageCell = document.createElement('td');
                    const imageDiv = document.createElement('div');
                    imageDiv.classList.add('table-image');
                    const img = document.createElement('img');
                    img.src = supplier.logo || 'default-logo.png';
                    img.classList.add('img-fluid');
                    img.alt = 'Logo Nhà Cung Cấp';
                    imageDiv.appendChild(img);
                    imageCell.appendChild(imageDiv);
                    row.appendChild(imageCell);

                    // Supplier Name Cell
                    const nameCell = document.createElement('td');
                    const nameDiv = document.createElement('div');
                    nameDiv.classList.add('user-name');
                    nameDiv.innerHTML = `<span>${supplier.supplierName || 'N/A'}</span>`;
                    nameCell.appendChild(nameDiv);
                    row.appendChild(nameCell);

                    // Contact Info Cell
                    const emailCell = document.createElement('td');
                    emailCell.innerText = supplier.contactInfo || 'Chưa có thông tin liên hệ';
                    row.appendChild(emailCell);

                    // Actions Cell
                    const actionsCell = document.createElement('td');
                    actionsCell.innerHTML = `
                        <ul>
                            <li><a href="order-detail.html"><i class="ri-eye-line"></i></a></li>
                            <li><a href="javascript:void(0)" class="edit-btn" data-id="${supplier.supplierID}" data-name="${supplier.supplierName || ''}" data-contact="${supplier.contactInfo || ''}" data-logo="${supplier.logo || ''}"><i class="ri-pencil-line"></i></a></li>
                            <li><a href="javascript:void(0)" class="delete-btn" data-id="${supplier.supplierID}" data-bs-toggle="modal" data-bs-target="#exampleModalToggle"><i class="ri-delete-bin-line"></i></a></li>
                        </ul>
                    `;
                    row.appendChild(actionsCell);

                    tableBody.appendChild(row);
                });
            } else {
                noDataRow.style.display = '';
            }

            // Initialize DataTable
            if (document.querySelector('#table_id')) {
                console.log('Initializing new DataTable');
                $('#table_id').DataTable({
                    searching: false,
                    paging: false,
                    ordering: false,
                    info: false,
                    language: {
                        emptyTable: "Không tìm thấy bản ghi nào"
                    },
                    columns: [
                        { width: '15%' }, // STT
                        { width: '20%' }, // Logo
                        { width: '25%' }, // Supplier Name
                        { width: '20%' }, // Contact Info
                        { width: '20%' }  // Actions
                    ],
                    autoWidth: false
                });
            } else {
                console.error('Không tìm thấy #table_id khi khởi tạo DataTable');
            }

            // Render pagination only if total elements >= 6
            console.log('Rendering page:', currentPage, 'Total elements:', totalElements, 'Total pages:', totalPages);
            if (totalElements >= 6) {
                renderPagination(totalPages, currentPage);
            } else {
                document.querySelector('#pagination-controls').innerHTML = '';
            }

            // Update sort indicators
            updateSortIndicators();
        }

        function renderPagination(totalPages, currentPage) {
            const paginationControls = document.querySelector('#pagination-controls');
            if (!paginationControls) return;

            paginationControls.innerHTML = '';
            totalPages = Math.max(1, totalPages);
            currentPage = Math.min(Math.max(0, currentPage), totalPages - 1);

            const addBtn = (label, page, disabled = false, active = false) => {
                const li = document.createElement('li');
                li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="javascript:void(0)" data-page="${page}">${label}</a>`;
                paginationControls.appendChild(li);
            };

            const addEllipsis = () => {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = `<a class="page-link">...</a>`;
                paginationControls.appendChild(li);
            };

            const added = new Set();

            // Trước
            addBtn('Trước', currentPage - 1, currentPage === 0);

            // Luôn luôn hiển thị trang 1
            addBtn(1, 0, false, currentPage === 0);
            added.add(0);

            // Form 1: Trang hiện tại <= 2 (trang 1,2,3)
            if (currentPage <= 2) {
                for (let i = 1; i <= 3 && i < totalPages - 2; i++) {
                    if (!added.has(i)) {
                        addBtn(i + 1, i, false, currentPage === i);
                        added.add(i);
                    }
                }
                if (totalPages > 6) addEllipsis();
            }

            // Form 2: 3 <= currentPage <= totalPages - 4 (giữa)
            else if (currentPage >= 3 && currentPage <= totalPages - 4) {
                const range = [currentPage - 1, currentPage, currentPage + 1];
                for (let i of range) {
                    if (!added.has(i)) {
                        addBtn(i + 1, i, false, currentPage === i);
                        added.add(i);
                    }
                }
                addEllipsis();
            }

            // Form 3: currentPage >= totalPages - 3 (cuối)
            else if (currentPage >= totalPages - 3) {
                if (!added.has(1)) {
                    addBtn(2, 1, false, currentPage === 1);
                    added.add(1);
                }
                if (totalPages > 6) addEllipsis();
                for (let i = totalPages - 4; i < totalPages - 1; i++) {
                    if (i > 1 && !added.has(i)) {
                        addBtn(i + 1, i, false, currentPage === i);
                        added.add(i);
                    }
                }
            }

            // Luôn hiện trang cuối cùng
            if (totalPages > 1) {
                if (!added.has(totalPages - 2) && totalPages - 2 > 0) {
                    addBtn(totalPages - 1, totalPages - 2, false, currentPage === totalPages - 2);
                }
                if (!added.has(totalPages - 1)) {
                    addBtn(totalPages, totalPages - 1, false, currentPage === totalPages - 1);
                }
            }

            // Sau
            addBtn('Sau', currentPage + 1, currentPage === totalPages - 1);
        }

        // Handle pagination and sorting clicks with event delegation
        document.addEventListener('click', function (e) {
            const pageLink = e.target.closest('.page-link');
            const sortHeader = e.target.closest('th.sortable');

            if (pageLink) {
                e.preventDefault();
                const page = parseInt(pageLink.getAttribute('data-page'));
                const totalPages = Math.ceil(
                    allSuppliers.filter(supplier =>
                        supplier.supplierName.toLowerCase().includes(searchTerm.toLowerCase())
                    ).length / pageSize
                );

                console.log('Clicked page:', page, 'Total pages:', totalPages, 'Search term:', searchTerm, 'Current page before update:', currentPage);

                if (!isNaN(page) && page >= 0 && page < totalPages) {
                    currentPage = page;
                    filterAndRenderSuppliers(searchTerm);
                } else {
                    console.warn('Invalid page click:', page);
                }
            }

            if (sortHeader) {
                const column = sortHeader.getAttribute('data-sort');
                if (column === sortColumn) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                console.log('Sorting by:', sortColumn, sortDirection);
                // Do not reset currentPage to 0; adjust it only if it exceeds totalPages
                filterAndRenderSuppliers(searchTerm);
            }
        });

        // Real-time search
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const searchValue = this.value.trim();
                console.log('Search input:', searchValue, 'Resetting to page 0');
                currentPage = 0; // Reset to first page on search
                filterAndRenderSuppliers(searchValue);
            });
        } else {
            console.error('Ô tìm kiếm #searchInput không tìm thấy');
        }

        // Handle edit and delete buttons
        document.addEventListener('click', function (event) {
            const deleteBtn = event.target.closest('.delete-btn');
            const editBtn = event.target.closest('.edit-btn');

            if (deleteBtn) {
                const supplierID = deleteBtn.getAttribute('data-id');
                const modal = document.getElementById('exampleModalToggle');
                if (modal) modal.setAttribute('data-supplier-id', supplierID);
            }

            if (editBtn) {
                const supplierID = editBtn.getAttribute('data-id');
                const supplierName = editBtn.getAttribute('data-name');
                const contactInfo = editBtn.getAttribute('data-contact');
                const logo = editBtn.getAttribute('data-logo');

                const supplierIdInput = document.getElementById('supplierID');
                const supplierNameInput = document.getElementById('supplierName');
                const contactInfoInput = document.getElementById('contactInfo');
                const logoInput = document.getElementById('logo');

                if (supplierIdInput && supplierNameInput && contactInfoInput && logoInput) {
                    supplierIdInput.value = supplierID;
                    supplierNameInput.value = supplierName;
                    contactInfoInput.value = contactInfo || '';
                    logoInput.value = '';
                } else {
                    alert('Không thể mở cửa sổ cập nhật.');
                }

                try {
                    new bootstrap.Modal(document.getElementById('updateSupplierModal')).show();
                } catch (error) {
                    alert('Không thể mở cửa sổ cập nhật.');
                }
            }
        });

        const confirmDeleteBtn = document.querySelector('#exampleModalToggle .confirm-delete');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function () {
                const modal = document.getElementById('exampleModalToggle');
                const supplierID = modal.getAttribute('data-supplier-id');

                if (!supplierID) {
                    alert('ID Nhà Cung Cấp không hợp lệ.');
                    return;
                }

                fetch('/api/suppliers/' + supplierID, {
                    method: 'DELETE',
                    headers: { 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content }
                })
                    .then(response => {
                        if (response.ok) {
                            allSuppliers = allSuppliers.filter(s => s.supplierID !== supplierID);
                            const doneModal = new bootstrap.Modal(document.getElementById('exampleModalToggle2'));
                            doneModal.show();
                            doneModal._element.addEventListener('hidden.bs.modal', function () {
                                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                                document.body.classList.remove('modal-open');
                                document.body.style.overflow = '';
                                if (!allSuppliers.length) {
                                    document.getElementById('no-data-row').style.display = '';
                                }
                                filterAndRenderSuppliers(searchTerm);
                            });
                        } else {
                            alert('Không thể xóa Nhà Cung Cấp.');
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi khi xóa Nhà Cung Cấp:', error);
                        alert('Lỗi khi xóa Nhà Cung Cấp.');
                    });
            });
        }

        function updateSupplier(supplierID, supplierName, contactInfo, logoFile) {
            const normalizedName = supplierName.trim().replace(/\s+/g, ' ');
            const normalizedContact = contactInfo.trim();

            if (!normalizedName || !normalizedName.match(/^[a-zA-Z\s\u00C0-\u00FF\u0110\u0111\u1EA0-\u1EFF]+$/)) {
                $.notify({ message: 'Tên nhà cung cấp chỉ được chứa chữ cái (tiếng Việt) và khoảng trắng.' }, { type: 'warning', delay: 3000 });
                return;
            }

            if (!normalizedContact) {
                $.notify({ message: 'Thông tin liên hệ là bắt buộc.' }, { type: 'warning' , delay: 3000});
                return;
            }

            const formData = new FormData();
            formData.append('supplierName', normalizedName);
            formData.append('contactInfo', normalizedContact);
            if (logoFile) formData.append('logo', logoFile);

            fetch('/api/suppliers/' + supplierID, {
                method: 'PUT',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
                },
                body: formData
            })
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw err; });
                    return response.json();
                })
                .then(updatedSupplier => {
                    const updatedId = parseInt(updatedSupplier.supplierID);
                    const index = allSuppliers.findIndex(s => parseInt(s.supplierID) === updatedId);
                    if (index !== -1) {
                        allSuppliers[index] = updatedSupplier;
                    } else {
                        allSuppliers.push(updatedSupplier);
                    }

                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('updateSupplierModal'));
                    if (modalInstance) modalInstance.hide();

                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';

                    document.getElementById('logo').value = '';
                    $.notify({ message: 'Cập nhật Nhà Cung Cấp thành công!' }, { type: 'success' , delay: 3000});
                    filterAndRenderSuppliers(searchTerm);
                })
                .catch(error => {
                    console.error('Lỗi khi cập nhật Nhà Cung Cấp:', error);
                    const errorMessage = error?.error || error?.message || 'Lỗi khi cập nhật Nhà Cung Cấp.';
                    $.notify({ message: errorMessage }, { type: 'danger', delay: 3000 });
                });
        }


        const saveSupplierBtn = document.getElementById('saveSupplierBtn');
        if (saveSupplierBtn) {
            saveSupplierBtn.addEventListener('click', () => {
                const supplierID = document.getElementById('supplierID').value;
                const supplierName = document.getElementById('supplierName').value;
                const contactInfo = document.getElementById('contactInfo').value;
                const logoFile = document.getElementById('logo').files[0];
                updateSupplier(supplierID, supplierName, contactInfo, logoFile);
            });
        }

        // Initial fetch with URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialPage = parseInt(urlParams.get('page')) || 1;
        currentPage = initialPage > 0 ? initialPage - 1 : 0;
        fetchAllSuppliers();
    });
</script>

</body>
</html>